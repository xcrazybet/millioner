<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millioner Slots - Win Big!</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --slot-bg: #0f3460;
            --slot-frame: #e94560;
            --win-glow: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--primary);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Game Container */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--slot-frame);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2.2rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .player-info {
            text-align: right;
        }

        .balance-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 5px;
        }

        .player-name {
            color: #aaa;
            font-size: 1.1rem;
        }

        /* Game Area */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Slot Machine */
        .slot-machine {
            background: var(--slot-bg);
            border-radius: 20px;
            padding: 30px;
            border: 4px solid var(--slot-frame);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .slot-machine::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.2;
            z-index: 0;
        }

        .reels-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 30px 0;
            position: relative;
            z-index: 1;
        }

        .reel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 10px;
            border: 3px solid var(--primary);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            height: 400px;
            position: relative;
        }

        .reel-strip {
            display: flex;
            flex-direction: column;
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .symbol {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            margin: 5px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            user-select: none;
        }

        .symbol.winning {
            animation: winPulse 0.5s infinite alternate;
            box-shadow: 0 0 20px var(--win-glow);
        }

        @keyframes winPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .win-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, var(--win-glow), transparent);
            height: 4px;
            width: 100%;
            z-index: 2;
            opacity: 0;
        }

        /* Paylines Display */
        .paylines-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .payline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payline.active {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .payline-dots {
            display: flex;
            gap: 5px;
        }

        .payline-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            border: 2px solid var(--slot-frame);
        }

        .bet-controls, .action-controls, .info-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bet-amount {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .bet-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bet-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .bet-display {
            flex: 1;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
        }

        .spin-btn {
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            border: none;
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spin-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(114, 9, 183, 0.4);
        }

        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .spin-btn.spinning {
            animation: spinBtn 0.5s infinite alternate;
        }

        @keyframes spinBtn {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .auto-spin-btn {
            background: var(--warning);
        }

        .max-bet-btn {
            background: var(--danger);
        }

        .win-display {
            background: rgba(76, 201, 240, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .win-amount {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--win-glow);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Paytable Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--slot-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--slot-frame);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .paytable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .paytable-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .paytable-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Footer */
        .game-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-home {
            background: var(--primary);
        }

        .btn-home:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
        }

        .btn-help {
            background: var(--secondary);
        }

        .btn-help:hover {
            background: #5a08a0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .player-info {
                text-align: center;
            }
            
            .reels-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }
            
            .reel {
                height: 300px;
            }
            
            .symbol {
                height: 90px;
                font-size: 2.5rem;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .balance-display {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .reels-container {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .reel {
                height: 250px;
            }
            
            .symbol {
                height: 75px;
                font-size: 2rem;
            }
            
            .spin-btn {
                font-size: 1.2rem;
                padding: 15px;
            }
        }

        /* Animations */
        .win-animation {
            animation: winCelebration 2s ease-out;
        }

        @keyframes winCelebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .jackpot-animation {
            animation: jackpot 1s infinite alternate;
        }

        @keyframes jackpot {
            0% { color: #ffd700; text-shadow: 0 0 10px #ffd700; }
            100% { color: #ff6b6b; text-shadow: 0 0 20px #ff6b6b; }
        }

        /* Sound Controls */
        .sound-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .sound-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .sound-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2>Loading Slots Game...</h2>
        <p>Preparing your gaming experience</p>
    </div>

    <!-- Player Name Modal -->
    <div class="modal" id="playerNameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to Millioner Slots!</h2>
            </div>
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-user-circle" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
                <h3 style="margin-bottom: 20px;">Enter Your Name</h3>
                <input type="text" id="playerNameInput" placeholder="Your name" 
                       style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 2px solid var(--primary); background: rgba(255,255,255,0.1); color: white; margin-bottom: 20px;">
                <button class="btn btn-home" onclick="startGame()" style="width: 100%; font-size: 1.2rem;">
                    <i class="fas fa-play"></i> Start Playing
                </button>
            </div>
        </div>
    </div>

    <!-- Paytable Modal -->
    <div class="modal" id="paytableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-coins"></i> Paytable & Rules</h2>
                <button class="close-modal" onclick="closeModal('paytableModal')">&times;</button>
            </div>
            <div class="paytable-grid">
                <div class="paytable-item">
                    <div style="font-size: 3rem;">üíé</div>
                    <h3>5 Diamonds</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">500x</p>
                </div>
                <div class="paytable-item">
                    <div style="font-size: 3rem;">7Ô∏è‚É£</div>
                    <h3>5 Sevens</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">200x</p>
                </div>
                <div class="paytable-item">
                    <div style="font-size: 3rem;">üíµ</div>
                    <h3>5 Money Bags</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">100x</p>
                </div>
                <div class="paytable-item">
                    <div style="font-size: 3rem;">üîî</div>
                    <h3>5 Bells</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">50x</p>
                </div>
                <div class="paytable-item">
                    <div style="font-size: 3rem;">üçí</div>
                    <h3>5 Cherries</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">25x</p>
                </div>
                <div class="paytable-item">
                    <div style="font-size: 3rem;">‚≠ê</div>
                    <h3>5 Stars</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">10x</p>
                </div>
            </div>
            <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <h3><i class="fas fa-info-circle"></i> Game Rules</h3>
                <ul style="margin-top: 15px; padding-left: 20px;">
                    <li>Minimum bet: $1</li>
                    <li>Maximum bet: $100</li>
                    <li>Game RTP: 96.5%</li>
                    <li>Win rate: ~10% (90% lose rate)</li>
                    <li>5 reels, 3 rows, 20 paylines</li>
                    <li>Wins pay from left to right</li>
                    <li>Max win per spin: $10,000</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Header -->
        <div class="game-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <h1>MILLIONER SLOTS</h1>
            </div>
            <div class="player-info">
                <div class="balance-display" id="balanceDisplay">$0</div>
                <div class="player-name" id="playerNameDisplay">Player</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <!-- Slot Machine -->
            <div class="slot-machine">
                <!-- Win Lines -->
                <div class="win-line" id="winLine1" style="top: 33%;"></div>
                <div class="win-line" id="winLine2" style="top: 50%;"></div>
                <div class="win-line" id="winLine3" style="top: 66%;"></div>
                
                <!-- Reels -->
                <div class="reels-container" id="reelsContainer">
                    <!-- Reels will be generated by JavaScript -->
                </div>

                <!-- Paylines -->
                <div class="paylines-info">
                    <div class="payline active" onclick="togglePayline(1)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 1 (x1)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(2)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 2 (x2)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(3)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 3 (x3)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(4)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 4 (x5)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(5)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 5 (x10)</span>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Bet Controls -->
                <div class="bet-controls">
                    <h3><i class="fas fa-money-bill-wave"></i> Bet Amount</h3>
                    <div class="bet-amount">
                        <button class="bet-btn" onclick="changeBet(-1)">-</button>
                        <div class="bet-display" id="betAmount">$1</div>
                        <button class="bet-btn" onclick="changeBet(1)">+</button>
                    </div>
                    <button class="btn max-bet-btn" onclick="setMaxBet()">
                        <i class="fas fa-rocket"></i> MAX BET
                    </button>
                </div>

                <!-- Action Controls -->
                <div class="action-controls">
                    <button class="spin-btn" id="spinBtn" onclick="spin()">
                        <i class="fas fa-play"></i> SPIN
                    </button>
                    <button class="btn auto-spin-btn" onclick="toggleAutoSpin()">
                        <i class="fas fa-sync"></i> AUTO SPIN
                    </button>
                </div>

                <!-- Info Panel -->
                <div class="info-panel">
                    <div class="win-display">
                        <div style="font-size: 0.9rem; color: #aaa;">LAST WIN</div>
                        <div class="win-amount" id="lastWinAmount">$0</div>
                    </div>
                    <button class="btn btn-help" onclick="openModal('paytableModal')">
                        <i class="fas fa-question-circle"></i> PAYTABLE
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="game-footer">
            <button class="btn btn-home" onclick="goHome()">
                <i class="fas fa-home"></i> Back to Home
            </button>
            <div style="color: #aaa; font-size: 0.9rem;">
                <i class="fas fa-shield-alt"></i> Certified Fair RNG
            </div>
        </div>
    </div>

    <!-- Sound Control -->
    <div class="sound-controls">
        <button class="sound-btn" onclick="toggleSound()">
            <i class="fas fa-volume-up" id="soundIcon"></i>
        </button>
    </div>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Howler.js for Sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>

    <script>
        // ====================
        // FIREBASE CONFIGURATION
        // ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.appspot.com",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ====================
        // GAME VARIABLES
        // ====================
        let playerName = "";
        let userId = "";
        let userBalance = 0;
        let currentBet = 1;
        let isSpinning = false;
        let autoSpin = false;
        let soundEnabled = true;
        let isAutoSpinning = false;
        let autoSpinCount = 0;
        let maxAutoSpins = 10;

        // Game Configuration
        const REELS_COUNT = 5;
        const ROWS_COUNT = 3;
        const SYMBOLS_COUNT = 20; // Total symbols in each reel strip
        const VISIBLE_SYMBOLS = 3; // Visible symbols per reel
        
        // Symbols configuration with weighted probabilities
        const SYMBOLS = [
            { icon: 'üçí', name: 'Cherry', weight: 30, value: [0,0,2,5,25] },
            { icon: 'üîî', name: 'Bell', weight: 25, value: [0,0,5,10,50] },
            { icon: '‚≠ê', name: 'Star', weight: 20, value: [0,2,10,25,100] },
            { icon: 'üíµ', name: 'Money', weight: 15, value: [0,5,25,50,200] },
            { icon: '7Ô∏è‚É£', name: 'Seven', weight: 8, value: [10,50,100,200,500] },
            { icon: 'üíé', name: 'Diamond', weight: 2, value: [50,100,200,500,1000] }
        ];

        // Total weight for probability calculation
        const TOTAL_WEIGHT = SYMBOLS.reduce((sum, sym) => sum + sym.weight, 0);

        // Paylines configuration [reel1_row, reel2_row, reel3_row, reel4_row, reel5_row]
        const PAYLINES = [
            [1, 1, 1, 1, 1], // Middle line
            [0, 0, 0, 0, 0], // Top line
            [2, 2, 2, 2, 2], // Bottom line
            [0, 1, 2, 1, 0], // V shape
            [2, 1, 0, 1, 2]  // Inverse V
        ];

        // Active paylines with multipliers
        let activePaylines = [
            { id: 1, active: true, multiplier: 1 },
            { id: 2, active: false, multiplier: 2 },
            { id: 3, active: false, multiplier: 3 },
            { id: 4, active: false, multiplier: 5 },
            { id: 5, active: false, multiplier: 10 }
        ];

        // Reel strips (generated based on symbol weights)
        let reelStrips = [];

        // Current reel positions
        let reelPositions = [];

        // Sound effects
        let sounds = {
            spin: null,
            win: null,
            reelStop: null,
            click: null
        };

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function showToast(type, message) {
            const colors = {
                success: "#4cc9f0",
                error: "#f72585",
                warning: "#f8961e",
                info: "#4361ee"
            };

            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: colors[type],
                stopOnFocus: true
            }).showToast();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function generateReelStrip() {
            const strip = [];
            for (let i = 0; i < SYMBOLS_COUNT; i++) {
                let rand = Math.random() * TOTAL_WEIGHT;
                let cumulativeWeight = 0;
                
                for (const symbol of SYMBOLS) {
                    cumulativeWeight += symbol.weight;
                    if (rand <= cumulativeWeight) {
                        strip.push(symbol);
                        break;
                    }
                }
            }
            return strip;
        }

        function initializeGame() {
            // Generate reel strips
            reelStrips = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                reelStrips.push(generateReelStrip());
            }
            
            // Initialize reel positions
            reelPositions = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                reelPositions.push(Math.floor(Math.random() * SYMBOLS_COUNT));
            }
            
            // Generate reels HTML
            const reelsContainer = document.getElementById('reelsContainer');
            reelsContainer.innerHTML = '';
            
            for (let i = 0; i < REELS_COUNT; i++) {
                const reelDiv = document.createElement('div');
                reelDiv.className = 'reel';
                reelDiv.id = `reel${i}`;
                
                const stripDiv = document.createElement('div');
                stripDiv.className = 'reel-strip';
                stripDiv.id = `reelStrip${i}`;
                
                // Create visible symbols plus some extra for smooth animation
                for (let j = -1; j < VISIBLE_SYMBOLS + 2; j++) {
                    const symbolDiv = document.createElement('div');
                    symbolDiv.className = 'symbol';
                    const pos = (reelPositions[i] + j + SYMBOLS_COUNT) % SYMBOLS_COUNT;
                    symbolDiv.textContent = reelStrips[i][pos].icon;
                    symbolDiv.dataset.symbol = reelStrips[i][pos].name;
                    stripDiv.appendChild(symbolDiv);
                }
                
                reelDiv.appendChild(stripDiv);
                reelsContainer.appendChild(reelDiv);
            }
            
            updateDisplay();
        }

        // ====================
        // SOUND FUNCTIONS
        // ====================
        function initSounds() {
            // Create sound objects
            sounds.spin = new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-spin-1092.mp3'],
                volume: 0.5
            });
            
            sounds.win = new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'],
                volume: 0.7
            });
            
            sounds.reelStop = new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3'],
                volume: 0.3
            });
            
            sounds.click = new Howl({
                src: ['https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'],
                volume: 0.2
            });
        }

        function playSound(soundName) {
            if (soundEnabled && sounds[soundName]) {
                sounds[soundName].play();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const icon = document.getElementById('soundIcon');
            icon.className = soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
            showToast('info', soundEnabled ? 'Sound enabled' : 'Sound muted');
        }

        // ====================
        // FIREBASE FUNCTIONS
        // ====================
        async function checkAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadUserData();
                        resolve(true);
                    } else {
                        // User not logged in, show name modal
                        showPlayerNameModal();
                        resolve(false);
                    }
                });
            });
        }

        async function loadUserData() {
            try {
                const userDoc = await db.collection('wallets').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 0;
                    playerName = userData.username || 'Player';
                    
                    // Update display
                    document.getElementById('balanceDisplay').textContent = formatCurrency(userBalance);
                    document.getElementById('playerNameDisplay').textContent = playerName;
                    
                    showToast('success', `Welcome back, ${playerName}!`);
                } else {
                    // Create wallet for new user
                    await createUserWallet();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('error', 'Failed to load user data');
            }
        }

        async function createUserWallet() {
            try {
                await db.collection('wallets').doc(userId).set({
                    balance: 100, // Starting balance
                    username: playerName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                userBalance = 100;
                updateDisplay();
                showToast('success', 'Welcome! You received $100 starting balance');
            } catch (error) {
                console.error('Error creating wallet:', error);
                showToast('error', 'Failed to create wallet');
            }
        }

        async function updateBalance(amount, type) {
            try {
                const newBalance = userBalance + amount;
                
                // Update local balance
                userBalance = newBalance;
                updateDisplay();
                
                // Update Firebase
                await db.collection('wallets').doc(userId).update({
                    balance: newBalance,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Record transaction
                await db.collection('transactions').add({
                    userId: userId,
                    type: type,
                    amount: Math.abs(amount),
                    previousBalance: userBalance - amount,
                    newBalance: userBalance,
                    description: type === 'bet' ? `Slot machine bet` : `Slot machine win`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    game: 'slots'
                });
                
                // Send to admin logs if it's a significant win
                if (amount > 100 && type === 'win') {
                    await db.collection('admin_logs').add({
                        adminId: 'system',
                        action: 'big_win',
                        playerId: userId,
                        playerName: playerName,
                        amount: amount,
                        game: 'slots',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Error updating balance:', error);
                return false;
            }
        }

        // ====================
        // GAME LOGIC
        // ====================
        function showPlayerNameModal() {
            openModal('playerNameModal');
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function startGame() {
            playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                playerName = 'Player';
            }
            
            // Sign in anonymously or create user
            auth.signInAnonymously()
                .then(() => {
                    closeModal('playerNameModal');
                    document.getElementById('gameContainer').style.display = 'block';
                    document.getElementById('playerNameDisplay').textContent = playerName;
                    
                    // Initialize sounds and game
                    initSounds();
                    initializeGame();
                    
                    showToast('success', `Welcome to Millioner Slots, ${playerName}!`);
                })
                .catch(error => {
                    console.error('Auth error:', error);
                    showToast('error', 'Failed to start game');
                });
        }

        function changeBet(amount) {
            playSound('click');
            
            const newBet = currentBet + amount;
            if (newBet >= 1 && newBet <= 100 && newBet <= userBalance) {
                currentBet = newBet;
                document.getElementById('betAmount').textContent = formatCurrency(currentBet);
            } else if (newBet > 100) {
                showToast('warning', 'Maximum bet is $100');
            } else if (newBet > userBalance) {
                showToast('error', 'Insufficient balance');
            }
        }

        function setMaxBet() {
            playSound('click');
            const maxBet = Math.min(100, userBalance);
            if (maxBet >= 1) {
                currentBet = maxBet;
                document.getElementById('betAmount').textContent = formatCurrency(currentBet);
                showToast('info', `Max bet set to ${formatCurrency(currentBet)}`);
            } else {
                showToast('error', 'Insufficient balance for minimum bet');
            }
        }

        function togglePayline(lineId) {
            const lineIndex = activePaylines.findIndex(line => line.id === lineId);
            if (lineIndex !== -1) {
                activePaylines[lineIndex].active = !activePaylines[lineIndex].active;
                
                // Update UI
                const lineElements = document.querySelectorAll('.payline');
                lineElements[lineId - 1].classList.toggle('active');
                
                playSound('click');
            }
        }

        function getActivePaylinesCount() {
            return activePaylines.filter(line => line.active).length;
        }

        async function spin() {
            if (isSpinning) return;
            
            const totalBet = currentBet * getActivePaylinesCount();
            
            // Check balance
            if (userBalance < totalBet) {
                showToast('error', 'Insufficient balance');
                return;
            }
            
            // Check if bet is valid
            if (totalBet <= 0) {
                showToast('error', 'Please activate at least one payline');
                return;
            }
            
            // Deduct bet
            const success = await updateBalance(-totalBet, 'bet');
            if (!success) {
                showToast('error', 'Failed to place bet');
                return;
            }
            
            isSpinning = true;
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.classList.add('spinning');
            spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SPINNING';
            
            playSound('spin');
            
            // Generate new random positions for reels
            const newPositions = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                // Apply 10% win rate: 90% of spins lose
                if (Math.random() > 0.1) { // 90% chance of losing spin
                    // Make sure it's not a winning combination
                    newPositions.push(Math.floor(Math.random() * SYMBOLS_COUNT));
                } else { // 10% chance of potential win
                    // Slightly bias toward better symbols
                    newPositions.push(Math.floor(Math.random() * (SYMBOLS_COUNT * 0.3)));
                }
            }
            
            // Animate reels
            const reelPromises = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                reelPromises.push(spinReel(i, newPositions[i]));
            }
            
            // Wait for all reels to stop
            Promise.all(reelPromises).then(() => {
                // Update positions
                reelPositions = newPositions;
                
                // Evaluate wins
                const winResult = evaluateWins();
                
                // Update win display
                if (winResult.totalWin > 0) {
                    document.getElementById('lastWinAmount').textContent = formatCurrency(winResult.totalWin);
                    document.getElementById('lastWinAmount').classList.add('win-animation');
                    
                    // Add winnings to balance
                    updateBalance(winResult.totalWin, 'win');
                    
                    // Play win sound and animation
                    playSound('win');
                    showWinAnimation(winResult.winningLines);
                    
                    showToast('success', `You won ${formatCurrency(winResult.totalWin)}!`);
                } else {
                    document.getElementById('lastWinAmount').textContent = '$0';
                    showToast('info', 'No win this time. Try again!');
                }
                
                // Reset spin button
                setTimeout(() => {
                    spinBtn.disabled = false;
                    spinBtn.classList.remove('spinning');
                    spinBtn.innerHTML = '<i class="fas fa-play"></i> SPIN';
                    isSpinning = false;
                    
                    document.getElementById('lastWinAmount').classList.remove('win-animation');
                    
                    // If auto-spin is enabled, spin again
                    if (isAutoSpinning && autoSpinCount < maxAutoSpins && userBalance >= currentBet) {
                        autoSpinCount++;
                        setTimeout(spin, 1000);
                    } else if (isAutoSpinning) {
                        toggleAutoSpin(); // Stop auto-spin
                        showToast('info', 'Auto-spin completed');
                    }
                }, 2000);
            });
        }

        function spinReel(reelIndex, newPosition) {
            return new Promise((resolve) => {
                const reelStrip = document.getElementById(`reelStrip${reelIndex}`);
                const currentPos = reelPositions[reelIndex];
                
                // Calculate distance to spin (add extra spins for effect)
                const distance = (newPosition - currentPos + SYMBOLS_COUNT * 3) % SYMBOLS_COUNT + SYMBOLS_COUNT;
                
                // Animate the spin
                reelStrip.style.transition = 'transform 0s';
                reelStrip.style.transform = `translateY(0px)`;
                
                setTimeout(() => {
                    reelStrip.style.transition = `transform ${2 + reelIndex * 0.3}s cubic-bezier(0.2, 0.8, 0.2, 1)`;
                    reelStrip.style.transform = `translateY(-${distance * 120}px)`;
                    
                    // Play reel stop sound
                    setTimeout(() => {
                        playSound('reelStop');
                    }, 2000 + reelIndex * 300);
                    
                    // Resolve when animation completes
                    setTimeout(() => {
                        // Update displayed symbols
                        const symbols = reelStrip.querySelectorAll('.symbol');
                        for (let i = 0; i < symbols.length; i++) {
                            const pos = (newPosition + i - 1 + SYMBOLS_COUNT) % SYMBOLS_COUNT;
                            symbols[i].textContent = reelStrips[reelIndex][pos].icon;
                            symbols[i].dataset.symbol = reelStrips[reelIndex][pos].name;
                        }
                        
                        // Reset position for next spin
                        reelStrip.style.transition = 'transform 0s';
                        reelStrip.style.transform = `translateY(-120px)`;
                        
                        resolve();
                    }, 2000 + reelIndex * 300);
                }, 50);
            });
        }

        function evaluateWins() {
            const result = {
                totalWin: 0,
                winningLines: []
            };
            
            // Get visible symbols matrix
            const visibleSymbols = [];
            for (let reel = 0; reel < REELS_COUNT; reel++) {
                const reelSymbols = [];
                for (let row = 0; row < ROWS_COUNT; row++) {
                    const pos = (reelPositions[reel] + row) % SYMBOLS_COUNT;
                    reelSymbols.push(reelStrips[reel][pos]);
                }
                visibleSymbols.push(reelSymbols);
            }
            
            // Check each active payline
            activePaylines.forEach((payline, lineIndex) => {
                if (!payline.active) return;
                
                const linePositions = PAYLINES[payline.id - 1];
                const lineSymbols = [];
                
                // Get symbols on this payline
                for (let reel = 0; reel < REELS_COUNT; reel++) {
                    const row = linePositions[reel];
                    lineSymbols.push(visibleSymbols[reel][row]);
                }
                
                // Check for consecutive matching symbols from left
                let consecutiveCount = 1;
                for (let i = 1; i < lineSymbols.length; i++) {
                    if (lineSymbols[i].name === lineSymbols[0].name) {
                        consecutiveCount++;
                    } else {
                        break;
                    }
                }
                
                // If we have at least 3 matching symbols, it's a win
                if (consecutiveCount >= 3) {
                    const symbol = lineSymbols[0];
                    const winMultiplier = symbol.value[consecutiveCount - 1]; // Get payout for number of symbols
                    const lineWin = currentBet * winMultiplier * payline.multiplier;
                    
                    result.totalWin += lineWin;
                    result.winningLines.push({
                        line: payline.id,
                        symbol: symbol.name,
                        count: consecutiveCount,
                        win: lineWin
                    });
                    
                    // Highlight winning symbols
                    for (let i = 0; i < consecutiveCount; i++) {
                        const reelDiv = document.getElementById(`reel${i}`);
                        const symbols = reelDiv.querySelectorAll('.symbol');
                        symbols[linePositions[i] + 1].classList.add('winning'); // +1 for buffer symbol
                    }
                }
            });
            
            return result;
        }

        function showWinAnimation(winningLines) {
            // Show win lines
            winningLines.forEach(win => {
                const winLine = document.getElementById(`winLine${win.line}`);
                winLine.style.opacity = '1';
                winLine.style.animation = 'none';
                setTimeout(() => {
                    winLine.style.animation = 'winPulse 0.5s infinite alternate';
                }, 10);
                
                setTimeout(() => {
                    winLine.style.opacity = '0';
                    winLine.style.animation = 'none';
                }, 2000);
            });
            
            // Remove winning highlights after animation
            setTimeout(() => {
                document.querySelectorAll('.symbol.winning').forEach(symbol => {
                    symbol.classList.remove('winning');
                });
            }, 2000);
        }

        function toggleAutoSpin() {
            if (isAutoSpinning) {
                // Stop auto-spin
                isAutoSpinning = false;
                autoSpinCount = 0;
                showToast('info', 'Auto-spin stopped');
            } else {
                // Start auto-spin
                if (userBalance < currentBet) {
                    showToast('error', 'Insufficient balance');
                    return;
                }
                
                if (getActivePaylinesCount() === 0) {
                    showToast('error', 'Please activate at least one payline');
                    return;
                }
                
                isAutoSpinning = true;
                autoSpinCount = 0;
                showToast('success', 'Auto-spin started');
                
                // Start spinning
                spin();
            }
        }

        function updateDisplay() {
            document.getElementById('balanceDisplay').textContent = formatCurrency(userBalance);
            document.getElementById('betAmount').textContent = formatCurrency(currentBet);
            
            // Update spin button state
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = isSpinning || userBalance < currentBet;
        }

        function goHome() {
            window.location.href = 'https://xcrazybet.github.io/millioner/';
        }

        // ====================
        // INITIALIZATION
        // ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            await checkAuth();
            
            // Set up event listeners
            document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
            
            // Initialize game when page loads
            setTimeout(() => {
                if (!userId) {
                    document.getElementById('loadingScreen').style.display = 'none';
                }
            }, 2000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !isSpinning) {
                e.preventDefault();
                spin();
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                changeBet(1);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                changeBet(-1);
            } else if (e.code === 'KeyM') {
                e.preventDefault();
                toggleSound();
            }
        });
    </script>
</body>
</html>
