<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millioner Slots - Win Big!</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --slot-bg: #0f3460;
            --slot-frame: #e94560;
            --win-glow: #ffd700;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--primary);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hide {
            display: none !important;
        }

        /* Game Container */
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--slot-frame);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2.2rem;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 800;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .player-info {
            text-align: right;
        }

        .balance-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 5px;
        }

        .player-name {
            color: #aaa;
            font-size: 1.1rem;
        }

        /* Game Area */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Slot Machine */
        .slot-machine {
            background: var(--slot-bg);
            border-radius: 20px;
            padding: 30px;
            border: 4px solid var(--slot-frame);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .reels-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 30px 0;
            position: relative;
            z-index: 1;
        }

        .reel {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 10px;
            border: 3px solid var(--primary);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            height: 400px;
            position: relative;
        }

        .reel-strip {
            display: flex;
            flex-direction: column;
            transition: transform 3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .symbol {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            margin: 5px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: all 0.3s;
            user-select: none;
        }

        .symbol.winning {
            animation: winPulse 0.5s infinite alternate;
            box-shadow: 0 0 20px var(--win-glow);
        }

        @keyframes winPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .win-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, var(--win-glow), transparent);
            height: 4px;
            width: 100%;
            z-index: 2;
            opacity: 0;
        }

        /* Paylines Display */
        .paylines-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .payline {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payline.active {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        .payline-dots {
            display: flex;
            gap: 5px;
        }

        .payline-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(15, 52, 96, 0.8);
            border-radius: 15px;
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            border: 2px solid var(--slot-frame);
        }

        .bet-controls, .action-controls, .info-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .bet-amount {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .bet-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bet-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .bet-display {
            flex: 1;
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
        }

        .spin-btn {
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            border: none;
            padding: 20px;
            border-radius: 12px;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spin-btn:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(114, 9, 183, 0.4);
        }

        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .spin-btn.spinning {
            animation: spinBtn 0.5s infinite alternate;
        }

        @keyframes spinBtn {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        .auto-spin-btn {
            background: var(--warning);
        }

        .max-bet-btn {
            background: var(--danger);
        }

        .win-display {
            background: rgba(76, 201, 240, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .win-amount {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--win-glow);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--slot-bg);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--slot-frame);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Footer */
        .game-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-home {
            background: var(--primary);
        }

        .btn-home:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
        }

        .btn-help {
            background: var(--secondary);
        }

        .btn-help:hover {
            background: #5a08a0;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .game-container {
                padding: 10px;
            }
            
            .game-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .player-info {
                text-align: center;
            }
            
            .reels-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }
            
            .reel {
                height: 300px;
            }
            
            .symbol {
                height: 90px;
                font-size: 2.5rem;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .balance-display {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .reels-container {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .reel {
                height: 250px;
            }
            
            .symbol {
                height: 75px;
                font-size: 2rem;
            }
            
            .spin-btn {
                font-size: 1.2rem;
                padding: 15px;
            }
        }

        /* Animations */
        .win-animation {
            animation: winCelebration 2s ease-out;
        }

        @keyframes winCelebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Debug Button */
        .debug-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <h2>Loading Slots Game...</h2>
        <p>Preparing your gaming experience</p>
        <button id="skipAuthBtn" style="margin-top: 20px; padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
            Skip Authentication (Debug)
        </button>
    </div>

    <!-- Player Name Modal -->
    <div class="modal" id="playerNameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to Millioner Slots!</h2>
                <button class="close-modal" onclick="closeModal('playerNameModal')">&times;</button>
            </div>
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-user-circle" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
                <h3 style="margin-bottom: 20px;">Enter Your Player Name</h3>
                <input type="text" id="playerNameInput" placeholder="Enter your name" 
                       style="width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 2px solid var(--primary); background: rgba(255,255,255,0.1); color: white; margin-bottom: 20px;">
                <button class="btn btn-home" onclick="startGame()" style="width: 100%; font-size: 1.2rem;">
                    <i class="fas fa-play"></i> Start Playing
                </button>
                <p style="margin-top: 15px; color: #aaa; font-size: 0.9rem;">
                    You will receive $100 starting balance
                </p>
            </div>
        </div>
    </div>

    <!-- Paytable Modal -->
    <div class="modal" id="paytableModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-coins"></i> Paytable & Rules</h2>
                <button class="close-modal" onclick="closeModal('paytableModal')">&times;</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">üíé</div>
                    <h3>5 Diamonds</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">500x</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">7Ô∏è‚É£</div>
                    <h3>5 Sevens</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">200x</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">üíµ</div>
                    <h3>5 Money Bags</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">100x</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">üîî</div>
                    <h3>5 Bells</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">50x</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">üçí</div>
                    <h3>5 Cherries</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">25x</p>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 3rem;">‚≠ê</div>
                    <h3>5 Stars</h3>
                    <p style="color: var(--win-glow); font-size: 1.5rem; font-weight: bold;">10x</p>
                </div>
            </div>
            <div style="padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <h3><i class="fas fa-info-circle"></i> Game Rules</h3>
                <ul style="margin-top: 15px; padding-left: 20px; line-height: 1.8;">
                    <li>Minimum bet: <strong>$1</strong></li>
                    <li>Maximum bet: <strong>$100</strong></li>
                    <li>Game RTP: <strong>96.5%</strong></li>
                    <li>Win rate: <strong>~10%</strong> (90% lose rate)</li>
                    <li>5 reels, 3 rows, 20 paylines</li>
                    <li>Wins pay from left to right</li>
                    <li>Max win per spin: <strong>$10,000</strong></li>
                    <li>Starting balance: <strong>$100</strong></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container hide" id="gameContainer">
        <!-- Header -->
        <div class="game-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <h1>MILLIONER SLOTS</h1>
            </div>
            <div class="player-info">
                <div class="balance-display" id="balanceDisplay">$100.00</div>
                <div class="player-name" id="playerNameDisplay">Player</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <!-- Slot Machine -->
            <div class="slot-machine">
                <!-- Win Lines -->
                <div class="win-line" id="winLine1" style="top: 33%;"></div>
                <div class="win-line" id="winLine2" style="top: 50%;"></div>
                <div class="win-line" id="winLine3" style="top: 66%;"></div>
                
                <!-- Reels -->
                <div class="reels-container" id="reelsContainer">
                    <!-- Reels will be generated by JavaScript -->
                </div>

                <!-- Paylines -->
                <div class="paylines-info">
                    <div class="payline active" onclick="togglePayline(1)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 1 (x1)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(2)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 2 (x2)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(3)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 3 (x3)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(4)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 4 (x5)</span>
                    </div>
                    <div class="payline" onclick="togglePayline(5)">
                        <div class="payline-dots">
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                            <div class="payline-dot"></div>
                        </div>
                        <span>Line 5 (x10)</span>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Bet Controls -->
                <div class="bet-controls">
                    <h3><i class="fas fa-money-bill-wave"></i> Bet Amount</h3>
                    <div class="bet-amount">
                        <button class="bet-btn" onclick="changeBet(-1)">-</button>
                        <div class="bet-display" id="betAmount">$1.00</div>
                        <button class="bet-btn" onclick="changeBet(1)">+</button>
                    </div>
                    <button class="btn max-bet-btn" onclick="setMaxBet()">
                        <i class="fas fa-rocket"></i> MAX BET
                    </button>
                </div>

                <!-- Action Controls -->
                <div class="action-controls">
                    <button class="spin-btn" id="spinBtn" onclick="spin()">
                        <i class="fas fa-play"></i> SPIN
                    </button>
                    <button class="btn auto-spin-btn" onclick="toggleAutoSpin()">
                        <i class="fas fa-sync"></i> AUTO SPIN
                    </button>
                </div>

                <!-- Info Panel -->
                <div class="info-panel">
                    <div class="win-display">
                        <div style="font-size: 0.9rem; color: #aaa;">LAST WIN</div>
                        <div class="win-amount" id="lastWinAmount">$0.00</div>
                    </div>
                    <button class="btn btn-help" onclick="openModal('paytableModal')">
                        <i class="fas fa-question-circle"></i> PAYTABLE
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="game-footer">
            <a href="index.html" class="btn btn-home">
                <i class="fas fa-home"></i> Back to Home
            </a>
            <div style="color: #aaa; font-size: 0.9rem;">
                <i class="fas fa-shield-alt"></i> Certified Fair RNG
            </div>
        </div>
    </div>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // ====================
        // FIREBASE CONFIGURATION
        // ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.appspot.com",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // ====================
        // GAME VARIABLES
        // ====================
        let playerName = "Player";
        let userId = null;
        let userBalance = 100;
        let currentBet = 1;
        let isSpinning = false;
        let isAutoSpinning = false;
        let autoSpinCount = 0;
        let maxAutoSpins = 10;

        // Game Configuration
        const REELS_COUNT = 5;
        const ROWS_COUNT = 3;
        const SYMBOLS_COUNT = 20;
        
        // Symbols with weights and payouts
        const SYMBOLS = [
            { icon: 'üçí', name: 'Cherry', weight: 30, value: [0,0,2,5,25] },
            { icon: 'üîî', name: 'Bell', weight: 25, value: [0,0,5,10,50] },
            { icon: '‚≠ê', name: 'Star', weight: 20, value: [0,2,10,25,100] },
            { icon: 'üíµ', name: 'Money', weight: 15, value: [0,5,25,50,200] },
            { icon: '7Ô∏è‚É£', name: 'Seven', weight: 8, value: [10,50,100,200,500] },
            { icon: 'üíé', name: 'Diamond', weight: 2, value: [50,100,200,500,1000] }
        ];

        const TOTAL_WEIGHT = SYMBOLS.reduce((sum, sym) => sum + sym.weight, 0);

        // Active paylines
        let activePaylines = [
            { id: 1, active: true, multiplier: 1 },
            { id: 2, active: false, multiplier: 2 },
            { id: 3, active: false, multiplier: 3 },
            { id: 4, active: false, multiplier: 5 },
            { id: 5, active: false, multiplier: 10 }
        ];

        let reelStrips = [];
        let reelPositions = [];

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function showToast(type, message) {
            const colors = {
                success: "#4cc9f0",
                error: "#f72585",
                warning: "#f8961e",
                info: "#4361ee"
            };

            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: colors[type],
                stopOnFocus: true
            }).showToast();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function hideLoading() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.classList.add('hide');
            }, 500);
        }

        function showGame() {
            document.getElementById('gameContainer').classList.remove('hide');
        }

        // ====================
        // GAME INITIALIZATION
        // ====================
        function initGame() {
            console.log("Initializing game...");
            
            // Generate reel strips
            generateReelStrips();
            
            // Initialize reel positions
            reelPositions = Array(REELS_COUNT).fill(0).map(() => Math.floor(Math.random() * SYMBOLS_COUNT));
            
            // Create reels in DOM
            createReels();
            
            // Update display
            updateDisplay();
            
            console.log("Game initialized successfully");
        }

        function generateReelStrips() {
            reelStrips = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                const strip = [];
                for (let j = 0; j < SYMBOLS_COUNT; j++) {
                    let rand = Math.random() * TOTAL_WEIGHT;
                    let cumulativeWeight = 0;
                    
                    for (const symbol of SYMBOLS) {
                        cumulativeWeight += symbol.weight;
                        if (rand <= cumulativeWeight) {
                            strip.push(symbol);
                            break;
                        }
                    }
                }
                reelStrips.push(strip);
            }
        }

        function createReels() {
            const reelsContainer = document.getElementById('reelsContainer');
            reelsContainer.innerHTML = '';
            
            for (let i = 0; i < REELS_COUNT; i++) {
                const reelDiv = document.createElement('div');
                reelDiv.className = 'reel';
                reelDiv.id = `reel${i}`;
                
                const stripDiv = document.createElement('div');
                stripDiv.className = 'reel-strip';
                stripDiv.id = `reelStrip${i}`;
                
                // Add buffer symbols before and after for smooth animation
                for (let j = -1; j < ROWS_COUNT + 2; j++) {
                    const symbolDiv = document.createElement('div');
                    symbolDiv.className = 'symbol';
                    const pos = (reelPositions[i] + j + SYMBOLS_COUNT) % SYMBOLS_COUNT;
                    symbolDiv.textContent = reelStrips[i][pos].icon;
                    symbolDiv.dataset.symbol = reelStrips[i][pos].name;
                    stripDiv.appendChild(symbolDiv);
                }
                
                reelDiv.appendChild(stripDiv);
                reelsContainer.appendChild(reelDiv);
            }
        }

        // ====================
        // AUTHENTICATION
        // ====================
        async function checkAuth() {
            console.log("Checking authentication...");
            
            try {
                // Try to sign in anonymously first
                const userCredential = await auth.signInAnonymously();
                userId = userCredential.user.uid;
                console.log("Signed in anonymously with ID:", userId);
                
                // Load or create user data
                await loadUserData();
                
                // Show player name modal
                setTimeout(() => {
                    hideLoading();
                    openModal('playerNameModal');
                }, 1000);
                
            } catch (error) {
                console.error("Authentication error:", error);
                // If Firebase fails, start game offline
                startGameOffline();
            }
        }

        async function loadUserData() {
            try {
                if (!userId) return;
                
                const userDoc = await db.collection('wallets').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 100;
                    playerName = userData.username || "Player";
                    console.log("Loaded user data:", { userBalance, playerName });
                } else {
                    // Create new wallet
                    await createUserWallet();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                // Use default values if Firebase fails
                userBalance = 100;
                playerName = "Player";
            }
        }

        async function createUserWallet() {
            try {
                await db.collection('wallets').doc(userId).set({
                    balance: 100,
                    username: playerName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                console.log("Created user wallet");
            } catch (error) {
                console.error("Error creating wallet:", error);
            }
        }

        // ====================
        // GAME FUNCTIONS
        // ====================
        function startGame() {
            const nameInput = document.getElementById('playerNameInput').value.trim();
            if (nameInput) {
                playerName = nameInput;
            }
            
            // Update player name display
            document.getElementById('playerNameDisplay').textContent = playerName;
            
            // Close modal and show game
            closeModal('playerNameModal');
            showGame();
            
            // Initialize game
            initGame();
            
            // Save player name to Firebase if authenticated
            if (userId) {
                db.collection('wallets').doc(userId).update({
                    username: playerName
                }).catch(console.error);
            }
            
            showToast('success', `Welcome, ${playerName}! You have ${formatCurrency(userBalance)} to play with.`);
        }

        function startGameOffline() {
            console.log("Starting game offline mode");
            hideLoading();
            
            // Set default values
            userBalance = 100;
            playerName = "Player";
            
            // Show player name modal
            openModal('playerNameModal');
        }

        function changeBet(amount) {
            const newBet = currentBet + amount;
            
            if (newBet < 1) {
                showToast('error', 'Minimum bet is $1');
                return;
            }
            
            if (newBet > 100) {
                showToast('error', 'Maximum bet is $100');
                return;
            }
            
            if (newBet > userBalance) {
                showToast('error', 'Insufficient balance');
                return;
            }
            
            currentBet = newBet;
            document.getElementById('betAmount').textContent = formatCurrency(currentBet);
        }

        function setMaxBet() {
            const maxBet = Math.min(100, userBalance);
            if (maxBet >= 1) {
                currentBet = maxBet;
                document.getElementById('betAmount').textContent = formatCurrency(currentBet);
                showToast('info', `Max bet set to ${formatCurrency(currentBet)}`);
            } else {
                showToast('error', 'Insufficient balance for minimum bet');
            }
        }

        function togglePayline(lineId) {
            const lineIndex = activePaylines.findIndex(line => line.id === lineId);
            if (lineIndex !== -1) {
                activePaylines[lineIndex].active = !activePaylines[lineIndex].active;
                
                const lineElement = document.querySelectorAll('.payline')[lineId - 1];
                lineElement.classList.toggle('active');
            }
        }

        function getActivePaylinesCount() {
            return activePaylines.filter(line => line.active).length;
        }

        function updateDisplay() {
            document.getElementById('balanceDisplay').textContent = formatCurrency(userBalance);
            document.getElementById('betAmount').textContent = formatCurrency(currentBet);
            
            const spinBtn = document.getElementById('spinBtn');
            const totalBet = currentBet * getActivePaylinesCount();
            spinBtn.disabled = isSpinning || userBalance < totalBet || totalBet === 0;
        }

        async function spin() {
            if (isSpinning) return;
            
            const activeLines = getActivePaylinesCount();
            const totalBet = currentBet * activeLines;
            
            // Validations
            if (totalBet > userBalance) {
                showToast('error', 'Insufficient balance');
                return;
            }
            
            if (totalBet <= 0) {
                showToast('error', 'Please activate at least one payline');
                return;
            }
            
            // Start spinning
            isSpinning = true;
            userBalance -= totalBet;
            updateDisplay();
            
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.classList.add('spinning');
            spinBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SPINNING';
            
            // Generate new positions with 10% win rate
            const newPositions = [];
            for (let i = 0; i < REELS_COUNT; i++) {
                if (Math.random() > 0.1) { // 90% lose
                    newPositions.push(Math.floor(Math.random() * SYMBOLS_COUNT));
                } else { // 10% win
                    newPositions.push(Math.floor(Math.random() * (SYMBOLS_COUNT * 0.3)));
                }
            }
            
            // Animate reels
            await animateReels(newPositions);
            
            // Update positions
            reelPositions = newPositions;
            
            // Evaluate wins
            const winResult = evaluateWins();
            
            // Process win
            if (winResult.totalWin > 0) {
                userBalance += winResult.totalWin;
                document.getElementById('lastWinAmount').textContent = formatCurrency(winResult.totalWin);
                document.getElementById('lastWinAmount').classList.add('win-animation');
                showWinAnimation(winResult.winningLines);
                showToast('success', `You won ${formatCurrency(winResult.totalWin)}!`);
                
                // Record transaction if online
                if (userId) {
                    recordTransaction(totalBet, winResult.totalWin);
                }
            } else {
                document.getElementById('lastWinAmount').textContent = '$0.00';
                showToast('info', 'No win this time. Try again!');
            }
            
            // Reset spin button
            setTimeout(() => {
                spinBtn.disabled = false;
                spinBtn.classList.remove('spinning');
                spinBtn.innerHTML = '<i class="fas fa-play"></i> SPIN';
                isSpinning = false;
                updateDisplay();
                
                document.getElementById('lastWinAmount').classList.remove('win-animation');
                
                // Auto-spin logic
                if (isAutoSpinning && autoSpinCount < maxAutoSpins && userBalance >= currentBet) {
                    autoSpinCount++;
                    setTimeout(spin, 1000);
                } else if (isAutoSpinning) {
                    toggleAutoSpin();
                    showToast('info', 'Auto-spin completed');
                }
            }, 2000);
        }

        function animateReels(newPositions) {
            const promises = [];
            
            for (let i = 0; i < REELS_COUNT; i++) {
                promises.push(new Promise(resolve => {
                    const reelStrip = document.getElementById(`reelStrip${i}`);
                    const currentPos = reelPositions[i];
                    const distance = (newPositions[i] - currentPos + SYMBOLS_COUNT * 3) % SYMBOLS_COUNT + SYMBOLS_COUNT;
                    
                    // Reset transition
                    reelStrip.style.transition = 'transform 0s';
                    reelStrip.style.transform = 'translateY(0px)';
                    
                    setTimeout(() => {
                        reelStrip.style.transition = `transform ${2 + i * 0.3}s cubic-bezier(0.2, 0.8, 0.2, 1)`;
                        reelStrip.style.transform = `translateY(-${distance * 120}px)`;
                        
                        setTimeout(() => {
                            // Update symbols
                            const symbols = reelStrip.querySelectorAll('.symbol');
                            for (let j = 0; j < symbols.length; j++) {
                                const pos = (newPositions[i] + j - 1 + SYMBOLS_COUNT) % SYMBOLS_COUNT;
                                symbols[j].textContent = reelStrips[i][pos].icon;
                                symbols[j].dataset.symbol = reelStrips[i][pos].name;
                            }
                            
                            // Reset for next spin
                            reelStrip.style.transition = 'transform 0s';
                            reelStrip.style.transform = 'translateY(-120px)';
                            
                            resolve();
                        }, 2000 + i * 300);
                    }, 50);
                }));
            }
            
            return Promise.all(promises);
        }

        function evaluateWins() {
            const result = {
                totalWin: 0,
                winningLines: []
            };
            
            // Get visible symbols
            const visibleSymbols = [];
            for (let reel = 0; reel < REELS_COUNT; reel++) {
                const reelSymbols = [];
                for (let row = 0; row < ROWS_COUNT; row++) {
                    const pos = (reelPositions[reel] + row) % SYMBOLS_COUNT;
                    reelSymbols.push(reelStrips[reel][pos]);
                }
                visibleSymbols.push(reelSymbols);
            }
            
            // Check each active payline
            activePaylines.forEach((payline, lineIndex) => {
                if (!payline.active) return;
                
                // Simple payline patterns
                const patterns = [
                    [1, 1, 1, 1, 1], // Middle
                    [0, 0, 0, 0, 0], // Top
                    [2, 2, 2, 2, 2], // Bottom
                    [0, 1, 2, 1, 0], // V
                    [2, 1, 0, 1, 2]  // Inverse V
                ];
                
                const pattern = patterns[payline.id - 1];
                const lineSymbols = pattern.map((row, reel) => visibleSymbols[reel][row]);
                
                // Check for consecutive matches
                let consecutiveCount = 1;
                for (let i = 1; i < lineSymbols.length; i++) {
                    if (lineSymbols[i].name === lineSymbols[0].name) {
                        consecutiveCount++;
                    } else {
                        break;
                    }
                }
                
                // Award win for 3+ matching symbols
                if (consecutiveCount >= 3) {
                    const symbol = lineSymbols[0];
                    const winMultiplier = symbol.value[consecutiveCount - 1];
                    const lineWin = currentBet * winMultiplier * payline.multiplier;
                    
                    result.totalWin += lineWin;
                    result.winningLines.push({
                        line: payline.id,
                        symbol: symbol.name,
                        count: consecutiveCount,
                        win: lineWin
                    });
                    
                    // Highlight winning symbols
                    for (let i = 0; i < consecutiveCount; i++) {
                        const reelDiv = document.getElementById(`reel${i}`);
                        const symbols = reelDiv.querySelectorAll('.symbol');
                        symbols[pattern[i] + 1].classList.add('winning');
                    }
                }
            });
            
            return result;
        }

        function showWinAnimation(winningLines) {
            winningLines.forEach(win => {
                const winLine = document.getElementById(`winLine${win.line}`);
                winLine.style.opacity = '1';
                winLine.style.animation = 'none';
                setTimeout(() => {
                    winLine.style.animation = 'winPulse 0.5s infinite alternate';
                }, 10);
                
                setTimeout(() => {
                    winLine.style.opacity = '0';
                }, 2000);
            });
            
            setTimeout(() => {
                document.querySelectorAll('.symbol.winning').forEach(symbol => {
                    symbol.classList.remove('winning');
                });
            }, 2000);
        }

        function toggleAutoSpin() {
            if (isAutoSpinning) {
                isAutoSpinning = false;
                autoSpinCount = 0;
                showToast('info', 'Auto-spin stopped');
            } else {
                if (userBalance < currentBet) {
                    showToast('error', 'Insufficient balance');
                    return;
                }
                
                if (getActivePaylinesCount() === 0) {
                    showToast('error', 'Please activate at least one payline');
                    return;
                }
                
                isAutoSpinning = true;
                autoSpinCount = 0;
                showToast('success', 'Auto-spin started (10 spins max)');
                
                // Start spinning
                spin();
            }
        }

        async function recordTransaction(betAmount, winAmount) {
            try {
                await db.collection('transactions').add({
                    userId: userId,
                    type: winAmount > 0 ? 'win' : 'loss',
                    betAmount: betAmount,
                    winAmount: winAmount,
                    netAmount: winAmount - betAmount,
                    game: 'slots',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    playerName: playerName
                });
                
                // Update balance in Firebase
                await db.collection('wallets').doc(userId).update({
                    balance: userBalance
                });
            } catch (error) {
                console.error("Error recording transaction:", error);
            }
        }

        // ====================
        // EVENT LISTENERS
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, starting game...");
            
            // Skip auth button for debugging
            document.getElementById('skipAuthBtn').addEventListener('click', function() {
                console.log("Skipping authentication...");
                startGameOffline();
            });
            
            // Player name input enter key
            document.getElementById('playerNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
            
            // Start authentication
            setTimeout(() => {
                checkAuth();
            }, 1000);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && !isSpinning) {
                    e.preventDefault();
                    spin();
                } else if (e.code === 'ArrowUp') {
                    e.preventDefault();
                    changeBet(1);
                } else if (e.code === 'ArrowDown') {
                    e.preventDefault();
                    changeBet(-1);
                }
            });
        });
    </script>
</body>
</html>
