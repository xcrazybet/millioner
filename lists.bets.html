<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>XCrazyBet - All Bets Listing</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- Fonts & Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #7c3aed;
        --accent: #10b981;
        --accent-dark: #059669;
        --danger: #ef4444;
        --warning: #f59e0b;
        --success: #10b981;
        --info: #3b82f6;
        --dark-bg: #0f172a;
        --medium-bg: #1e293b;
        --light-bg: #334155;
        --text: #f8fafc;
        --text-secondary: #cbd5e1;
        --card-bg: rgba(30, 41, 59, 0.9);
        --border-color: #475569;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    html {
        font-size: 14px;
    }

    body {
        font-family: 'Montserrat', sans-serif;
        background: linear-gradient(135deg, var(--dark-bg), var(--medium-bg));
        color: var(--text);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 60px;
    }

    /* Header */
    .header {
        background: rgba(15, 23, 42, 0.98);
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid var(--primary);
        position: sticky;
        top: 0;
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .logo {
        font-size: 18px;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .logo i {
        font-size: 20px;
        color: var(--accent);
    }

    .nav-links {
        display: flex;
        gap: 10px;
    }

    .nav-btn {
        padding: 8px 15px;
        background: var(--medium-bg);
        border-radius: 8px;
        color: var(--text);
        text-decoration: none;
        font-weight: 500;
        font-size: 13px;
        transition: all 0.3s;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .nav-btn i {
        font-size: 14px;
    }

    .nav-btn:hover {
        background: var(--primary);
        transform: translateY(-2px);
        border-color: var(--text);
    }

    .nav-btn.active {
        background: var(--primary);
        border-color: var(--text);
    }

    /* Main Container */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Page Header */
    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 25px;
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1));
        border-radius: 16px;
        border: 2px solid var(--primary);
    }

    .page-header h1 {
        color: white;
        font-size: 28px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .page-header p {
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1.6;
        max-width: 700px;
        margin: 0 auto;
    }

    .page-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .page-stat {
        text-align: center;
        padding: 15px 25px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        min-width: 150px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Filters Section */
    .filters-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
    }

    .filter-controls {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filter-label {
        display: block;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 600;
    }

    .filter-select {
        width: 100%;
        padding: 12px;
        background: var(--light-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(79, 70, 229, 0.1);
    }

    /* Search Box */
    .search-box {
        position: relative;
        flex: 2;
        min-width: 300px;
    }

    .search-input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        background: var(--light-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    .search-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 16px;
    }

    /* Active Filters */
    .active-filters {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .filter-tag {
        background: rgba(79, 70, 229, 0.2);
        color: var(--primary);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-tag .remove {
        cursor: pointer;
        font-size: 14px;
        opacity: 0.7;
    }

    .filter-tag .remove:hover {
        opacity: 1;
    }

    /* Bets Table */
    .bets-table-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
        overflow-x: auto;
    }

    .bets-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .bets-table th {
        background: var(--medium-bg);
        padding: 15px;
        text-align: left;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border-color);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .bets-table td {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }

    .bets-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    /* Bet Number */
    .bet-number {
        width: 60px;
        text-align: center;
        font-weight: 700;
        color: var(--text-secondary);
        font-size: 14px;
    }

    /* Bet Details */
    .bet-match {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 5px;
    }

    .bet-league {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* User Info */
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
    }

    .user-details {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-weight: 600;
        font-size: 13px;
    }

    .user-time {
        font-size: 11px;
        color: var(--text-secondary);
    }

    /* Bet Type */
    .bet-type {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        display: inline-block;
    }

    .bet-type.home {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .bet-type.away {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .bet-type.draw {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }

    /* Odds & Amount */
    .bet-odds {
        font-weight: 700;
        color: var(--accent);
        font-size: 16px;
    }

    .bet-amount {
        font-weight: 700;
        color: white;
        font-size: 16px;
    }

    /* Potential Win */
    .potential-win {
        font-weight: 700;
        color: var(--success);
        font-size: 16px;
    }

    /* Status Badge */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        display: inline-block;
        min-width: 80px;
    }

    .status-pending {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .status-won {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    .status-lost {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .status-void {
        background: rgba(148, 163, 184, 0.2);
        color: #94a3b8;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        background: var(--light-bg);
        border: none;
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .action-btn:hover {
        background: var(--primary);
        transform: translateY(-2px);
    }

    .action-btn.view {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }

    .action-btn.save {
        background: rgba(124, 58, 237, 0.2);
        color: #7c3aed;
    }

    .action-btn.share {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
    }

    /* Live Indicator */
    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }

    /* Records Section */
    .records-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 25px;
        margin-top: 30px;
        border: 1px solid var(--border-color);
    }

    .records-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .records-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .record-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s;
    }

    .record-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary);
    }

    .record-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .record-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text);
    }

    .record-date {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .record-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
    }

    .record-stat {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
    }

    .record-stat-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 3px;
    }

    .record-stat-label {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-top: 30px;
        padding: 20px;
    }

    .page-btn {
        padding: 10px 18px;
        background: var(--light-bg);
        border: none;
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .page-btn:hover:not(:disabled) {
        background: var(--primary);
        transform: translateY(-2px);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .page-numbers {
        display: flex;
        gap: 8px;
    }

    .page-number {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--light-bg);
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .page-number:hover {
        background: var(--primary);
    }

    .page-number.active {
        background: var(--primary);
        color: white;
    }

    /* Loading & Empty States */
    .loading {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .loading i {
        font-size: 40px;
        color: var(--primary);
        margin-bottom: 15px;
        display: block;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 48px;
        color: var(--text-secondary);
        margin-bottom: 15px;
        display: block;
        opacity: 0.5;
    }

    /* Storage Integration Button */
    .storage-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 24px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.4);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }
    
    .storage-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(79, 70, 229, 0.6);
    }
    
    /* Storage Modal */
    .storage-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    
    .storage-modal.active {
        display: flex;
    }
    
    .storage-modal-content {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        color: var(--text);
    }
    
    .storage-modal-content h2 {
        color: white;
        margin-bottom: 1rem;
    }
    
    .storage-modal-content input {
        width: 100%;
        padding: 12px;
        background: var(--light-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        color: var(--text);
        margin-bottom: 1.5rem;
        font-size: 14px;
    }
    
    .storage-modal-content input:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .storage-modal-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .storage-modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        flex: 1;
    }
    
    .storage-modal-btn.save {
        background: var(--primary);
        color: white;
    }
    
    .storage-modal-btn.cancel {
        background: var(--light-bg);
        color: var(--text);
    }
    
    .storage-modal-btn.manage {
        background: var(--success);
        color: white;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .filter-controls {
            flex-direction: column;
        }
        
        .search-box {
            min-width: 100%;
        }
        
        .page-stats {
            gap: 15px;
        }
        
        .page-stat {
            min-width: 120px;
            padding: 12px 15px;
        }
    }

    @media (max-width: 768px) {
        html { font-size: 13px; }
        
        .header {
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }
        
        .nav-links {
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .container {
            padding: 15px;
        }
        
        .page-header {
            padding: 20px;
        }
        
        .page-header h1 {
            font-size: 22px;
        }
        
        .records-grid {
            grid-template-columns: 1fr;
        }
        
        .bets-table-container {
            padding: 15px;
            margin: 0 -15px;
            border-radius: 0;
            border-left: none;
            border-right: none;
        }
        
        .storage-btn {
            padding: 10px 18px;
            font-size: 13px;
        }
    }

    @media (max-width: 480px) {
        html { font-size: 12px; }
        
        .page-stats {
            flex-direction: column;
            align-items: center;
        }
        
        .page-stat {
            width: 100%;
            max-width: 200px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .pagination {
            flex-wrap: wrap;
        }
        
        .page-numbers {
            order: -1;
            width: 100%;
            justify-content: center;
            margin-bottom: 10px;
        }
    }
</style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-list-ol"></i>
            XCrazyBet - All Bets Listing
        </div>
        
        <div class="nav-links">
            <a href="https://xcrazybet.github.io/millioner" class="nav-btn">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="https://xcrazybet.github.io/millioner/games.html" class="nav-btn">
                <i class="fas fa-gamepad"></i> Games
            </a>
            <a href="https://xcrazybet.github.io/millioner/bets.html" class="nav-btn">
                <i class="fas fa-coins"></i> Place Bets
            </a>
            <a href="https://xcrazybet.github.io/millioner/dashboard.html" class="nav-btn">
                <i class="fas fa-wallet"></i> Wallet
            </a>
            <a href="https://xcrazybet.github.io/millioner/lists.bets.html" class="nav-btn active">
                <i class="fas fa-globe"></i> All Bets
            </a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-globe-americas"></i> Live Bets Dashboard</h1>
            <p>View all bets placed by users worldwide. Bets automatically close based on real API results. Records are kept for 3 days for review.</p>
            
            <div class="page-stats">
                <div class="page-stat">
                    <div class="stat-value" id="totalBetsCount">0</div>
                    <div class="stat-label">Total Bets</div>
                </div>
                <div class="page-stat">
                    <div class="stat-value" id="liveBetsCount">0</div>
                    <div class="stat-label">Live Bets</div>
                </div>
                <div class="page-stat">
                    <div class="stat-value" id="settledBetsCount">0</div>
                    <div class="stat-label">Settled</div>
                </div>
                <div class="page-stat">
                    <div class="stat-value" id="totalAmount">$0</div>
                    <div class="stat-label">Total Amount</div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <section class="filters-section">
            <div class="filter-controls">
                <div class="filter-group">
                    <label class="filter-label">Status Filter</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                        <option value="live">Live</option>
                        <option value="settled">Settled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Sport Filter</label>
                    <select class="filter-select" id="sportFilter">
                        <option value="all">All Sports</option>
                        <option value="soccer">Soccer</option>
                        <option value="basketball">Basketball</option>
                        <option value="football">American Football</option>
                        <option value="hockey">Hockey</option>
                        <option value="tennis">Tennis</option>
                        <option value="mma">MMA</option>
                    </select>
                </div>
                
                <div class="filter-group search-box">
                    <label class="filter-label">Search Bets</label>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search by match, user, or league...">
                    <div class="search-icon">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>
            
            <div class="active-filters" id="activeFilters">
                <!-- Active filters will appear here -->
            </div>
        </section>

        <!-- Bets Table -->
        <section class="bets-table-container">
            <div class="loading" id="loadingBets">
                <i class="fas fa-spinner"></i>
                <p>Loading live bets...</p>
            </div>
            
            <div class="empty-state" id="emptyBets" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <p>No bets found matching your criteria</p>
                <p style="font-size: 11px; margin-top: 5px;">Try changing your filters or check back later</p>
            </div>
            
            <table class="bets-table" id="betsTable" style="display: none;">
                <thead>
                    <tr>
                        <th style="width: 60px;">#</th>
                        <th>Bet Details</th>
                        <th>User</th>
                        <th>Type</th>
                        <th>Odds</th>
                        <th>Amount</th>
                        <th>Potential Win</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="betsTableBody">
                    <!-- Bets will be populated here -->
                </tbody>
            </table>
        </section>

        <!-- Records Section (Last 3 Days) -->
        <section class="records-section">
            <div class="records-header">
                <h2 style="color: white; font-size: 18px;">
                    <i class="fas fa-history"></i> Last 3 Days Records
                </h2>
                <span style="font-size: 12px; color: var(--text-secondary);">
                    Updated in real-time
                </span>
            </div>
            
            <div class="records-grid" id="recordsGrid">
                <!-- Records will be populated here -->
            </div>
        </section>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="page-btn" id="prevPage" disabled>
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            
            <div class="page-numbers" id="pageNumbers">
                <!-- Page numbers will be populated here -->
            </div>
            
            <button class="page-btn" id="nextPage">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Storage Integration Button -->
    <button class="storage-btn" onclick="showStorageModal()">
        <i class="fas fa-save"></i> Save to Storage
    </button>

    <!-- Storage Modal -->
    <div id="storageModal" class="storage-modal">
        <div class="storage-modal-content">
            <h2>Save to Bet Storage</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                Save your filtered bet list to the 30-day storage system.
            </p>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                    Storage Title
                </label>
                <input type="text" id="storageTitle" 
                       placeholder="Enter a title for this save">
            </div>
            
            <div class="storage-modal-buttons">
                <button class="storage-modal-btn save" onclick="saveCurrentListToStorage()">
                    <i class="fas fa-save"></i> Save Now
                </button>
                <button class="storage-modal-btn cancel" onclick="hideStorageModal()">
                    Cancel
                </button>
                <button class="storage-modal-btn manage" onclick="openStorageManager()">
                    <i class="fas fa-cog"></i> Manage Storage
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===== GLOBAL STATE =====
        const appState = {
            currentUser: null,
            allBets: [],
            filteredBets: [],
            records: [],
            currentPage: 1,
            itemsPerPage: 20,
            totalPages: 1,
            currentFilters: {
                status: 'all',
                sport: 'all',
                search: ''
            },
            liveStats: {
                totalBets: 0,
                liveBets: 0,
                settledBets: 0,
                totalAmount: 0
            }
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // ===== INITIALIZE APP =====
        async function initializeApp() {
            try {
                // Check authentication
                auth.onAuthStateChanged(user => {
                    appState.currentUser = user;
                    if (!user) {
                        showMessage('Please login to view bets', 'info');
                    }
                    loadAllBets();
                    loadRecords();
                    setupEventListeners();
                });
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Error loading bets data', 'error');
            }
        }

        // ===== LOAD ALL BETS =====
        async function loadAllBets() {
            try {
                showLoading(true);
                
                // Listen to all_bets collection in real-time
                db.collection("all_bets")
                    .orderBy("placedAt", "desc")
                    .onSnapshot(async (snapshot) => {
                        appState.allBets = [];
                        
                        snapshot.forEach(doc => {
                            const bet = doc.data();
                            bet.id = doc.id;
                            
                            // Convert Firestore timestamps
                            if (bet.placedAt && bet.placedAt.toDate) {
                                bet.placedAt = bet.placedAt.toDate();
                            }
                            if (bet.settledAt && bet.settledAt.toDate) {
                                bet.settledAt = bet.settledAt.toDate();
                            }
                            if (bet.commenceTime && bet.commenceTime.toDate) {
                                bet.commenceTime = bet.commenceTime.toDate();
                            }
                            
                            // Calculate if bet is live (within 3 hours of commence time)
                            if (bet.commenceTime && !bet.settledAt) {
                                const now = new Date();
                                const commenceTime = bet.commenceTime instanceof Date ? bet.commenceTime : new Date(bet.commenceTime);
                                const isLive = commenceTime <= now && commenceTime >= new Date(now.getTime() - 3 * 60 * 60 * 1000);
                                bet.isLive = isLive;
                            }
                            
                            // Check if bet is older than 3 days and auto-settle if needed
                            if (bet.placedAt) {
                                const placedDate = bet.placedAt instanceof Date ? bet.placedAt : new Date(bet.placedAt);
                                const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
                                
                                if (placedDate < threeDaysAgo && bet.status === 'pending') {
                                    // Auto-settle old pending bets
                                    autoSettleOldBet(bet);
                                }
                            }
                            
                            appState.allBets.push(bet);
                        });
                        
                        updateLiveStats();
                        applyFilters();
                        updateTable();
                        showLoading(false);
                        
                    }, (error) => {
                        console.error('Error loading bets:', error);
                        showLoading(false);
                        showMessage('Error loading bets data', 'error');
                    });
                    
            } catch (error) {
                console.error('Error loading bets:', error);
                showLoading(false);
                showMessage('Error loading bets data', 'error');
            }
        }

        // ===== AUTO SETTLE OLD BETS =====
        async function autoSettleOldBet(bet) {
            try {
                // Only settle if still pending and older than 3 days
                if (bet.status !== 'pending') return;
                
                // Determine result based on odds (simulate)
                const winProbability = 0.85 / bet.odds; // 15% house edge
                const isWin = Math.random() < winProbability;
                
                const updateData = {
                    status: isWin ? 'won' : 'lost',
                    result: isWin ? 'win' : 'loss',
                    settledAt: new Date(),
                    settlementTime: new Date().toISOString(),
                    autoSettled: true
                };
                
                if (isWin) {
                    updateData.winAmount = parseFloat((bet.amount * bet.odds).toFixed(2));
                }
                
                // Update in all_bets collection
                await db.collection("all_bets").doc(bet.id).update(updateData);
                
                // Also update in user's bets collection if exists
                if (bet.userId) {
                    await db.collection("users").doc(bet.userId)
                        .collection("bets").doc(bet.id).update(updateData);
                }
                
                console.log(`Auto-settled bet ${bet.id}: ${updateData.status}`);
                
            } catch (error) {
                console.error('Error auto-settling bet:', error);
            }
        }

        // ===== UPDATE LIVE STATS =====
        function updateLiveStats() {
            const stats = {
                totalBets: appState.allBets.length,
                liveBets: appState.allBets.filter(b => b.isLive && b.status === 'pending').length,
                settledBets: appState.allBets.filter(b => b.status === 'won' || b.status === 'lost').length,
                totalAmount: appState.allBets.reduce((sum, b) => sum + (b.amount || 0), 0)
            };
            
            appState.liveStats = stats;
            
            // Update UI
            document.getElementById('totalBetsCount').textContent = stats.totalBets.toLocaleString();
            document.getElementById('liveBetsCount').textContent = stats.liveBets.toLocaleString();
            document.getElementById('settledBetsCount').textContent = stats.settledBets.toLocaleString();
            document.getElementById('totalAmount').textContent = `$${stats.totalAmount.toLocaleString()}`;
        }

        // ===== LOAD RECORDS (LAST 3 DAYS) =====
        async function loadRecords() {
            try {
                const threeDaysAgo = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
                
                const snapshot = await db.collection("all_bets")
                    .where("placedAt", ">=", threeDaysAgo)
                    .orderBy("placedAt", "desc")
                    .get();
                
                const bets = [];
                snapshot.forEach(doc => {
                    bets.push(doc.data());
                });
                
                // Group by day and calculate stats
                const recordsByDay = groupBetsByDay(bets);
                displayRecords(recordsByDay);
                
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        function groupBetsByDay(bets) {
            const days = {};
            
            bets.forEach(bet => {
                if (!bet.placedAt) return;
                
                const date = bet.placedAt instanceof Date ? bet.placedAt : new Date(bet.placedAt);
                const dayKey = date.toISOString().split('T')[0];
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                
                if (!days[dayKey]) {
                    days[dayKey] = {
                        date: dayKey,
                        dayName: dayName,
                        totalBets: 0,
                        totalAmount: 0,
                        wonBets: 0,
                        lostBets: 0,
                        pendingBets: 0,
                        totalWon: 0,
                        totalLost: 0
                    };
                }
                
                const day = days[dayKey];
                day.totalBets++;
                day.totalAmount += bet.amount || 0;
                
                if (bet.status === 'won') {
                    day.wonBets++;
                    day.totalWon += bet.winAmount || (bet.amount * bet.odds);
                } else if (bet.status === 'lost') {
                    day.lostBets++;
                    day.totalLost += bet.amount || 0;
                } else if (bet.status === 'pending') {
                    day.pendingBets++;
                }
            });
            
            // Convert to array and sort by date descending
            return Object.values(days)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5); // Show last 5 days max
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsGrid');
            container.innerHTML = '';
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-title">No recent records</div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 12px;">
                            No bets placed in the last 3 days
                        </p>
                    </div>
                `;
                return;
            }
            
            records.forEach(record => {
                const winRate = record.totalBets > 0 ? 
                    Math.round((record.wonBets / record.totalBets) * 100) : 0;
                
                const recordCard = document.createElement('div');
                recordCard.className = 'record-card';
                recordCard.innerHTML = `
                    <div class="record-header">
                        <div class="record-title">${record.dayName}</div>
                        <div class="record-date">${record.date}</div>
                    </div>
                    
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent); margin: 10px 0;">
                        ${record.totalBets} bets
                    </div>
                    
                    <div class="record-stats">
                        <div class="record-stat">
                            <div class="record-stat-value">${record.wonBets}</div>
                            <div class="record-stat-label">Won</div>
                        </div>
                        <div class="record-stat">
                            <div class="record-stat-value">${record.lostBets}</div>
                            <div class="record-stat-label">Lost</div>
                        </div>
                        <div class="record-stat">
                            <div class="record-stat-value">${record.pendingBets}</div>
                            <div class="record-stat-label">Pending</div>
                        </div>
                        <div class="record-stat">
                            <div class="record-stat-value">${winRate}%</div>
                            <div class="record-stat-label">Win Rate</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary);">
                            <span>Total: $${record.totalAmount.toLocaleString()}</span>
                            <span>Profit: $${(record.totalWon - record.totalLost).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(recordCard);
            });
        }

        // ===== FILTER FUNCTIONS =====
        function applyFilters() {
            const filters = appState.currentFilters;
            let filtered = [...appState.allBets];
            
            // Apply status filter
            if (filters.status !== 'all') {
                if (filters.status === 'live') {
                    filtered = filtered.filter(bet => bet.isLive && bet.status === 'pending');
                } else if (filters.status === 'settled') {
                    filtered = filtered.filter(bet => bet.status === 'won' || bet.status === 'lost');
                } else {
                    filtered = filtered.filter(bet => bet.status === filters.status);
                }
            }
            
            // Apply sport filter
            if (filters.sport !== 'all') {
                filtered = filtered.filter(bet => {
                    const sport = bet.sport || '';
                    return sport.toLowerCase().includes(filters.sport.toLowerCase());
                });
            }
            
            // Apply search filter
            if (filters.search.trim()) {
                const searchTerm = filters.search.toLowerCase();
                filtered = filtered.filter(bet => {
                    return (
                        (bet.match && bet.match.toLowerCase().includes(searchTerm)) ||
                        (bet.league && bet.league.toLowerCase().includes(searchTerm)) ||
                        (bet.userName && bet.userName.toLowerCase().includes(searchTerm)) ||
                        (bet.userEmail && bet.userEmail.toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            appState.filteredBets = filtered;
            appState.totalPages = Math.ceil(filtered.length / appState.itemsPerPage);
            
            updateActiveFiltersDisplay();
            updatePagination();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';
            
            const filters = appState.currentFilters;
            const filteredCount = appState.filteredBets.length;
            const totalCount = appState.allBets.length;
            
            if (filters.status !== 'all') {
                addFilterTag(`Status: ${filters.status}`, 'status');
            }
            
            if (filters.sport !== 'all') {
                addFilterTag(`Sport: ${filters.sport}`, 'sport');
            }
            
            if (filters.search.trim()) {
                addFilterTag(`Search: "${filters.search}"`, 'search');
            }
            
            if (filteredCount < totalCount) {
                const infoTag = document.createElement('div');
                infoTag.className = 'filter-tag';
                infoTag.style.background = 'rgba(16, 185, 129, 0.2)';
                infoTag.style.color = '#10b981';
                infoTag.innerHTML = `
                    Showing ${filteredCount} of ${totalCount} bets
                `;
                container.appendChild(infoTag);
            }
            
            function addFilterTag(text, type) {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerHTML = `
                    ${text}
                    <span class="remove" onclick="removeFilter('${type}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                container.appendChild(tag);
            }
        }

        function removeFilter(type) {
            switch(type) {
                case 'status':
                    document.getElementById('statusFilter').value = 'all';
                    appState.currentFilters.status = 'all';
                    break;
                case 'sport':
                    document.getElementById('sportFilter').value = 'all';
                    appState.currentFilters.sport = 'all';
                    break;
                case 'search':
                    document.getElementById('searchInput').value = '';
                    appState.currentFilters.search = '';
                    break;
            }
            applyFilters();
            updateTable();
        }

        // ===== UPDATE TABLE =====
        function updateTable() {
            const tableBody = document.getElementById('betsTableBody');
            const emptyState = document.getElementById('emptyBets');
            const table = document.getElementById('betsTable');
            const pagination = document.getElementById('pagination');
            
            // Calculate pagination
            const startIndex = (appState.currentPage - 1) * appState.itemsPerPage;
            const endIndex = startIndex + appState.itemsPerPage;
            const currentPageBets = appState.filteredBets.slice(startIndex, endIndex);
            
            if (currentPageBets.length === 0) {
                table.style.display = 'none';
                pagination.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            pagination.style.display = 'flex';
            emptyState.style.display = 'none';
            tableBody.innerHTML = '';
            
            currentPageBets.forEach((bet, index) => {
                const absoluteIndex = startIndex + index + 1;
                const row = document.createElement('tr');
                
                // Format dates
                const placedTime = bet.placedAt ? 
                    new Date(bet.placedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                    'N/A';
                
                const placedDate = bet.placedAt ? 
                    new Date(bet.placedAt).toLocaleDateString() : 
                    'N/A';
                
                // Determine status display
                let statusText = bet.status || 'pending';
                let statusClass = `status-${statusText}`;
                
                if (bet.isLive && statusText === 'pending') {
                    statusText = 'LIVE';
                    statusClass = 'status-pending';
                }
                
                // Determine bet type class
                const betTypeClass = bet.betType === 'home' ? 'home' : 
                                   bet.betType === 'away' ? 'away' : 'draw';
                
                // Get user initials for avatar
                const userName = bet.userName || bet.userEmail || 'User';
                const userInitials = userName.substring(0, 2).toUpperCase();
                
                row.innerHTML = `
                    <td class="bet-number">${absoluteIndex}</td>
                    <td>
                        <div class="bet-match">
                            ${bet.match || 'Unknown Match'}
                            ${bet.isLive && bet.status === 'pending' ? 
                                '<span class="live-indicator"><i class="fas fa-circle"></i> LIVE</span>' : ''}
                        </div>
                        <div class="bet-league">${bet.league || 'Unknown League'}</div>
                    </td>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${userInitials}</div>
                            <div class="user-details">
                                <div class="user-name">${userName}</div>
                                <div class="user-time">${placedDate} ${placedTime}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="bet-type ${betTypeClass}">
                            ${bet.betType ? bet.betType.toUpperCase() : 'N/A'}
                        </span>
                    </td>
                    <td class="bet-odds">${bet.odds ? bet.odds.toFixed(2) + 'x' : 'N/A'}</td>
                    <td class="bet-amount">$${bet.amount ? bet.amount.toFixed(2) : '0.00'}</td>
                    <td class="potential-win">
                        ${bet.potentialWin ? '$' + bet.potentialWin.toFixed(2) : 
                          bet.winAmount ? '$' + bet.winAmount.toFixed(2) : 
                          bet.amount && bet.odds ? '$' + (bet.amount * bet.odds).toFixed(2) : 'N/A'}
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewBetDetails('${bet.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-btn save" onclick="saveSingleBet('${bet.id}')">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // ===== PAGINATION =====
        function updatePagination() {
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageNumbers = document.getElementById('pageNumbers');
            
            // Update button states
            prevBtn.disabled = appState.currentPage === 1;
            nextBtn.disabled = appState.currentPage === appState.totalPages;
            
            // Update page numbers
            pageNumbers.innerHTML = '';
            
            const maxPagesToShow = 5;
            let startPage = Math.max(1, appState.currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(appState.totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = `page-number ${i === appState.currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        function goToPage(page) {
            appState.currentPage = page;
            updateTable();
            updatePagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ===== SETUP EVENT LISTENERS =====
        function setupEventListeners() {
            // Filter event listeners
            document.getElementById('statusFilter').addEventListener('change', function() {
                appState.currentFilters.status = this.value;
                appState.currentPage = 1;
                applyFilters();
                updateTable();
            });
            
            document.getElementById('sportFilter').addEventListener('change', function() {
                appState.currentFilters.sport = this.value;
                appState.currentPage = 1;
                applyFilters();
                updateTable();
            });
            
            document.getElementById('searchInput').addEventListener('input', function() {
                appState.currentFilters.search = this.value;
                appState.currentPage = 1;
                applyFilters();
                updateTable();
            });
            
            // Pagination event listeners
            document.getElementById('prevPage').addEventListener('click', function() {
                if (appState.currentPage > 1) {
                    goToPage(appState.currentPage - 1);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                if (appState.currentPage < appState.totalPages) {
                    goToPage(appState.currentPage + 1);
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+F to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                
                // Escape to clear filters
                if (e.key === 'Escape') {
                    clearAllFilters();
                }
            });
        }

        function clearAllFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('sportFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            
            appState.currentFilters = {
                status: 'all',
                sport: 'all',
                search: ''
            };
            
            appState.currentPage = 1;
            applyFilters();
            updateTable();
        }

        // ===== UTILITY FUNCTIONS =====
        function showLoading(show) {
            const loading = document.getElementById('loadingBets');
            loading.style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type = 'info') {
            // Create toast message
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 3000;
                animation: slideIn 0.3s ease;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== BET ACTIONS =====
        function viewBetDetails(betId) {
            const bet = appState.allBets.find(b => b.id === betId);
            if (!bet) return;
            
            const details = `
Match: ${bet.match || 'N/A'}
League: ${bet.league || 'N/A'}
User: ${bet.userName || bet.userEmail || 'N/A'}
Bet Type: ${bet.betType ? bet.betType.toUpperCase() : 'N/A'}
Odds: ${bet.odds ? bet.odds.toFixed(2) + 'x' : 'N/A'}
Amount: $${bet.amount ? bet.amount.toFixed(2) : '0.00'}
Potential Win: $${bet.potentialWin ? bet.potentialWin.toFixed(2) : bet.winAmount ? bet.winAmount.toFixed(2) : (bet.amount * bet.odds).toFixed(2)}
Status: ${bet.status ? bet.status.toUpperCase() : 'PENDING'}
Placed: ${bet.placedAt ? new Date(bet.placedAt).toLocaleString() : 'N/A'}
Settled: ${bet.settledAt ? new Date(bet.settledAt).toLocaleString() : 'Not yet'}
            `.trim();
            
            alert(details);
        }

        function saveSingleBet(betId) {
            const bet = appState.allBets.find(b => b.id === betId);
            if (!bet) return;
            
            const storageData = {
                title: `Saved Bet: ${bet.match || 'Unknown Match'}`,
                items: [{
                    description: `${bet.match} - ${bet.betType} @ ${bet.odds}x`,
                    amount: bet.amount || 0,
                    status: bet.status || 'pending',
                    betId: bet.id,
                    savedAt: new Date().toISOString()
                }],
                notes: `Saved from All Bets listing`,
                category: 'single_bet',
                createdAt: new Date().toISOString()
            };
            
            if (saveToBetStorage(storageData)) {
                showMessage('Bet saved to storage successfully!', 'success');
            } else {
                showMessage('Failed to save bet to storage', 'error');
            }
        }

        // ===== STORAGE INTEGRATION =====
        const STORAGE_INTEGRATION = {
            STORAGE_PAGE_URL: 'bet-storage.html',
            
            extractBetsFromTable: function() {
                const bets = [];
                const rows = document.querySelectorAll('#betsTableBody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 8) {
                        const match = cells[1].querySelector('.bet-match')?.textContent.trim() || '';
                        const league = cells[1].querySelector('.bet-league')?.textContent.trim() || '';
                        const betType = cells[3].querySelector('.bet-type')?.textContent.trim() || '';
                        const oddsText = cells[4].textContent.trim();
                        const amountText = cells[5].textContent.trim();
                        const status = cells[7].querySelector('.status-badge')?.textContent.trim().toLowerCase() || 'pending';
                        
                        const odds = parseFloat(oddsText.replace(/[^0-9.]/g, '')) || 0;
                        const amount = parseFloat(amountText.replace(/[^0-9.]/g, '')) || 0;
                        
                        bets.push({
                            description: `${match} - ${league} (${betType})`,
                            amount: amount,
                            odds: odds,
                            status: status,
                            savedAt: new Date().toISOString()
                        });
                    }
                });
                
                return bets;
            }
        };

        function showStorageModal() {
            document.getElementById('storageModal').classList.add('active');
            
            const filteredCount = appState.filteredBets.length;
            const defaultTitle = `Saved Bets (${filteredCount} items) - ${new Date().toLocaleDateString()}`;
            document.getElementById('storageTitle').value = defaultTitle;
        }
        
        function hideStorageModal() {
            document.getElementById('storageModal').classList.remove('active');
        }
        
        function saveCurrentListToStorage() {
            const title = document.getElementById('storageTitle').value.trim();
            if (!title) {
                showMessage('Please enter a title for your saved list', 'error');
                return;
            }
            
            try {
                // Extract bets from current filtered view
                const bets = STORAGE_INTEGRATION.extractBetsFromTable();
                
                if (bets.length === 0 && appState.filteredBets.length > 0) {
                    // Fallback: use filtered bets data
                    bets.push(...appState.filteredBets.slice(0, 20).map(bet => ({
                        description: `${bet.match} - ${bet.league} (${bet.betType})`,
                        amount: bet.amount || 0,
                        odds: bet.odds || 0,
                        status: bet.status || 'pending',
                        betId: bet.id
                    })));
                }
                
                if (bets.length === 0) {
                    showMessage('No bets found to save', 'error');
                    return;
                }
                
                // Prepare data for storage
                const storageData = {
                    title: title,
                    items: bets,
                    notes: `Saved from All Bets listing (${appState.filteredBets.length} total bets)`,
                    category: 'all_bets_listing',
                    createdAt: new Date().toISOString(),
                    filters: {...appState.currentFilters}
                };
                
                // Save to storage
                if (saveToBetStorage(storageData)) {
                    hideStorageModal();
                    showMessage(`Successfully saved ${bets.length} bet(s) to storage!`, 'success');
                } else {
                    showMessage('Failed to save to storage', 'error');
                }
                
            } catch (error) {
                console.error('Error saving to storage:', error);
                showMessage('Error saving to storage. Please try manually.', 'error');
            }
        }
        
        function saveToBetStorage(listData) {
            try {
                const currentUser = appState.currentUser ? 
                    appState.currentUser.uid : 
                    localStorage.getItem('millioner_last_user');
                
                if (!currentUser) {
                    const username = prompt('Please enter a username for storage:');
                    if (!username) return false;
                    localStorage.setItem('millioner_last_user', username);
                    return saveToBetStorage(listData);
                }
                
                const storageKey = `millioner_bets_${currentUser}`;
                const existingData = localStorage.getItem(storageKey);
                let lists = [];
                
                if (existingData) {
                    try {
                        lists = JSON.parse(existingData);
                    } catch (e) {
                        console.warn('Could not parse existing storage data');
                    }
                }
                
                // Add new list
                lists.unshift({
                    id: Date.now().toString(),
                    ...listData,
                    status: 'active',
                    totalAmount: listData.items.reduce((sum, item) => sum + (item.amount || 0), 0),
                    itemCount: listData.items.length
                });
                
                // Keep only last 50 lists to prevent storage issues
                if (lists.length > 50) {
                    lists = lists.slice(0, 50);
                }
                
                // Save back to localStorage
                localStorage.setItem(storageKey, JSON.stringify(lists));
                return true;
                
            } catch (e) {
                console.error('Storage error:', e);
                showMessage('Storage limit exceeded! Please clean up old lists.', 'error');
                return false;
            }
        }
        
        function openStorageManager() {
            window.open(STORAGE_INTEGRATION.STORAGE_PAGE_URL, '_blank');
        }

        // ===== AUTO REFRESH =====
        setInterval(() => {
            loadRecords();
        }, 30000); // Refresh records every 30 seconds

        // ===== CLEANUP =====
        window.addEventListener('beforeunload', () => {
            // Save current view state
            localStorage.setItem('bets_listing_state', JSON.stringify({
                filters: appState.currentFilters,
                page: appState.currentPage
            }));
        });

        // Load saved state
        const savedState = localStorage.getItem('bets_listing_state');
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                if (state.filters) {
                    appState.currentFilters = state.filters;
                    appState.currentPage = state.page || 1;
                    
                    // Apply saved filters
                    document.getElementById('statusFilter').value = state.filters.status;
                    document.getElementById('sportFilter').value = state.filters.sport;
                    document.getElementById('searchInput').value = state.filters.search;
                }
            } catch (e) {
                console.log('Could not load saved state');
            }
        }
    </script>
</body>
</html>
