<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Millioner Pro - Ultimate Crash</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Howler for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <!-- CryptoJS for Provably Fair -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --bg: #070a15;
            --surface: #101425;
            --accent: #00f2ff;
            --success: #00ff88;
            --danger: #ff3e3e;
            --warning: #ffbe00;
            --text: #ffffff;
            --text-dim: #848da0;
            --primary: #ff4081;
            --secondary: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Gradient Background */
        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(-45deg, 
                #0f0c29, 
                #302b63, 
                #24243e, 
                #0f0c29);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }

        .particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Header */
        .header {
            background: rgba(16, 20, 37, 0.9);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
        }

        .logo span {
            color: var(--accent);
        }

        .nav-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: var(--accent);
            color: black;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--accent);
            color: black;
            border-color: var(--text);
        }

        .balance-card {
            background: linear-gradient(45deg, #1a203a, #0f0c29);
            padding: 12px 24px;
            border-radius: 12px;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.2);
            min-width: 200px;
            justify-content: center;
        }

        /* History Strip */
        .history-strip {
            background: rgba(9, 12, 24, 0.8);
            padding: 12px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-strip::-webkit-scrollbar {
            height: 4px;
        }

        .history-strip::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-strip::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .hist-tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            transition: all 0.3s;
        }

        .hist-tag.low { background: rgba(255, 62, 62, 0.2); color: var(--danger); }
        .hist-tag.medium { background: rgba(255, 190, 0, 0.2); color: var(--warning); }
        .hist-tag.high { background: rgba(0, 255, 136, 0.2); color: var(--success); }
        .hist-tag.moon { background: rgba(147, 51, 234, 0.2); color: #9333ea; }

        /* Game Container */
        .game-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 15px;
            padding: 20px;
            height: calc(100vh - 160px);
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: auto;
            }
            .sidebar {
                display: none !important;
            }
        }

        /* Sidebar */
        .sidebar {
            background: rgba(16, 20, 37, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .sidebar-header {
            padding: 15px;
            background: rgba(26, 32, 58, 0.9);
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Game Area */
        .main-game {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .game-canvas-container {
            flex: 1;
            background: rgba(16, 20, 37, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
            min-height: 400px;
            backdrop-filter: blur(10px);
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .multiplier-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        #mult-val {
            font-size: 80px;
            font-weight: 900;
            margin: 0;
            text-shadow: 0 0 30px rgba(0, 242, 255, 0.6);
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        #game-status {
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-dim);
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .current-bets {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* Controls */
        .controls {
            background: rgba(16, 20, 37, 0.9);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            backdrop-filter: blur(10px);
        }

        .bet-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-size: 12px;
            color: var(--text-dim);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 15px;
            background: rgba(22, 27, 51, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 242, 255, 0.1);
        }

        .currency {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-weight: 600;
        }

        .quick-bets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 5px;
        }

        .quick-bet {
            padding: 10px;
            background: rgba(22, 27, 51, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .quick-bet:hover {
            background: var(--accent);
            color: black;
            transform: translateY(-2px);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-bet {
            background: linear-gradient(135deg, var(--success), #00cc6a);
            color: black;
        }

        .btn-bet:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-cashout {
            background: linear-gradient(135deg, var(--warning), #e6a700);
            color: black;
            display: none;
        }

        .btn-cashout:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 190, 0, 0.3);
        }

        .multi-bet {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--secondary), #1976d2);
            color: white;
            font-size: 14px;
            padding: 12px;
        }

        /* Bet List */
        .bet-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .bet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            transition: all 0.3s;
        }

        .bet-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .bet-item.win {
            background: rgba(0, 255, 136, 0.05);
            color: var(--success);
        }

        .bet-item.loss {
            background: rgba(255, 62, 62, 0.05);
            color: var(--danger);
        }

        .bet-user {
            font-weight: 600;
        }

        .bet-multiplier {
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        /* Stats Box */
        .stats-box {
            padding: 20px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .stat-value {
            font-weight: 700;
            color: var(--accent);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 10px;
            background: rgba(16, 20, 37, 0.95);
            border-left: 4px solid var(--accent);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast.info { border-color: var(--accent); }

        /* Animations */
        @keyframes crash-shake {
            0% { transform: translate(2px, 2px) rotate(0deg); }
            20% { transform: translate(-2px, -2px) rotate(-1deg); }
            40% { transform: translate(2px, -2px) rotate(1deg); }
            60% { transform: translate(-2px, 2px) rotate(0deg); }
            80% { transform: translate(2px, 2px) rotate(-1deg); }
            100% { transform: translate(0,0) rotate(0deg); }
        }

        .crash-anim {
            animation: crash-shake 0.1s infinite;
            color: var(--danger) !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
            }

            .balance-card {
                width: 100%;
                min-width: auto;
            }

            .game-container {
                padding: 10px;
                gap: 10px;
            }

            .controls {
                padding: 15px;
            }

            .bet-inputs {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .quick-bets {
                grid-template-columns: repeat(2, 1fr);
            }

            #mult-val {
                font-size: 50px;
            }

            .multiplier-overlay {
                width: 90%;
            }
        }

        @media (max-width: 480px) {
            .nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .logo {
                font-size: 20px;
            }

            #mult-val {
                font-size: 40px;
            }

            .btn {
                padding: 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="gradient-bg"></div>
    <canvas class="particle-canvas" id="particleCanvas"></canvas>

    <!-- Header -->
    <header class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="https://xcrazybet.github.io/millioner" class="nav-btn" style="background: var(--primary);">
                <i class="fas fa-home"></i> Home
            </a>
            <div class="logo">
                <i class="fas fa-rocket"></i>
                MILLIONER <span>PRO</span>
            </div>
        </div>
        
        <div class="nav-links">
            <a href="https://xcrazybet.github.io/millioner/games.html" class="nav-btn">
                <i class="fas fa-gamepad"></i> Games
            </a>
            <a href="https://xcrazybet.github.io/millioner/bets.html" class="nav-btn">
                <i class="fas fa-coins"></i> Bets
            </a>
            <a href="https://xcrazybet.github.io/millioner/dashboard.html" class="nav-btn">
                <i class="fas fa-wallet"></i> Deposit
            </a>
        </div>
        
        <div class="balance-card">
            <i class="fas fa-wallet"></i>
            <span id="balance-val">Loading...</span>
        </div>
    </header>

    <!-- History Strip -->
    <div class="history-strip" id="history-bar">
        <!-- History will be populated by JavaScript -->
    </div>

    <!-- Main Game Container -->
    <div class="game-container">
        <!-- Left Sidebar: Live Bets -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-bolt"></i> LIVE BETS
            </div>
            <div class="bet-list" id="live-bets">
                <!-- Live bets will be populated -->
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="main-game">
            <div class="game-canvas-container">
                <div class="multiplier-overlay">
                    <div id="game-status">Waiting for round...</div>
                    <h1 id="mult-val">1.00x</h1>
                </div>
                <canvas id="gameCanvas"></canvas>
                <div class="current-bets" id="current-bets">
                    Your Bets: None
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="bet-inputs">
                    <div class="input-group">
                        <label>BET AMOUNT</label>
                        <div class="input-wrapper">
                            <input type="number" id="input-amount" value="10.00" min="1" step="0.01">
                            <span class="currency">$</span>
                        </div>
                        <div class="quick-bets">
                            <div class="quick-bet" data-amount="1">$1</div>
                            <div class="quick-bet" data-amount="5">$5</div>
                            <div class="quick-bet" data-amount="10">$10</div>
                            <div class="quick-bet" data-amount="50">$50</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>AUTO CASHOUT AT</label>
                        <div class="input-wrapper">
                            <input type="number" id="input-auto" value="2.00" min="1.01" step="0.01">
                            <span class="currency">x</span>
                        </div>
                        <div class="quick-bets">
                            <div class="quick-bet" data-multiplier="1.5">1.5x</div>
                            <div class="quick-bet" data-multiplier="2">2x</div>
                            <div class="quick-bet" data-multiplier="5">5x</div>
                            <div class="quick-bet" data-multiplier="10">10x</div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btn-bet" class="btn btn-bet">
                        <i class="fas fa-play-circle"></i> PLACE BET
                    </button>
                    <button id="btn-cashout" class="btn btn-cashout">
                        <i class="fas fa-money-bill-wave"></i> CASH OUT
                    </button>
                    <button id="btn-multi-bet" class="btn multi-bet">
                        <i class="fas fa-layer-group"></i> ADD MULTI BET
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Stats & Info -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-line"></i> GAME STATS
            </div>
            <div class="stats-box">
                <div class="stat-item">
                    <span>Max Win</span>
                    <span class="stat-value">$10,000</span>
                </div>
                <div class="stat-item">
                    <span>Min Bet</span>
                    <span class="stat-value">$1.00</span>
                </div>
                <div class="stat-item">
                    <span>Max Bet</span>
                    <span class="stat-value">$1,000</span>
                </div>
                <div class="stat-item">
                    <span>House Edge</span>
                    <span class="stat-value">3%</span>
                </div>
                <div class="stat-item">
                    <span>Active Players</span>
                    <span class="stat-value" id="active-players">0</span>
                </div>
                <div class="stat-item">
                    <span>Round ID</span>
                    <span class="stat-value" id="round-id">-</span>
                </div>
            </div>
            
            <div class="sidebar-header" style="margin-top: 20px;">
                <i class="fas fa-shield-alt"></i> PROVABLY FAIR
            </div>
            <div class="stats-box">
                <div class="stat-item">
                    <span>Last Hash</span>
                    <span class="stat-value" id="last-hash" style="font-size: 10px;">-</span>
                </div>
                <div class="stat-item">
                    <span>Verification</span>
                    <a href="#" id="verify-link" style="color: var(--accent); font-size: 12px;">Verify Round</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===== GAME STATE =====
        const GAME_CONFIG = {
            LOBBY_TIME: 5000,
            HOUSE_EDGE: 0.03, // 3% instant crash
            MAX_PAYOUT: 10000,
            MIN_BET: 1,
            MAX_BET: 1000,
            GROWTH_RATE: 0.0006
        };

        const gameState = {
            currentUser: null,
            balance: 0,
            currentRound: null,
            isWaiting: true,
            isPlaying: false,
            hasCashedOut: false,
            multiplier: 1.0,
            crashPoint: 1.0,
            startTime: 0,
            history: [],
            activeBets: [],
            playerBets: [],
            particles: [],
            roundId: null,
            roundHash: null,
            lastHash: null,
            serverSeed: "millioner_pro_seed_" + Date.now(),
            clientSeed: null
        };

        // ===== AUDIO =====
        const SFX = {
            tick: new Howl({ src: ['https://assets.mixkit.co/sfx/preview/mixkit-clock-ticking-close-up-1002.mp3'], volume: 0.1 }),
            crash: new Howl({ src: ['https://assets.mixkit.co/sfx/preview/mixkit-electronic-retro-block-hit-2185.mp3'], volume: 0.5 }),
            win: new Howl({ src: ['https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3'], volume: 0.4 }),
            bet: new Howl({ src: ['https://assets.mixkit.co/sfx/preview/mixkit-plastic-bubble-click-1124.mp3'], volume: 0.3 }),
            flying: new Howl({ src: ['https://assets.mixkit.co/sfx/preview/mixkit-arcade-space-shooter-deployed-2049.mp3'], volume: 0.2, loop: true })
        };

        // ===== CANVAS SETUP =====
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        const particleCanvas = document.getElementById('particleCanvas');
        const particleCtx = particleCanvas.getContext('2d');

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            setupEventListeners();
            checkAuth();
        });

        // ===== AUTHENTICATION =====
        function checkAuth() {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    showToast('Please login to play', 'error');
                    setTimeout(() => {
                        window.location.href = 'https://xcrazybet.github.io/millioner/login.html';
                    }, 2000);
                    return;
                }
                gameState.currentUser = user;
                gameState.clientSeed = user.uid.substring(0, 8);
                loadBalance();
                setupRealTimeListeners();
            });
        }

        // ===== BALANCE MANAGEMENT =====
        async function loadBalance() {
            try {
                const doc = await db.collection("wallets").doc(gameState.currentUser.uid).get();
                if (doc.exists) {
                    gameState.balance = doc.data().balance || 0;
                    updateBalanceDisplay();
                } else {
                    await db.collection("wallets").doc(gameState.currentUser.uid).set({
                        balance: 100,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    gameState.balance = 100;
                    updateBalanceDisplay();
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                showToast('Error loading balance', 'error');
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('balance-val');
            if (balanceElement) {
                balanceElement.innerHTML = `$${gameState.balance.toFixed(2)}`;
            }
        }

        // ===== REAL-TIME BALANCE LISTENER =====
        function setupRealTimeListeners() {
            // Wallet balance listener
            const walletRef = db.collection("wallets").doc(gameState.currentUser?.uid);
            walletRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const newBalance = doc.data().balance || 0;
                    if (newBalance !== gameState.balance) {
                        gameState.balance = newBalance;
                        updateBalanceDisplay();
                        showToast('Balance updated', 'info');
                    }
                }
            });

            // Live bets listener
            const betsRef = db.collection("crash_bets").where("roundId", "==", gameState.roundId);
            betsRef.onSnapshot((snapshot) => {
                updateLiveBets(snapshot);
            });
        }

        // ===== ATOMIC TRANSACTIONS =====
        async function processBetTransaction(amount, type = "crash_bet") {
            try {
                const walletRef = db.collection("wallets").doc(gameState.currentUser.uid);
                
                return await db.runTransaction(async (transaction) => {
                    const walletDoc = await transaction.get(walletRef);
                    
                    if (!walletDoc.exists) {
                        throw new Error("Wallet not found");
                    }
                    
                    const currentBalance = walletDoc.data().balance || 0;
                    
                    if (type.includes("bet") && amount > currentBalance) {
                        throw new Error("Insufficient balance");
                    }
                    
                    const newBalance = type.includes("bet") 
                        ? currentBalance - amount 
                        : currentBalance + amount;
                    
                    // Update balance
                    transaction.update(walletRef, {
                        balance: newBalance,
                        updatedAt: new Date()
                    });
                    
                    // Record transaction
                    const txRef = walletRef.collection("transactions").doc();
                    transaction.set(txRef, {
                        type: type,
                        amount: type.includes("bet") ? -amount : amount,
                        description: `Crash game ${type}`,
                        createdAt: new Date(),
                        roundId: gameState.roundId,
                        beforeBalance: currentBalance,
                        afterBalance: newBalance,
                        multiplier: type.includes("win") ? gameState.multiplier : null
                    });
                    
                    // Update local state
                    gameState.balance = newBalance;
                    updateBalanceDisplay();
                    
                    return { success: true, newBalance };
                    
                });
            } catch (error) {
                console.error('Transaction failed:', error);
                showToast('Transaction failed: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }

        // ===== PROVABLY FAIR SYSTEM =====
        function generateCrashPoint() {
            // Generate server seed if not exists
            if (!gameState.serverSeed) {
                gameState.serverSeed = "millioner_pro_seed_" + Date.now();
            }
            
            // Create hash
            const hashInput = gameState.serverSeed + gameState.clientSeed + Date.now();
            const hash = CryptoJS.SHA256(hashInput).toString();
            gameState.lastHash = hash;
            
            // Extract crash point from hash
            const h = parseInt(hash.substring(0, 8), 16);
            const r = h / Math.pow(2, 32);
            
            // Apply 3% house edge (instant crash at 1.00x)
            if (r < GAME_CONFIG.HOUSE_EDGE) {
                return 1.00;
            }
            
            // Calculate crash point with exponential distribution
            const crashPoint = Math.max(1.01, (1 - GAME_CONFIG.HOUSE_EDGE) / (1 - r));
            
            // Update UI
            document.getElementById('last-hash').textContent = hash.substring(0, 12) + '...';
            document.getElementById('round-id').textContent = gameState.roundId;
            
            return crashPoint;
        }

        // ===== GAME ENGINE =====
        function initGame() {
            resizeCanvases();
            window.addEventListener('resize', resizeCanvases);
            
            // Start particle animation
            animateParticles();
            
            // Start game loop
            runLobby();
            requestAnimationFrame(gameLoop);
        }

        function resizeCanvases() {
            gameCanvas.width = gameCanvas.parentElement.clientWidth;
            gameCanvas.height = gameCanvas.parentElement.clientHeight;
            
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
        }

        function runLobby() {
            gameState.isWaiting = true;
            gameState.isPlaying = false;
            gameState.hasCashedOut = false;
            gameState.multiplier = 1.0;
            gameState.playerBets = [];
            
            // Update UI
            document.getElementById('btn-bet').style.display = 'block';
            document.getElementById('btn-cashout').style.display = 'none';
            document.getElementById('btn-bet').disabled = false;
            document.getElementById('btn-bet').innerHTML = '<i class="fas fa-play-circle"></i> PLACE BET';
            
            document.getElementById('mult-val').classList.remove('crash-anim');
            document.getElementById('mult-val').style.color = 'white';
            document.getElementById('mult-val').textContent = '1.00x';
            
            // Generate new round
            gameState.roundId = 'crash_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            gameState.crashPoint = generateCrashPoint();
            
            let countdown = GAME_CONFIG.LOBBY_TIME / 1000;
            const countdownInterval = setInterval(() => {
                document.getElementById('game-status').textContent = `Next round in ${countdown.toFixed(1)}s`;
                countdown -= 0.1;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startRound();
                }
            }, 100);
            
            // Update current bets display
            document.getElementById('current-bets').textContent = 'Your Bets: None';
            
            // Generate some fake bets for demonstration
            generateFakeBets();
        }

        function startRound() {
            gameState.isWaiting = false;
            gameState.isPlaying = true;
            gameState.startTime = Date.now();
            gameState.hasCashedOut = false;
            
            document.getElementById('game-status').textContent = "FLYING...";
            
            // Start flying sound
            SFX.flying.play();
            
            // If player has bets, show cashout button
            if (gameState.playerBets.length > 0) {
                document.getElementById('btn-bet').style.display = 'none';
                document.getElementById('btn-cashout').style.display = 'block';
                document.getElementById('btn-cashout').disabled = false;
            }
        }

        // ===== GAME LOOP =====
        function gameLoop() {
            // Clear canvas
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            if (gameState.isPlaying) {
                // Calculate multiplier
                const elapsed = Date.now() - gameState.startTime;
                gameState.multiplier = Math.pow(Math.E, GAME_CONFIG.GROWTH_RATE * elapsed);
                
                // Update display
                document.getElementById('mult-val').textContent = gameState.multiplier.toFixed(2) + 'x';
                
                // Check for auto-cashout
                checkAutoCashout();
                
                // Draw game graphics
                drawGameGraphics(elapsed);
                
                // Check for crash
                if (gameState.multiplier >= gameState.crashPoint) {
                    crashRound();
                }
            }
            
            // Continue loop
            requestAnimationFrame(gameLoop);
        }

        function drawGameGraphics(elapsed) {
            const width = gameCanvas.width;
            const height = gameCanvas.height;
            
            // Draw background gradient
            const gradient = gameCtx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, 'rgba(16, 20, 37, 0.8)');
            gradient.addColorStop(1, 'rgba(9, 12, 24, 0.9)');
            gameCtx.fillStyle = gradient;
            gameCtx.fillRect(0, 0, width, height);
            
            // Draw grid
            gameCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            gameCtx.lineWidth = 1;
            
            // Vertical lines
            for (let x = 0; x <= width; x += width / 10) {
                gameCtx.beginPath();
                gameCtx.moveTo(x, 0);
                gameCtx.lineTo(x, height);
                gameCtx.stroke();
            }
            
            // Horizontal lines
            for (let y = 0; y <= height; y += height / 10) {
                gameCtx.beginPath();
                gameCtx.moveTo(0, y);
                gameCtx.lineTo(width, y);
                gameCtx.stroke();
            }
            
            // Draw multiplier line
            const maxMult = Math.max(gameState.crashPoint, 10);
            const xProgress = Math.min(elapsed / 20000, 1);
            const x = 50 + (width - 100) * xProgress;
            const y = height - 50 - (Math.log(gameState.multiplier) / Math.log(maxMult)) * (height - 100);
            
            // Line gradient
            const lineGradient = gameCtx.createLinearGradient(50, height - 50, x, y);
            lineGradient.addColorStop(0, getColorForMultiplier(1));
            lineGradient.addColorStop(1, getColorForMultiplier(gameState.multiplier));
            
            gameCtx.strokeStyle = lineGradient;
            gameCtx.lineWidth = 4;
            gameCtx.lineCap = 'round';
            
            // Add glow effect
            gameCtx.shadowBlur = 15;
            gameCtx.shadowColor = getColorForMultiplier(gameState.multiplier);
            
            gameCtx.beginPath();
            gameCtx.moveTo(50, height - 50);
            
            // Create curved path
            const cp1x = 50 + (x - 50) * 0.3;
            const cp1y = height - 50;
            const cp2x = 50 + (x - 50) * 0.7;
            const cp2y = y;
            
            gameCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x, y);
            gameCtx.stroke();
            
            // Reset shadow
            gameCtx.shadowBlur = 0;
            
            // Draw current point
            gameCtx.fillStyle = 'white';
            gameCtx.beginPath();
            gameCtx.arc(x, y, 8, 0, Math.PI * 2);
            gameCtx.fill();
            
            // Draw inner point
            gameCtx.fillStyle = getColorForMultiplier(gameState.multiplier);
            gameCtx.beginPath();
            gameCtx.arc(x, y, 5, 0, Math.PI * 2);
            gameCtx.fill();
            
            // Draw trail particles
            if (Math.random() > 0.7) {
                gameState.particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * 3 + 1,
                    speedX: (Math.random() - 0.5) * 2,
                    speedY: (Math.random() - 0.5) * 2,
                    color: getColorForMultiplier(gameState.multiplier),
                    alpha: 1,
                    life: 1
                });
            }
            
            // Update and draw particles
            gameState.particles.forEach((particle, index) => {
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                particle.alpha -= 0.02;
                particle.life -= 0.02;
                
                if (particle.life <= 0) {
                    gameState.particles.splice(index, 1);
                    return;
                }
                
                gameCtx.globalAlpha = particle.alpha;
                gameCtx.fillStyle = particle.color;
                gameCtx.beginPath();
                gameCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                gameCtx.fill();
            });
            
            gameCtx.globalAlpha = 1;
            
            // Draw multiplier markers
            const markers = [1, 2, 5, 10, 20, 50];
            markers.forEach(mult => {
                if (mult <= maxMult) {
                    const markerY = height - 50 - (Math.log(mult) / Math.log(maxMult)) * (height - 100);
                    gameCtx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    gameCtx.setLineDash([5, 5]);
                    gameCtx.beginPath();
                    gameCtx.moveTo(50, markerY);
                    gameCtx.lineTo(width - 50, markerY);
                    gameCtx.stroke();
                    gameCtx.setLineDash([]);
                    
                    gameCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    gameCtx.font = '12px Arial';
                    gameCtx.textAlign = 'left';
                    gameCtx.fillText(mult + 'x', 10, markerY + 4);
                }
            });
        }

        function getColorForMultiplier(multiplier) {
            if (multiplier < 2) return '#00f2ff';
            if (multiplier < 5) return '#00ff88';
            if (multiplier < 10) return '#ffbe00';
            if (multiplier < 20) return '#ff6b00';
            return '#ff00ff';
        }

        // ===== PARTICLE BACKGROUND =====
        function animateParticles() {
            particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            
            // Create new particles randomly
            if (Math.random() > 0.7) {
                const x = Math.random() * particleCanvas.width;
                const y = Math.random() * particleCanvas.height;
                const size = Math.random() * 2 + 1;
                const speed = Math.random() * 0.5 + 0.1;
                const color = `rgba(${Math.random() * 100 + 155}, ${Math.random() * 100 + 155}, 255, ${Math.random() * 0.3 + 0.1})`;
                
                gameState.backgroundParticles = gameState.backgroundParticles || [];
                gameState.backgroundParticles.push({
                    x, y, size, speed, color,
                    direction: Math.random() * Math.PI * 2
                });
            }
            
            // Update and draw background particles
            if (gameState.backgroundParticles) {
                gameState.backgroundParticles.forEach((particle, index) => {
                    particle.x += Math.cos(particle.direction) * particle.speed;
                    particle.y += Math.sin(particle.direction) * particle.speed;
                    
                    // Wrap around screen
                    if (particle.x < 0) particle.x = particleCanvas.width;
                    if (particle.x > particleCanvas.width) particle.x = 0;
                    if (particle.y < 0) particle.y = particleCanvas.height;
                    if (particle.y > particleCanvas.height) particle.y = 0;
                    
                    particleCtx.fillStyle = particle.color;
                    particleCtx.beginPath();
                    particleCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particleCtx.fill();
                    
                    // Remove old particles
                    if (particle.size < 0.1) {
                        gameState.backgroundParticles.splice(index, 1);
                    }
                });
            }
            
            requestAnimationFrame(animateParticles);
        }

        // ===== GAME ACTIONS =====
        function setupEventListeners() {
            // Bet button
            document.getElementById('btn-bet').addEventListener('click', placeBet);
            
            // Cashout button
            document.getElementById('btn-cashout').addEventListener('click', cashout);
            
            // Multi bet button
            document.getElementById('btn-multi-bet').addEventListener('click', addMultiBet);
            
            // Quick bet amounts
            document.querySelectorAll('.quick-bet[data-amount]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const amount = parseFloat(btn.dataset.amount);
                    document.getElementById('input-amount').value = amount.toFixed(2);
                });
            });
            
            // Quick multiplier amounts
            document.querySelectorAll('.quick-bet[data-multiplier]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const multiplier = parseFloat(btn.dataset.multiplier);
                    document.getElementById('input-auto').value = multiplier.toFixed(2);
                });
            });
            
            // Input validation
            document.getElementById('input-amount').addEventListener('input', (e) => {
                let value = parseFloat(e.target.value) || 0;
                if (value < GAME_CONFIG.MIN_BET) value = GAME_CONFIG.MIN_BET;
                if (value > GAME_CONFIG.MAX_BET) value = GAME_CONFIG.MAX_BET;
                e.target.value = value.toFixed(2);
            });
        }

        async function placeBet() {
            if (gameState.isPlaying || gameState.isWaiting) {
                showToast('Cannot bet during game round', 'warning');
                return;
            }
            
            const amount = parseFloat(document.getElementById('input-amount').value);
            
            // Validation
            if (amount < GAME_CONFIG.MIN_BET) {
                showToast(`Minimum bet is $${GAME_CONFIG.MIN_BET}`, 'error');
                return;
            }
            
            if (amount > GAME_CONFIG.MAX_BET) {
                showToast(`Maximum bet is $${GAME_CONFIG.MAX_BET}`, 'error');
                return;
            }
            
            if (amount > gameState.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            // Process transaction
            const result = await processBetTransaction(amount, "crash_bet");
            
            if (!result.success) {
                showToast('Bet failed: ' + result.error, 'error');
                return;
            }
            
            // Add bet to player's bets
            const autoCashout = parseFloat(document.getElementById('input-auto').value) || 0;
            const bet = {
                id: 'bet_' + Date.now(),
                amount: amount,
                autoCashout: autoCashout,
                placedAt: new Date(),
                roundId: gameState.roundId,
                status: 'active'
            };
            
            gameState.playerBets.push(bet);
            
            // Update UI
            updateCurrentBetsDisplay();
            SFX.bet.play();
            
            // Show success
            showToast(`Bet placed: $${amount.toFixed(2)}`, 'success');
            
            // If game is about to start, show cashout button
            if (!gameState.isWaiting) {
                document.getElementById('btn-bet').style.display = 'none';
                document.getElementById('btn-cashout').style.display = 'block';
            }
            
            // Save bet to Firebase
            await saveBetToFirebase(bet);
        }

        async function cashout() {
            if (!gameState.isPlaying || gameState.hasCashedOut) {
                showToast('Cannot cashout now', 'warning');
                return;
            }
            
            const totalBetAmount = gameState.playerBets.reduce((sum, bet) => sum + bet.amount, 0);
            const winAmount = totalBetAmount * gameState.multiplier;
            
            // Check max payout
            if (winAmount > GAME_CONFIG.MAX_PAYOUT) {
                showToast('Win amount exceeds maximum payout', 'warning');
                return;
            }
            
            // Process win transaction
            const result = await processBetTransaction(winAmount, "crash_win");
            
            if (!result.success) {
                showToast('Cashout failed: ' + result.error, 'error');
                return;
            }
            
            // Update game state
            gameState.hasCashedOut = true;
            gameState.playerBets = [];
            
            // Update UI
            document.getElementById('btn-cashout').disabled = true;
            document.getElementById('btn-cashout').innerHTML = '<i class="fas fa-check"></i> CASHED OUT';
            document.getElementById('mult-val').style.color = getColorForMultiplier(gameState.multiplier);
            document.getElementById('mult-val').classList.add('pulse');
            
            // Play win sound
            SFX.win.play();
            SFX.flying.stop();
            
            // Show success
            showToast(`Cashed out at ${gameState.multiplier.toFixed(2)}x! Won $${winAmount.toFixed(2)}`, 'success');
            
            // Add to history
            addToHistory(gameState.multiplier, winAmount);
            
            // Update current bets
            document.getElementById('current-bets').textContent = 'Your Bets: CASHED OUT';
            
            // Mark bets as completed in Firebase
            await updateBetsStatus('cashed_out', gameState.multiplier);
        }

        function addMultiBet() {
            showToast('Multi-bet feature coming soon!', 'info');
            // Implementation for multiple concurrent bets
        }

        function checkAutoCashout() {
            if (!gameState.isPlaying || gameState.hasCashedOut) return;
            
            const autoCashout = parseFloat(document.getElementById('input-auto').value);
            if (autoCashout && gameState.multiplier >= autoCashout) {
                cashout();
            }
        }

        function crashRound() {
            gameState.isPlaying = false;
            gameState.hasCashedOut = false;
            
            // Stop sounds
            SFX.flying.stop();
            SFX.crash.play();
            
            // Update UI
            document.getElementById('mult-val').classList.add('crash-anim');
            document.getElementById('mult-val').style.color = '#ff3e3e';
            document.getElementById('game-status').textContent = 'CRASHED!';
            
            // Handle player losses
            if (gameState.playerBets.length > 0 && !gameState.hasCashedOut) {
                gameState.playerBets = [];
                document.getElementById('current-bets').textContent = 'Your Bets: LOST';
                showToast(`Crashed at ${gameState.multiplier.toFixed(2)}x - Bet lost`, 'error');
                
                // Update bets status
                updateBetsStatus('lost', gameState.multiplier);
            }
            
            // Add to history
            addToHistory(gameState.multiplier, 0);
            
            // Start new round after delay
            setTimeout(() => {
                runLobby();
            }, 3000);
        }

        // ===== FIREBASE INTEGRATION =====
        async function saveBetToFirebase(bet) {
            try {
                await db.collection('crash_bets').doc(bet.id).set({
                    userId: gameState.currentUser.uid,
                    userName: gameState.currentUser.displayName || gameState.currentUser.email.split('@')[0],
                    amount: bet.amount,
                    autoCashout: bet.autoCashout,
                    roundId: gameState.roundId,
                    placedAt: new Date(),
                    status: 'active',
                    cashoutMultiplier: null,
                    winAmount: null
                });
            } catch (error) {
                console.error('Error saving bet:', error);
            }
        }

        async function updateBetsStatus(status, multiplier = null) {
            try {
                const batch = db.batch();
                
                gameState.playerBets.forEach(bet => {
                    const betRef = db.collection('crash_bets').doc(bet.id);
                    const updateData = {
                        status: status,
                        updatedAt: new Date()
                    };
                    
                    if (status === 'cashed_out' && multiplier) {
                        updateData.cashoutMultiplier = multiplier;
                        updateData.winAmount = bet.amount * multiplier;
                    }
                    
                    batch.update(betRef, updateData);
                });
                
                await batch.commit();
            } catch (error) {
                console.error('Error updating bets:', error);
            }
        }

        function updateLiveBets(snapshot) {
            const liveBetsContainer = document.getElementById('live-bets');
            const activeBets = [];
            
            snapshot.forEach(doc => {
                const bet = doc.data();
                activeBets.push(bet);
            });
            
            // Sort by amount (descending)
            activeBets.sort((a, b) => b.amount - a.amount);
            
            // Update display
            liveBetsContainer.innerHTML = '';
            activeBets.forEach(bet => {
                const item = document.createElement('div');
                item.className = `bet-item ${bet.status === 'cashed_out' ? 'win' : bet.status === 'lost' ? 'loss' : ''}`;
                item.innerHTML = `
                    <div class="bet-user">${bet.userName}</div>
                    <div class="bet-multiplier">$${bet.amount.toFixed(2)}</div>
                    ${bet.cashoutMultiplier ? `<div class="bet-multiplier">${bet.cashoutMultiplier.toFixed(2)}x</div>` : ''}
                `;
                liveBetsContainer.appendChild(item);
            });
            
            // Update active players count
            document.getElementById('active-players').textContent = activeBets.length;
        }

        // ===== HISTORY & DISPLAY =====
        function addToHistory(multiplier, winAmount) {
            const historyItem = {
                multiplier: multiplier,
                winAmount: winAmount,
                timestamp: new Date()
            };
            
            gameState.history.unshift(historyItem);
            if (gameState.history.length > 20) {
                gameState.history.pop();
            }
            
            updateHistoryDisplay();
            
            // Save to Firebase
            saveHistoryToFirebase(historyItem);
        }

        function updateHistoryDisplay() {
            const historyBar = document.getElementById('history-bar');
            historyBar.innerHTML = '';
            
            gameState.history.slice(0, 15).forEach(item => {
                const tag = document.createElement('div');
                tag.className = 'hist-tag';
                
                let multiplierClass = 'low';
                if (item.multiplier >= 5) multiplierClass = 'medium';
                if (item.multiplier >= 10) multiplierClass = 'high';
                if (item.multiplier >= 50) multiplierClass = 'moon';
                
                tag.classList.add(multiplierClass);
                tag.textContent = item.multiplier.toFixed(2) + 'x';
                tag.title = `Won: $${item.winAmount.toFixed(2)}`;
                
                historyBar.appendChild(tag);
            });
        }

        async function saveHistoryToFirebase(historyItem) {
            try {
                await db.collection('crash_history').add({
                    userId: gameState.currentUser.uid,
                    multiplier: historyItem.multiplier,
                    winAmount: historyItem.winAmount,
                    roundId: gameState.roundId,
                    timestamp: new Date()
                });
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        function updateCurrentBetsDisplay() {
            const totalBet = gameState.playerBets.reduce((sum, bet) => sum + bet.amount, 0);
            const autoCashout = document.getElementById('input-auto').value;
            
            let displayText = `Your Bets: $${totalBet.toFixed(2)}`;
            if (autoCashout && parseFloat(autoCashout) > 0) {
                displayText += ` (Auto: ${autoCashout}x)`;
            }
            
            document.getElementById('current-bets').textContent = displayText;
        }

        function generateFakeBets() {
            const liveBetsContainer = document.getElementById('live-bets');
            liveBetsContainer.innerHTML = '';
            
            const fakeUsers = ['Pro_Player', 'Lucky_One', 'Risk_Taker', 'Safe_Bet', 'Moon_Shot'];
            
            for (let i = 0; i < 8; i++) {
                const user = fakeUsers[Math.floor(Math.random() * fakeUsers.length)];
                const amount = (Math.random() * 500 + 10).toFixed(2);
                const multiplier = Math.random() > 0.7 ? (Math.random() * 10 + 1).toFixed(2) : null;
                
                const item = document.createElement('div');
                item.className = `bet-item ${multiplier ? 'win' : ''}`;
                item.innerHTML = `
                    <div class="bet-user">${user}</div>
                    <div class="bet-multiplier">$${amount}</div>
                    ${multiplier ? `<div class="bet-multiplier">${multiplier}x</div>` : ''}
                `;
                liveBetsContainer.appendChild(item);
            }
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ===== ERROR HANDLING =====
        window.addEventListener('error', (event) => {
            console.error('Game error:', event.error);
            showToast('Game error occurred. Please refresh.', 'error');
        });

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Space to place bet/cashout
            if (e.code === 'Space' && !e.target.matches('input')) {
                e.preventDefault();
                if (gameState.isPlaying && document.getElementById('btn-cashout').style.display !== 'none') {
                    cashout();
                } else if (!gameState.isPlaying && !gameState.isWaiting) {
                    placeBet();
                }
            }
            
            // Ctrl+H for home
            if (e.ctrlKey && e.key === 'h') {
                e.preventDefault();
                window.location.href = 'https://xcrazybet.github.io/millioner';
            }
        });

        // Initialize when window loads
        window.onload = initGame;
    </script>
</body>
</html>
