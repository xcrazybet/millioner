<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Register - London 2020</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== LONDON 2020 STYLE ===== */
        :root {
            --primary: #ff4081;
            --secondary: #3949ab;
            --accent: #2196f3;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #ff5252;
            --dark: #0f0c29;
            --dark-light: #1a1a2e;
            --text: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Money Animation */
        .money {
            position: fixed;
            font-size: 32px;
            color: gold;
            text-shadow: 0 0 15px gold;
            animation: fall linear infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        /* Main Container */
        .container {
            max-width: 500px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid var(--primary);
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--secondary);
        }
        
        .logo {
            font-size: 36px;
            font-weight: bold;
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .logo::before {
            content: "¬£";
            color: gold;
            font-size: 40px;
            text-shadow: 0 0 20px gold;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Bonus Badge */
        .bonus-badge {
            background: linear-gradient(45deg, var(--primary), var(--warning));
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 64, 129, 0.3);
        }
        
        .bonus-amount {
            font-size: 48px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 64, 129, 0.2);
        }
        
        .form-control.error {
            border-color: var(--danger);
            background: rgba(255, 82, 82, 0.1);
        }
        
        .form-control.success {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }
        
        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        /* Password Strength */
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }
        
        /* Submit Button */
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, var(--primary), var(--warning));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 64, 129, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Status Messages */
        .status-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .status-container.success {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid var(--success);
            display: block;
        }
        
        .status-container.error {
            background: rgba(255, 82, 82, 0.2);
            border: 2px solid var(--danger);
            display: block;
        }
        
        /* Wallet Info */
        .wallet-info {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 64, 129, 0.1);
            border-radius: 10px;
            border: 2px solid var(--primary);
            text-align: center;
        }
        
        .wallet-id {
            font-family: monospace;
            font-size: 18px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
        }
        
        /* Login Link */
        .login-link {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .login-link a:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            .logo {
                font-size: 28px;
            }
            
            .bonus-amount {
                font-size: 36px;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
        
        /* Terms */
        .terms {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }
    </style>
</head>
<body>
    
    <!-- Money Animation -->
    <div id="moneyAnimation"></div>
    
    <!-- Main Container -->
    <div class="container">
        
        <!-- Header -->
        <div class="header">
            <div class="logo">LONDON 2020</div>
            <h1>Create Your Account</h1>
        </div>
        
        <!-- Bonus Badge -->
        <div class="bonus-badge">
            <div>üéÅ WELCOME BONUS</div>
            <div class="bonus-amount">$50</div>
            <div>Instant credit after registration!</div>
        </div>
        
        <!-- Registration Form -->
        <form id="registerForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Choose a username" required>
                <div class="error-message" id="usernameError"></div>
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                <div class="error-message" id="emailError"></div>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Create a password (min. 6 characters)" required minlength="6">
                <div class="password-strength">
                    <div class="strength-bar" id="strengthBar"></div>
                </div>
                <div class="error-message" id="passwordError"></div>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm your password" required>
                <div class="error-message" id="confirmPasswordError"></div>
            </div>
            
            <button type="submit" class="btn-primary" id="submitBtn">
                <span id="btnText">üéØ CREATE ACCOUNT & GET $50</span>
                <div class="loading" id="loadingSpinner" style="display: none;"></div>
            </button>
        </form>
        
        <!-- Status Messages -->
        <div class="status-container" id="statusContainer"></div>
        
        <!-- Wallet Info (Shown after registration) -->
        <div class="wallet-info" id="walletInfo" style="display: none;">
            <h3>üéâ Registration Successful!</h3>
            <p>Your account has been created with <strong>$50 bonus</strong>!</p>
            <p>Wallet ID:</p>
            <div class="wallet-id" id="walletIdDisplay"></div>
            <p>You can now login and start playing!</p>
        </div>
        
        <!-- Terms -->
        <div class="terms">
            By registering, you agree to our Terms of Service and Privacy Policy.
            You must be 18+ to register.
        </div>
        
        <!-- Login Link -->
        <div class="login-link">
            <p>Already have an account? <a href="login.html">Login here</a></p>
        </div>
        
    </div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962"
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                
                console.log("‚úÖ Firebase initialized for registration");
                
                // Create money animation
                createMoneyAnimation();
                
                // Setup event listeners
                setupEventListeners(auth, db);
                
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showStatus("Failed to initialize. Please refresh the page.", "error");
            }
        });
        
        // ===== MONEY ANIMATION =====
        function createMoneyAnimation() {
            const container = document.getElementById('moneyAnimation');
            const symbols = ['üí∞', 'üíµ', 'üí∏', 'ü™ô', 'üíé'];
            
            for (let i = 0; i < 15; i++) {
                const money = document.createElement('div');
                money.className = 'money';
                money.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                money.style.left = Math.random() * 100 + 'vw';
                money.style.animationDuration = (Math.random() * 15 + 10) + 's';
                money.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(money);
            }
        }
        
        // ===== EVENT LISTENERS =====
        function setupEventListeners(auth, db) {
            const form = document.getElementById('registerForm');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // Password strength indicator
            passwordInput.addEventListener('input', function() {
                checkPasswordStrength(this.value);
                validatePasswordMatch();
            });
            
            // Confirm password validation
            confirmPasswordInput.addEventListener('input', validatePasswordMatch);
            
            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleRegistration(auth, db);
            });
        }
        
        // ===== PASSWORD STRENGTH CHECK =====
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('strengthBar');
            let strength = 0;
            
            // Length check
            if (password.length >= 6) strength += 20;
            if (password.length >= 8) strength += 20;
            
            // Complexity checks
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 20;
            if (/[^A-Za-z0-9]/.test(password)) strength += 20;
            
            // Update strength bar
            strengthBar.style.width = Math.min(strength, 100) + '%';
            
            // Color coding
            if (strength < 40) {
                strengthBar.style.backgroundColor = '#ff5252'; // Red
            } else if (strength < 70) {
                strengthBar.style.backgroundColor = '#ff9800'; // Orange
            } else {
                strengthBar.style.backgroundColor = '#4caf50'; // Green
            }
        }
        
        // ===== PASSWORD MATCH VALIDATION =====
        function validatePasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('confirmPasswordError');
            
            if (confirmPassword && password !== confirmPassword) {
                errorElement.textContent = "Passwords do not match";
                errorElement.style.display = 'block';
                document.getElementById('confirmPassword').classList.add('error');
                return false;
            } else {
                errorElement.style.display = 'none';
                document.getElementById('confirmPassword').classList.remove('error');
                document.getElementById('confirmPassword').classList.add('success');
                return true;
            }
        }
        
        // ===== GENERATE WALLET ID =====
        function generateWalletId(uid) {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 6);
            return `WALLET-${uid.slice(0, 6)}-${timestamp}${randomStr}`.toUpperCase();
        }
        
        // ===== CREATE USER WALLET =====
        async function createUserWallet(db, uid, email, username) {
            try {
                const walletId = generateWalletId(uid);
                const startingBalance = 50; // $50 welcome bonus
                
                // Create wallet data
                const walletData = {
                    userId: uid,
                    walletId: walletId,
                    email: email,
                    username: username,
                    balance: startingBalance,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                // Use batch write for atomic consistency
                const batch = db.batch();
                
                // Create wallet document
                const walletRef = db.collection('wallets').doc(uid);
                batch.set(walletRef, walletData);
                
                // Create welcome transaction in subcollection
                const txRef = walletRef.collection('transactions').doc();
                const txData = {
                    userId: uid,
                    type: 'bonus',
                    amount: 50,
                    description: 'Welcome Bonus',
                    status: 'completed',
                    createdAt: new Date(),
                    newBalance: startingBalance
                };
                batch.set(txRef, txData);
                
                // Commit batch
                await batch.commit();
                
                return { walletId, walletData };
                
            } catch (error) {
                console.error("Wallet creation error:", error);
                throw new Error("Failed to create wallet");
            }
        }
        
        // ===== HANDLE REGISTRATION =====
        async function handleRegistration(auth, db) {
            // Get form values
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Validation
            if (!username || !email || !password) {
                showStatus("Please fill in all fields", "error");
                return;
            }
            
            if (password.length < 6) {
                showStatus("Password must be at least 6 characters", "error");
                return;
            }
            
            if (!validatePasswordMatch()) {
                showStatus("Passwords do not match", "error");
                return;
            }
            
            // Disable submit button and show loading
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'block';
            
            // Clear previous status
            showStatus("", "clear");
            
            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Update display name
                await user.updateProfile({
                    displayName: username
                });
                
                // Create wallet with $50 bonus
                const walletResult = await createUserWallet(db, user.uid, email, username);
                
                // Try to send verification email (but don't fail if it doesn't work)
                try {
                    await user.sendEmailVerification();
                } catch (emailError) {
                    console.warn("Verification email failed:", emailError);
                }
                
                // Show success
                showStatus("‚úÖ Account created successfully! $50 bonus added!", "success");
                
                // Show wallet info
                document.getElementById('walletIdDisplay').textContent = walletResult.walletId;
                document.getElementById('walletInfo').style.display = 'block';
                
                // Reset form
                document.getElementById('registerForm').reset();
                document.getElementById('strengthBar').style.width = '0%';
                
                // Auto-redirect after 5 seconds
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 5000);
                
            } catch (error) {
                console.error("Registration error:", error);
                
                // User-friendly error messages
                let errorMessage = "Registration failed. Please try again.";
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "Email is already registered. Try logging in.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "Invalid email address.";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "Password is too weak. Use at least 6 characters.";
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = "Registration is temporarily disabled.";
                        break;
                    default:
                        if (error.message.includes('wallet')) {
                            errorMessage = "Account created but wallet setup failed. Please contact support.";
                        }
                }
                
                showStatus(errorMessage, "error");
                
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                btnText.style.display = 'block';
                loadingSpinner.style.display = 'none';
            }
        }
        
        // ===== SHOW STATUS MESSAGE =====
        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            
            if (!message || type === 'clear') {
                container.style.display = 'none';
                container.className = 'status-container';
                return;
            }
            
            container.textContent = message;
            container.className = `status-container ${type}`;
            container.style.display = 'block';
            
            // Auto-hide success messages after 10 seconds
            if (type === 'success') {
                setTimeout(() => {
                    container.style.display = 'none';
                }, 10000);
            }
        }
    </script>
</body>
</html>
