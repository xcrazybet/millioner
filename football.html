<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Betting - Millioner</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <!-- Toastify for notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
        }

        /* Header */
        .header {
            background: rgba(15, 23, 42, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid #4361ee;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #4cc9f0;
        }

        .logo span {
            color: #f72585;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-email {
            color: #94a3b8;
            font-size: 14px;
        }

        .balance-card {
            background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
            padding: 12px 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
            min-width: 200px;
        }

        .balance-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .balance-info h3 {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 24px;
            font-weight: bold;
            color: white;
            font-family: 'Courier New', monospace;
        }

        .btn-logout {
            background: #f72585;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-logout:hover {
            background: #e01e76;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.4);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Page Title */
        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .page-title p {
            color: #94a3b8;
            font-size: 16px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(30, 41, 59, 0.8);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
            color: white;
        }

        /* Matches Grid */
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        /* Match Card */
        .match-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(67, 97, 238, 0.2);
            border-color: #4361ee;
        }

        .match-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .match-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .match-time {
            color: #94a3b8;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }

        .team {
            text-align: center;
            flex: 1;
        }

        .team-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        .team-flag {
            font-size: 48px;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .vs {
            color: #f72585;
            font-weight: bold;
            font-size: 18px;
            margin: 0 20px;
            background: rgba(247, 37, 133, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
        }

        /* Betting Options */
        .bet-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .bet-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bet-option:hover {
            background: rgba(67, 97, 238, 0.1);
            border-color: #4361ee;
        }

        .bet-option.selected {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.2) 0%, rgba(67, 97, 238, 0.1) 100%);
            border-color: #4361ee;
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .bet-team {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .bet-odds {
            font-size: 24px;
            font-weight: bold;
            color: #4cc9f0;
            margin-bottom: 5px;
        }

        .bet-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        /* Bet Amount Input */
        .bet-amount-section {
            margin-bottom: 25px;
        }

        .bet-amount-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .bet-amount-label span {
            color: #94a3b8;
            font-size: 14px;
        }

        .max-balance {
            color: #4cc9f0;
            cursor: pointer;
            font-weight: 600;
            transition: color 0.3s;
        }

        .max-balance:hover {
            color: #3a56d4;
        }

        .bet-amount-input {
            width: 100%;
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }

        .bet-amount-input:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
        }

        .quick-bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-bet-btn {
            flex: 1;
            padding: 12px;
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            border-radius: 8px;
            color: #4cc9f0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .quick-bet-btn:hover {
            background: rgba(67, 97, 238, 0.2);
        }

        /* Bet Button */
        .bet-button {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .bet-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
        }

        .bet-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Potential Win */
        .potential-win {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(76, 201, 240, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .potential-win-label {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .potential-win-amount {
            font-size: 24px;
            font-weight: bold;
            color: #4cc9f0;
            font-family: 'Courier New', monospace;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #94a3b8;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #4361ee;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .user-info {
                flex-direction: column;
                width: 100%;
            }
            
            .balance-card {
                width: 100%;
                justify-content: center;
            }
            
            .btn-logout {
                width: 100%;
            }
            
            .matches-grid {
                grid-template-columns: 1fr;
            }
            
            .bet-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <i class="fas fa-futbol"></i> MILLIONER <span>FOOTBALL</span>
        </div>
        
        <div class="user-info">
            <div class="user-email" id="userEmail">Loading...</div>
            
            <div class="balance-card">
                <div class="balance-icon">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="balance-info">
                    <h3>YOUR BALANCE</h3>
                    <div class="balance-amount" id="userBalance">$0.00</div>
                </div>
            </div>
            
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Title -->
        <div class="page-title">
            <h1>FOOTBALL BETTING</h1>
            <p>Place your bets on upcoming football matches</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showMatches('upcoming')">
                <i class="fas fa-clock"></i> Upcoming Matches
            </button>
            <button class="tab" onclick="showMatches('live')">
                <i class="fas fa-play-circle"></i> Live Matches
            </button>
            <button class="tab" onclick="showMatches('completed')">
                <i class="fas fa-check-circle"></i> Completed
            </button>
            <button class="tab" onclick="showBets()">
                <i class="fas fa-history"></i> My Bets
            </button>
        </div>

        <!-- Matches Container -->
        <div id="matchesContainer" class="matches-grid">
            <!-- Matches will be loaded here -->
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading matches...</p>
            </div>
        </div>

        <!-- My Bets Container (Hidden by default) -->
        <div id="betsContainer" class="matches-grid" style="display: none;">
            <!-- User's bets will be loaded here -->
        </div>
    </div>

    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // ====================
        // FIREBASE CONFIG
        // ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.appspot.com",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ====================
        // GLOBAL VARIABLES
        // ====================
        let currentUser = null;
        let userBalance = 0;
        let currentMatches = [];
        let userBets = [];
        let selectedMatches = {}; // Track selected bets per match

        // ====================
        // UTILITY FUNCTIONS
        // ====================
        function showToast(type, message) {
            const colors = {
                success: "#4cc9f0",
                error: "#f72585",
                warning: "#f8961e",
                info: "#4361ee"
            };

            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: colors[type],
                stopOnFocus: true
            }).showToast();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0);
        }

        function formatDate(timestamp) {
            if (!timestamp) return "TBA";
            if (timestamp.toDate) timestamp = timestamp.toDate();
            
            const now = new Date();
            const matchDate = new Date(timestamp);
            
            // If today, show time
            if (matchDate.toDateString() === now.toDateString()) {
                return `Today, ${matchDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }
            
            // If tomorrow
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            if (matchDate.toDateString() === tomorrow.toDateString()) {
                return `Tomorrow, ${matchDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }
            
            // Otherwise show date and time
            return matchDate.toLocaleString([], {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ====================
        // AUTHENTICATION
        // ====================
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html'; // Change to your login page
            } else {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                await loadUserBalance();
                await loadFootballMatches('upcoming');
                await loadUserBets();
            }
        });

        async function loadUserBalance() {
            try {
                const walletDoc = await db.collection('wallets').doc(currentUser.uid).get();
                if (walletDoc.exists) {
                    const wallet = walletDoc.data();
                    userBalance = wallet.balance || 0;
                    document.getElementById('userBalance').textContent = formatCurrency(userBalance);
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                showToast('error', 'Failed to load balance');
            }
        }

        // ====================
        // MATCHES MANAGEMENT
        // ====================
        async function loadFootballMatches(status = 'upcoming') {
            try {
                const container = document.getElementById('matchesContainer');
                container.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading ${status} matches...</p>
                    </div>
                `;

                let query = db.collection('football_matches');
                
                if (status !== 'all') {
                    query = query.where('status', '==', status);
                }
                
                const snapshot = await query.orderBy('matchTime', 'asc').get();
                
                currentMatches = [];
                snapshot.forEach(doc => {
                    currentMatches.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderMatches(currentMatches);
                
            } catch (error) {
                console.error('Error loading matches:', error);
                showToast('error', 'Failed to load matches');
                document.getElementById('matchesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load matches. Please try again.</p>
                    </div>
                `;
            }
        }

        function renderMatches(matches) {
            const container = document.getElementById('matchesContainer');
            
            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-futbol"></i>
                        <p>No matches available</p>
                        <p style="font-size: 14px; margin-top: 10px;">Check back later for new matches!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            matches.forEach(match => {
                const selectedBet = selectedMatches[match.id];
                
                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                matchCard.innerHTML = `
                    <div class="match-header">
                        <div class="match-title">
                            <i class="fas fa-trophy"></i>
                            ${match.league || 'PREMIER LEAGUE'}
                        </div>
                        <div class="match-time">
                            <i class="fas fa-calendar-alt"></i>
                            ${formatDate(match.matchTime)}
                        </div>
                    </div>
                    
                    <div class="match-teams">
                        <div class="team">
                            <div class="team-flag">${match.team1Flag || 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø'}</div>
                            <div class="team-name">${match.team1}</div>
                        </div>
                        
                        <div class="vs">VS</div>
                        
                        <div class="team">
                            <div class="team-flag">${match.team2Flag || 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø'}</div>
                            <div class="team-name">${match.team2}</div>
                        </div>
                    </div>
                    
                    <div class="bet-options">
                        <div class="bet-option ${selectedBet === 'team1' ? 'selected' : ''}" 
                             onclick="selectBet('${match.id}', 'team1', ${match.odds1})">
                            <div class="bet-team">${match.team1}</div>
                            <div class="bet-odds">${match.odds1.toFixed(2)}</div>
                            <div class="bet-label">HOME WIN</div>
                        </div>
                        
                        <div class="bet-option ${selectedBet === 'draw' ? 'selected' : ''}" 
                             onclick="selectBet('${match.id}', 'draw', ${match.oddsDraw})">
                            <div class="bet-team">DRAW</div>
                            <div class="bet-odds">${match.oddsDraw.toFixed(2)}</div>
                            <div class="bet-label">DRAW</div>
                        </div>
                        
                        <div class="bet-option ${selectedBet === 'team2' ? 'selected' : ''}" 
                             onclick="selectBet('${match.id}', 'team2', ${match.odds2})">
                            <div class="bet-team">${match.team2}</div>
                            <div class="bet-odds">${match.odds2.toFixed(2)}</div>
                            <div class="bet-label">AWAY WIN</div>
                        </div>
                    </div>
                    
                    <div class="bet-amount-section">
                        <div class="bet-amount-label">
                            <span>BET AMOUNT</span>
                            <span class="max-balance" onclick="setMaxAmount('${match.id}')">
                                Max: ${formatCurrency(userBalance)}
                            </span>
                        </div>
                        <input type="number" 
                               id="betAmount_${match.id}" 
                               class="bet-amount-input" 
                               placeholder="Enter amount"
                               min="1"
                               max="${userBalance}"
                               step="0.01"
                               oninput="updatePotentialWin('${match.id}')"
                               value="${selectedBet ? selectedBet.amount || '' : ''}">
                        
                        <div class="quick-bet-buttons">
                            <button class="quick-bet-btn" onclick="setQuickAmount('${match.id}', 10)">$10</button>
                            <button class="quick-bet-btn" onclick="setQuickAmount('${match.id}', 50)">$50</button>
                            <button class="quick-bet-btn" onclick="setQuickAmount('${match.id}', 100)">$100</button>
                            <button class="quick-bet-btn" onclick="setQuickAmount('${match.id}', 500)">$500</button>
                        </div>
                    </div>
                    
                    ${selectedBet ? `
                    <div class="potential-win">
                        <div class="potential-win-label">POTENTIAL WIN</div>
                        <div class="potential-win-amount" id="potentialWin_${match.id}">
                            ${formatCurrency(selectedBet.amount * selectedBet.odds)}
                        </div>
                    </div>
                    ` : ''}
                    
                    <button class="bet-button" 
                            onclick="placeBet('${match.id}')"
                            ${!selectedBet || !selectedBet.amount ? 'disabled' : ''}
                            id="betButton_${match.id}">
                        <i class="fas fa-coins"></i>
                        ${selectedBet ? `BET ${formatCurrency(selectedBet.amount)}` : 'SELECT BET TO CONTINUE'}
                    </button>
                `;
                
                container.appendChild(matchCard);
            });
        }

        // ====================
        // BETTING FUNCTIONS
        // ====================
        function selectBet(matchId, betOn, odds) {
            const match = currentMatches.find(m => m.id === matchId);
            if (!match) return;

            // Update selection
            selectedMatches[matchId] = {
                betOn: betOn,
                odds: odds,
                team: betOn === 'team1' ? match.team1 : betOn === 'team2' ? match.team2 : 'Draw'
            };

            // Re-render matches
            renderMatches(currentMatches);
            
            // Update bet amount input focus
            setTimeout(() => {
                const input = document.getElementById(`betAmount_${matchId}`);
                if (input) input.focus();
            }, 100);
        }

        function setQuickAmount(matchId, amount) {
            if (!selectedMatches[matchId]) {
                showToast('warning', 'Please select a bet option first');
                return;
            }

            if (amount > userBalance) {
                showToast('error', 'Insufficient balance');
                return;
            }

            selectedMatches[matchId].amount = amount;
            updatePotentialWin(matchId);
            
            // Update UI
            document.getElementById(`betAmount_${matchId}`).value = amount;
            document.getElementById(`betButton_${matchId}`).disabled = false;
            document.getElementById(`betButton_${matchId}`).innerHTML = `
                <i class="fas fa-coins"></i> BET ${formatCurrency(amount)}
            `;
        }

        function setMaxAmount(matchId) {
            if (!selectedMatches[matchId]) {
                showToast('warning', 'Please select a bet option first');
                return;
            }

            if (userBalance <= 0) {
                showToast('error', 'Insufficient balance');
                return;
            }

            selectedMatches[matchId].amount = userBalance;
            updatePotentialWin(matchId);
            
            // Update UI
            document.getElementById(`betAmount_${matchId}`).value = userBalance;
            document.getElementById(`betButton_${matchId}`).disabled = false;
            document.getElementById(`betButton_${matchId}`).innerHTML = `
                <i class="fas fa-coins"></i> BET ${formatCurrency(userBalance)}
            `;
        }

        function updatePotentialWin(matchId) {
            const input = document.getElementById(`betAmount_${matchId}`);
            if (!input) return;

            const amount = parseFloat(input.value);
            const selectedBet = selectedMatches[matchId];

            if (!selectedBet || !amount || amount <= 0) {
                // Hide potential win if no valid amount
                const potentialWinDiv = document.querySelector(`#potentialWin_${matchId}`);
                if (potentialWinDiv) {
                    potentialWinDiv.closest('.potential-win').style.display = 'none';
                }
                document.getElementById(`betButton_${matchId}`).disabled = true;
                document.getElementById(`betButton_${matchId}`).innerHTML = `
                    <i class="fas fa-coins"></i> SELECT BET TO CONTINUE
                `;
                return;
            }

            if (amount > userBalance) {
                showToast('error', 'Amount exceeds your balance');
                input.value = '';
                return;
            }

            // Update selected bet
            selectedBet.amount = amount;
            
            // Calculate potential win
            const potentialWin = amount * selectedBet.odds;
            
            // Update potential win display
            let potentialWinDiv = document.querySelector(`#potentialWin_${matchId}`);
            if (!potentialWinDiv) {
                // Create potential win section if it doesn't exist
                const matchCard = input.closest('.match-card');
                const betButton = document.getElementById(`betButton_${matchId}`);
                const potentialWinHTML = `
                    <div class="potential-win">
                        <div class="potential-win-label">POTENTIAL WIN</div>
                        <div class="potential-win-amount" id="potentialWin_${matchId}">
                            ${formatCurrency(potentialWin)}
                        </div>
                    </div>
                `;
                betButton.insertAdjacentHTML('beforebegin', potentialWinHTML);
            } else {
                potentialWinDiv.textContent = formatCurrency(potentialWin);
                potentialWinDiv.closest('.potential-win').style.display = 'block';
            }

            // Enable bet button
            document.getElementById(`betButton_${matchId}`).disabled = false;
            document.getElementById(`betButton_${matchId}`).innerHTML = `
                <i class="fas fa-coins"></i> BET ${formatCurrency(amount)}
            `;
        }

        async function placeBet(matchId) {
            const selectedBet = selectedMatches[matchId];
            const match = currentMatches.find(m => m.id === matchId);

            if (!selectedBet || !selectedBet.amount) {
                showToast('error', 'Please select a bet and enter amount');
                return;
            }

            if (selectedBet.amount > userBalance) {
                showToast('error', 'Insufficient balance');
                return;
            }

            // Confirm bet
            const betAmount = selectedBet.amount;
            const potentialWin = betAmount * selectedBet.odds;
            
            if (!confirm(`Confirm bet of ${formatCurrency(betAmount)} on ${selectedBet.team}?\n\nPotential win: ${formatCurrency(potentialWin)}`)) {
                return;
            }

            try {
                // Use transaction for atomic operations
                await db.runTransaction(async (transaction) => {
                    // Get user wallet
                    const walletRef = db.collection('wallets').doc(currentUser.uid);
                    const walletDoc = await transaction.get(walletRef);
                    
                    if (!walletDoc.exists) {
                        throw new Error('User wallet not found');
                    }

                    const currentBalance = walletDoc.data().balance || 0;
                    
                    if (currentBalance < betAmount) {
                        throw new Error('Insufficient balance');
                    }

                    // Update user balance
                    const newBalance = currentBalance - betAmount;
                    transaction.update(walletRef, {
                        balance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Create bet record
                    const betRef = db.collection('bets').doc();
                    transaction.set(betRef, {
                        userId: currentUser.uid,
                        matchId: matchId,
                        matchTitle: `${match.team1} vs ${match.team2}`,
                        betOn: selectedBet.betOn,
                        team: selectedBet.team,
                        amount: betAmount,
                        odds: selectedBet.odds,
                        potentialWin: potentialWin,
                        status: 'pending',
                        placedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        matchTime: match.matchTime
                    });

                    // Create transaction record
                    const txRef = db.collection('transactions').doc();
                    transaction.set(txRef, {
                        userId: currentUser.uid,
                        type: 'bet_placed',
                        amount: betAmount,
                        previousBalance: currentBalance,
                        newBalance: newBalance,
                        details: {
                            matchId: matchId,
                            match: `${match.team1} vs ${match.team2}`,
                            betOn: selectedBet.betOn,
                            odds: selectedBet.odds,
                            potentialWin: potentialWin
                        },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'completed'
                    });
                });

                // Update local balance
                userBalance -= betAmount;
                document.getElementById('userBalance').textContent = formatCurrency(userBalance);
                
                // Clear selection
                delete selectedMatches[matchId];
                
                // Reload user bets
                await loadUserBets();
                
                // Show success message
                showToast('success', `Bet placed successfully! Good luck!`);
                
                // Re-render matches
                renderMatches(currentMatches);
                
            } catch (error) {
                console.error('Error placing bet:', error);
                showToast('error', `Failed to place bet: ${error.message}`);
            }
        }

        // ====================
        // USER BETS MANAGEMENT
        // ====================
        async function loadUserBets() {
            try {
                const snapshot = await db.collection('bets')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('placedAt', 'desc')
                    .limit(20)
                    .get();
                
                userBets = [];
                snapshot.forEach(doc => {
                    userBets.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
            } catch (error) {
                console.error('Error loading bets:', error);
            }
        }

        function showBets() {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show bets container
            document.getElementById('matchesContainer').style.display = 'none';
            const betsContainer = document.getElementById('betsContainer');
            betsContainer.style.display = 'grid';
            
            // Render bets
            renderUserBets();
        }

        function renderUserBets() {
            const container = document.getElementById('betsContainer');
            
            if (userBets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No bets placed yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Place your first bet on upcoming matches!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            userBets.forEach(bet => {
                const statusColor = {
                    'pending': '#f8961e',
                    'won': '#4cc9f0',
                    'lost': '#f72585',
                    'cancelled': '#64748b'
                };

                const betCard = document.createElement('div');
                betCard.className = 'match-card';
                betCard.innerHTML = `
                    <div class="match-header">
                        <div class="match-title">
                            <i class="fas fa-receipt"></i>
                            BET #${bet.id.substring(0, 8)}
                        </div>
                        <div class="match-time">
                            <i class="fas fa-calendar-alt"></i>
                            ${formatDate(bet.placedAt)}
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 20px; font-weight: bold; color: white;">
                                ${bet.matchTitle}
                            </div>
                            <div style="color: #94a3b8; font-size: 14px;">
                                ${formatDate(bet.matchTime)}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #94a3b8;">Bet On:</span>
                                <span style="font-weight: bold; color: #4cc9f0;">${bet.team}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #94a3b8;">Amount:</span>
                                <span style="font-weight: bold; color: white;">${formatCurrency(bet.amount)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #94a3b8;">Odds:</span>
                                <span style="font-weight: bold; color: #f72585;">${bet.odds.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #94a3b8;">Potential Win:</span>
                                <span style="font-weight: bold; color: #4cc9f0;">${formatCurrency(bet.potentialWin)}</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <span style="display: inline-block; padding: 8px 20px; background: ${statusColor[bet.status] || '#64748b'}; 
                                   border-radius: 20px; font-weight: bold; color: white;">
                                ${bet.status.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(betCard);
            });
        }

        // ====================
        // TAB NAVIGATION
        // ====================
        function showMatches(status) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show matches container
            document.getElementById('matchesContainer').style.display = 'grid';
            document.getElementById('betsContainer').style.display = 'none';
            
            // Load matches
            loadFootballMatches(status);
        }

        // ====================
        // INITIALIZATION
        // ====================
        async function initializeFootballMatches() {
            // Create sample matches if they don't exist
            try {
                const matchesSnapshot = await db.collection('football_matches').limit(1).get();
                
                if (matchesSnapshot.empty) {
                    // Create some sample matches
                    const sampleMatches = [
                        {
                            team1: "Manchester City",
                            team2: "Liverpool",
                            team1Flag: "üîµ",
                            team2Flag: "üî¥",
                            odds1: 2.10,
                            oddsDraw: 3.40,
                            odds2: 3.10,
                            league: "PREMIER LEAGUE",
                            status: "upcoming",
                            matchTime: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 24 * 60 * 60 * 1000))
                        },
                        {
                            team1: "Real Madrid",
                            team2: "Barcelona",
                            team1Flag: "‚ö™",
                            team2Flag: "üîµüî¥",
                            odds1: 2.30,
                            oddsDraw: 3.25,
                            odds2: 2.90,
                            league: "LA LIGA",
                            status: "upcoming",
                            matchTime: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 2 * 24 * 60 * 60 * 1000))
                        },
                        {
                            team1: "Bayern Munich",
                            team2: "Borussia Dortmund",
                            team1Flag: "üî¥",
                            team2Flag: "üü°",
                            odds1: 1.80,
                            oddsDraw: 3.60,
                            odds2: 4.20,
                            league: "BUNDESLIGA",
                            status: "upcoming",
                            matchTime: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 3 * 24 * 60 * 60 * 1000))
                        },
                        {
                            team1: "PSG",
                            team2: "Marseille",
                            team1Flag: "üîµüî¥",
                            team2Flag: "üîµ‚ö™",
                            odds1: 1.65,
                            oddsDraw: 3.80,
                            odds2: 4.50,
                            league: "LIGUE 1",
                            status: "upcoming",
                            matchTime: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 4 * 24 * 60 * 60 * 1000))
                        },
                        {
                            team1: "AC Milan",
                            team2: "Inter Milan",
                            team1Flag: "üî¥‚ö´",
                            team2Flag: "üîµ‚ö´",
                            odds1: 2.70,
                            oddsDraw: 3.10,
                            odds2: 2.50,
                            league: "SERIE A",
                            status: "upcoming",
                            matchTime: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + 5 * 24 * 60 * 60 * 1000))
                        }
                    ];

                    // Add all sample matches
                    for (const match of sampleMatches) {
                        await db.collection('football_matches').add(match);
                    }
                    
                    console.log("Sample matches created successfully");
                }
            } catch (error) {
                console.error("Error creating sample matches:", error);
            }
        }

        // ====================
        // LOGOUT
        // ====================
        function logout() {
            auth.signOut();
            window.location.href = 'index.html'; // Change to your login page
        }

        // ====================
        // INITIALIZE ON LOAD
        // ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize sample matches if needed
            await initializeFootballMatches();
        });
    </script>
</body>
</html>
