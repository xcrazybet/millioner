<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Betting</title>
    
    <!-- Same Firebase SDK as admin -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* Your football game styles */
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .balance-display {
            font-weight: bold;
            color: green;
            font-size: 18px;
        }
        
        .bet-section {
            margin: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="user-info">
        <p>Welcome, <span id="userEmail">Loading...</span></p>
        <p>Balance: <span id="userBalance" class="balance-display">$0.00</span></p>
        <button onclick="logout()">Logout</button>
    </div>
    
    <div class="bet-section">
        <h2>Football Matches</h2>
        <div id="matchesContainer">
            <!-- Matches will be loaded here -->
        </div>
    </div>

    <script>
        // Same Firebase config as admin.html
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.appspot.com",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userBalance = 0;

        // Check authentication
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'login.html'; // Redirect to user login
            } else {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                await loadUserBalance(user.uid);
                await loadFootballMatches();
            }
        });

        async function loadUserBalance(userId) {
            try {
                const walletDoc = await db.collection('wallets').doc(userId).get();
                if (walletDoc.exists) {
                    const wallet = walletDoc.data();
                    userBalance = wallet.balance || 0;
                    document.getElementById('userBalance').textContent = `$${userBalance.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        async function loadFootballMatches() {
            try {
                // Load matches from a collection
                const matchesSnapshot = await db.collection('football_matches')
                    .where('status', '==', 'upcoming')
                    .orderBy('matchTime')
                    .limit(10)
                    .get();
                
                const container = document.getElementById('matchesContainer');
                container.innerHTML = '';
                
                matchesSnapshot.forEach(doc => {
                    const match = doc.data();
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-card';
                    matchDiv.innerHTML = `
                        <h3>${match.team1} vs ${match.team2}</h3>
                        <p>Time: ${new Date(match.matchTime.seconds * 1000).toLocaleString()}</p>
                        <div class="odds">
                            <button onclick="placeBet('${doc.id}', 'team1', ${match.odds1})">
                                ${match.team1} @ ${match.odds1}
                            </button>
                            <button onclick="placeBet('${doc.id}', 'draw', ${match.oddsDraw})">
                                Draw @ ${match.oddsDraw}
                            </button>
                            <button onclick="placeBet('${doc.id}', 'team2', ${match.odds2})">
                                ${match.team2} @ ${match.odds2}
                            </button>
                        </div>
                        <input type="number" id="betAmount_${doc.id}" placeholder="Bet amount" min="1" max="${userBalance}">
                    `;
                    container.appendChild(matchDiv);
                });
            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        async function placeBet(matchId, betOn, odds) {
            const betAmount = parseFloat(document.getElementById(`betAmount_${matchId}`).value);
            
            if (!betAmount || betAmount <= 0) {
                alert('Please enter a valid bet amount');
                return;
            }
            
            if (betAmount > userBalance) {
                alert('Insufficient balance');
                return;
            }
            
            // Confirm bet
            if (!confirm(`Confirm bet of $${betAmount.toFixed(2)} on ${betOn} @ ${odds}?`)) {
                return;
            }
            
            try {
                // Use transaction for atomic operations
                await db.runTransaction(async (transaction) => {
                    // Get user wallet
                    const walletRef = db.collection('wallets').doc(currentUser.uid);
                    const walletDoc = await transaction.get(walletRef);
                    
                    if (!walletDoc.exists || walletDoc.data().balance < betAmount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Update user balance
                    const newBalance = walletDoc.data().balance - betAmount;
                    transaction.update(walletRef, {
                        balance: newBalance,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create bet record
                    const betRef = db.collection('bets').doc();
                    transaction.set(betRef, {
                        userId: currentUser.uid,
                        matchId: matchId,
                        betOn: betOn,
                        amount: betAmount,
                        odds: odds,
                        status: 'pending',
                        potentialWin: betAmount * odds,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Create transaction record
                    const txRef = db.collection('transactions').doc();
                    transaction.set(txRef, {
                        userId: currentUser.uid,
                        type: 'bet_placed',
                        amount: betAmount,
                        previousBalance: walletDoc.data().balance,
                        newBalance: newBalance,
                        details: {
                            matchId: matchId,
                            betOn: betOn,
                            odds: odds
                        },
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'completed'
                    });
                });
                
                // Update local balance
                userBalance -= betAmount;
                document.getElementById('userBalance').textContent = `$${userBalance.toFixed(2)}`;
                
                alert('Bet placed successfully!');
            } catch (error) {
                console.error('Error placing bet:', error);
                alert('Failed to place bet: ' + error.message);
            }
        }

        function logout() {
            auth.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
