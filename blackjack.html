<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>♠️ Professional Blackjack - XCrazyBet</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #00b894;
            --primary-dark: #00a085;
            --secondary: #0984e3;
            --success: #00cec9;
            --danger: #d63031;
            --warning: #fdcb6e;
            --dark-bg: #0f0c29;
            --medium-bg: #1a1a2e;
            --light-bg: #24243e;
            --text: #ffffff;
            --text-secondary: #b0b0b0;
            --chip-1: #ff4081;
            --chip-5: #2196f3;
            --chip-10: #4caf50;
            --chip-25: #ff9800;
            --chip-100: #9c27b0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), var(--light-bg));
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 28px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--medium-bg);
            border-radius: 8px;
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .nav-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--primary);
            border-color: var(--text);
        }

        .balance-display {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Home Button */
        .home-btn {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 20px;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .home-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        /* Main Layout */
        .container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            flex: 0 0 300px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--primary);
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid var(--primary);
            padding-bottom: 8px;
        }

        /* Bet Controls */
        .bet-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .bet-amount-display {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--warning);
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 2px solid var(--warning);
        }

        .bet-input-group {
            display: flex;
            gap: 10px;
        }

        .bet-input {
            flex: 1;
            padding: 15px;
            background: var(--medium-bg);
            border: 2px solid var(--primary);
            border-radius: 10px;
            color: var(--text);
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .bet-input:focus {
            outline: none;
            border-color: var(--warning);
        }

        .chip-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .chip {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid white;
            font-size: 14px;
            margin: 0 auto;
        }

        .chip:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .chip.active {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
            border-color: gold;
        }

        .chip-1 { background: var(--chip-1); }
        .chip-5 { background: var(--chip-5); }
        .chip-10 { background: var(--chip-10); }
        .chip-25 { background: var(--chip-25); }
        .chip-50 { background: #9c27b0; }
        .chip-100 { background: var(--chip-100); }

        /* Game Controls */
        .game-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-deal {
            background: var(--primary);
            color: white;
            grid-column: 1 / -1;
        }

        .btn-hit {
            background: var(--success);
            color: white;
        }

        .btn-stand {
            background: var(--warning);
            color: black;
        }

        .btn-double {
            background: var(--secondary);
            color: white;
        }

        .btn-split {
            background: linear-gradient(45deg, #9c27b0, #673ab7);
            color: white;
        }

        /* Top Winners */
        .winners-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .winner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .winner-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .winner-name {
            font-weight: 500;
            font-size: 14px;
        }

        .winner-amount {
            color: var(--success);
            font-weight: 600;
            font-size: 14px;
        }

        /* Main Game Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Blackjack Table */
        .blackjack-table {
            flex: 1;
            background: radial-gradient(circle, #0a5c36 0%, #05422a 70%, #032017 100%);
            border-radius: 30px;
            border: 15px solid #8b4513;
            box-shadow: 
                0 0 0 10px #654321,
                inset 0 0 50px rgba(0, 0, 0, 0.5),
                0 10px 50px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
        }

        .dealer-area, .player-area {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
        }

        .area-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            min-height: 120px;
            flex-wrap: wrap;
        }

        .score-display {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
            margin-top: 15px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Card Styles */
        .card {
            width: 80px;
            height: 110px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: black;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card.red {
            color: #d50000;
        }

        .card.black {
            color: #000;
        }

        .card.back {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            font-size: 14px;
        }

        .card-rank {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 16px;
        }

        .card-suit {
            font-size: 28px;
        }

        /* Game Info */
        .game-info {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--secondary);
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 5px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--medium-bg);
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast.info { border-color: var(--secondary); }

        /* Result Display */
        .result-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 4px solid gold;
            text-align: center;
            z-index: 1000;
            min-width: 300px;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .result-display.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .result-title {
            font-size: 36px;
            font-weight: 700;
            color: gold;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .result-amount {
            font-size: 28px;
            color: white;
            margin-bottom: 30px;
        }

        /* Animations */
        @keyframes cardDeal {
            0% { transform: translateY(-100px) rotateY(0deg); opacity: 0; }
            100% { transform: translateY(0) rotateY(360deg); opacity: 1; }
        }

        @keyframes chipThrow {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
            100% { transform: translateY(0) rotate(360deg); }
        }

        @keyframes winPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .card-deal {
            animation: cardDeal 0.5s ease-out;
        }

        .chip-animation {
            animation: chipThrow 0.5s ease-out;
        }

        .win-animation {
            animation: winPulse 0.5s infinite;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .chip {
                width: 60px;
                height: 60px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .game-controls {
                grid-template-columns: 1fr;
            }
            
            .chip-selector {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .card {
                width: 60px;
                height: 85px;
                font-size: 16px;
            }
            
            .card-suit {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <a href="https://xcrazybet.github.io/millioner" class="home-btn" title="Return to Home">
                <i class="fas fa-home"></i>
            </a>
            <div class="logo">
                <i class="fas fa-dice"></i>
                XCrazyBet Blackjack
            </div>
        </div>
        
        <div class="nav-links">
            <a href="https://xcrazybet.github.io/millioner/games.html" class="nav-btn">
                <i class="fas fa-gamepad"></i> Games
            </a>
            <a href="https://xcrazybet.github.io/millioner/bets.html" class="nav-btn">
                <i class="fas fa-coins"></i> Bets
            </a>
            <a href="https://xcrazybet.github.io/millioner/dashboard.html" class="nav-btn">
                <i class="fas fa-wallet"></i> Deposit
            </a>
        </div>
        
        <div class="balance-display" id="balanceDisplay">
            <i class="fas fa-wallet"></i> Loading...
        </div>
    </header>

    <!-- Result Display -->
    <div class="result-display" id="resultDisplay">
        <div class="result-title" id="resultTitle">BLACKJACK!</div>
        <div class="result-amount" id="resultAmount">You won $0</div>
        <button class="action-btn btn-deal" onclick="hideResult()">Continue</button>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Bet Controls -->
            <div class="sidebar-section">
                <h3><i class="fas fa-coins"></i> Place Your Bet</h3>
                <div class="bet-controls">
                    <div class="bet-amount-display" id="currentBet">$0</div>
                    
                    <div class="bet-input-group">
                        <button class="action-btn" onclick="adjustBet(-10)" style="background: var(--danger);">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="betAmount" class="bet-input" value="10" min="1" step="1">
                        <button class="action-btn" onclick="adjustBet(10)" style="background: var(--success);">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="chip-selector">
                        <div class="chip chip-1" onclick="setBet(1)">$1</div>
                        <div class="chip chip-5" onclick="setBet(5)">$5</div>
                        <div class="chip chip-10" onclick="setBet(10)">$10</div>
                        <div class="chip chip-25" onclick="setBet(25)">$25</div>
                        <div class="chip chip-50" onclick="setBet(50)">$50</div>
                        <div class="chip chip-100" onclick="setBet(100)">$100</div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="sidebar-section">
                <h3><i class="fas fa-gamepad"></i> Game Controls</h3>
                <div class="game-controls">
                    <button class="action-btn btn-deal" id="btnDeal" onclick="dealHand()">
                        <i class="fas fa-play"></i> DEAL HAND
                    </button>
                    <button class="action-btn btn-hit" id="btnHit" onclick="playerHit()" disabled>
                        <i class="fas fa-plus"></i> HIT
                    </button>
                    <button class="action-btn btn-stand" id="btnStand" onclick="playerStand()" disabled>
                        <i class="fas fa-hand-paper"></i> STAND
                    </button>
                    <button class="action-btn btn-double" id="btnDouble" onclick="playerDouble()" disabled>
                        <i class="fas fa-exchange-alt"></i> DOUBLE
                    </button>
                </div>
            </div>

            <!-- Top Winners -->
            <div class="sidebar-section">
                <h3><i class="fas fa-trophy"></i> Recent Winners</h3>
                <div class="winners-list" id="winnersList">
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <!-- Game Rules -->
            <div class="sidebar-section">
                <h3><i class="fas fa-info-circle"></i> Game Rules</h3>
                <div style="font-size: 14px; line-height: 1.6;">
                    <p><strong>Goal:</strong> Get closer to 21 than dealer without busting</p>
                    <p><strong>Blackjack:</strong> Ace + 10-value card = 2:1 payout</p>
                    <p><strong>Dealer:</strong> Must hit on 16, stand on 17</p>
                    <p><strong>Double:</strong> Double bet for one more card</p>
                    <p><strong>Min Bet:</strong> $1</p>
                    <p><strong>Max Bet:</strong> $500</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Blackjack Table -->
            <div class="blackjack-table">
                <!-- Dealer Area -->
                <div class="dealer-area">
                    <div class="area-title">Dealer</div>
                    <div class="card-area" id="dealerCards">
                        <!-- Dealer cards will be added here -->
                    </div>
                    <div class="score-display" id="dealerScore">Score: 0</div>
                </div>
                
                <!-- Player Area -->
                <div class="player-area">
                    <div class="area-title">Player</div>
                    <div class="card-area" id="playerCards">
                        <!-- Player cards will be added here -->
                    </div>
                    <div class="score-display" id="playerScore">Score: 0</div>
                </div>
            </div>

            <!-- Game Info -->
            <div class="game-info">
                <h3 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-line"></i> Game Statistics
                </h3>
                <div class="game-stats">
                    <div class="stat-box">
                        <div>Win Rate</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-box">
                        <div>Total Hands</div>
                        <div class="stat-value" id="totalHands">0</div>
                    </div>
                    <div class="stat-box">
                        <div>Total Won</div>
                        <div class="stat-value" id="totalWon">$0</div>
                    </div>
                    <div class="stat-box">
                        <div>Total Lost</div>
                        <div class="stat-value" id="totalLost">$0</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ===== FIREBASE CONFIG =====
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebaseapp.com",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ===== GAME STATE =====
        const gameState = {
            currentUser: null,
            balance: 0,
            currentBet: 10,
            deck: [],
            dealerCards: [],
            playerCards: [],
            gameActive: false,
            gameId: null,
            winners: [],
            gameStats: {
                totalHands: 0,
                totalWon: 0,
                totalLost: 0,
                wins: 0,
                losses: 0,
                pushes: 0
            }
        };

        // ===== CARD DECK =====
        const suits = ['♠', '♥', '♦', '♣'];
        const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
            loadRecentWinners();
            updateBetDisplay();
        });

        // ===== AUTHENTICATION =====
        function checkAuth() {
            auth.onAuthStateChanged(user => {
                if (!user) {
                    showToast('Please login to play', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                gameState.currentUser = user;
                loadBalance();
            });
        }

        // ===== BALANCE MANAGEMENT =====
        async function loadBalance() {
            try {
                const doc = await db.collection("wallets").doc(gameState.currentUser.uid).get();
                if (doc.exists) {
                    gameState.balance = doc.data().balance || 0;
                    updateBalanceDisplay();
                } else {
                    showToast('Wallet not found. Creating new wallet...', 'warning');
                    await db.collection("wallets").doc(gameState.currentUser.uid).set({
                        balance: 100,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    gameState.balance = 100;
                    updateBalanceDisplay();
                }
            } catch (error) {
                console.error('Error loading balance:', error);
                showToast('Error loading balance', 'error');
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('balanceDisplay');
            if (balanceElement) {
                balanceElement.innerHTML = `<i class="fas fa-wallet"></i> $${gameState.balance.toFixed(2)}`;
            }
        }

        // ===== REAL-TIME BALANCE SYNC =====
        function setupBalanceListener() {
            if (!gameState.currentUser) return;
            
            const walletRef = db.collection("wallets").doc(gameState.currentUser.uid);
            
            walletRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const newBalance = doc.data().balance || 0;
                    if (newBalance !== gameState.balance) {
                        gameState.balance = newBalance;
                        updateBalanceDisplay();
                        showToast('Balance updated', 'info');
                    }
                }
            }, (error) => {
                console.error('Balance listener error:', error);
            });
        }

        // ===== TRANSACTION SYSTEM =====
        async function processTransaction(amount, type, description) {
            try {
                const walletRef = db.collection("wallets").doc(gameState.currentUser.uid);
                
                await db.runTransaction(async (transaction) => {
                    const walletDoc = await transaction.get(walletRef);
                    
                    if (!walletDoc.exists) {
                        throw new Error("Wallet not found");
                    }
                    
                    const currentBalance = walletDoc.data().balance || 0;
                    const newBalance = currentBalance + amount;
                    
                    if (newBalance < 0) {
                        throw new Error("Insufficient funds");
                    }
                    
                    // Update wallet balance
                    transaction.update(walletRef, {
                        balance: newBalance,
                        updatedAt: new Date()
                    });
                    
                    // Record transaction
                    const transactionRef = walletRef.collection("transactions").doc();
                    transaction.set(transactionRef, {
                        type: type,
                        amount: amount,
                        description: description,
                        createdAt: new Date(),
                        gameId: gameState.gameId || 'blackjack_game',
                        beforeBalance: currentBalance,
                        afterBalance: newBalance
                    });
                    
                    // Update local balance
                    gameState.balance = newBalance;
                });
                
                updateBalanceDisplay();
                return true;
            } catch (error) {
                console.error('Transaction failed:', error);
                showToast('Transaction failed: ' + error.message, 'error');
                return false;
            }
        }

        // ===== BET MANAGEMENT =====
        function setupEventListeners() {
            // Bet input
            document.getElementById('betAmount').addEventListener('change', (e) => {
                let bet = parseInt(e.target.value);
                if (isNaN(bet) || bet < 1) bet = 1;
                if (bet > 500) bet = 500;
                if (bet > gameState.balance) bet = Math.floor(gameState.balance);
                
                gameState.currentBet = bet;
                updateBetDisplay();
            });

            // Real-time balance updates
            setupBalanceListener();
        }

        function setBet(amount) {
            if (gameState.gameActive) return;
            
            const totalBet = gameState.currentBet + amount;
            if (totalBet > gameState.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            if (totalBet > 500) {
                showToast('Maximum bet is $500', 'warning');
                return;
            }
            
            gameState.currentBet = totalBet;
            document.getElementById('betAmount').value = gameState.currentBet;
            updateBetDisplay();
            
            // Animate chip
            const chips = document.querySelectorAll('.chip');
            chips.forEach(chip => {
                chip.classList.remove('active');
                if (parseInt(chip.textContent.replace('$', '')) === amount) {
                    chip.classList.add('chip-animation');
                    setTimeout(() => chip.classList.remove('chip-animation'), 500);
                }
            });
        }

        function adjustBet(amount) {
            if (gameState.gameActive) return;
            
            let newBet = gameState.currentBet + amount;
            if (newBet < 1) newBet = 1;
            if (newBet > 500) newBet = 500;
            if (newBet > gameState.balance) newBet = Math.floor(gameState.balance);
            
            gameState.currentBet = newBet;
            document.getElementById('betAmount').value = gameState.currentBet;
            updateBetDisplay();
        }

        function updateBetDisplay() {
            document.getElementById('currentBet').textContent = `$${gameState.currentBet}`;
            
            // Enable/disable deal button based on bet and balance
            const dealBtn = document.getElementById('btnDeal');
            if (gameState.currentBet > 0 && gameState.currentBet <= gameState.balance && !gameState.gameActive) {
                dealBtn.disabled = false;
            } else {
                dealBtn.disabled = true;
            }
        }

        // ===== DECK FUNCTIONS =====
        function createDeck() {
            const deck = [];
            for (const suit of suits) {
                for (const rank of ranks) {
                    deck.push({
                        rank,
                        suit,
                        color: suit === '♥' || suit === '♦' ? 'red' : 'black',
                        value: getCardValue(rank)
                    });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        function getCardValue(rank) {
            if (rank === 'A') return 11; // Ace can be 1 or 11
            if (['K', 'Q', 'J'].includes(rank)) return 10;
            return parseInt(rank);
        }

        // ===== GAME LOGIC =====
        async function dealHand() {
            if (gameState.gameActive) return;
            if (gameState.currentBet > gameState.balance) {
                showToast('Insufficient balance', 'error');
                return;
            }

            // Deduct bet from balance
            const transactionSuccess = await processTransaction(
                -gameState.currentBet,
                "blackjack_bet",
                `Blackjack bet of $${gameState.currentBet}`
            );
            
            if (!transactionSuccess) return;

            // Generate game ID
            gameState.gameId = 'blackjack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            gameState.gameActive = true;
            gameState.deck = shuffleDeck(createDeck());
            gameState.dealerCards = [];
            gameState.playerCards = [];

            // Clear card displays
            document.getElementById('dealerCards').innerHTML = '';
            document.getElementById('playerCards').innerHTML = '';

            // Deal initial cards
            gameState.playerCards.push(drawCard());
            gameState.dealerCards.push(drawCard());
            gameState.playerCards.push(drawCard());
            gameState.dealerCards.push(drawCard());

            // Update displays
            updateCardDisplay();
            updateScores();

            // Enable/disable buttons
            document.getElementById('btnDeal').disabled = true;
            document.getElementById('btnHit').disabled = false;
            document.getElementById('btnStand').disabled = false;
            
            // Enable double if balance allows
            if (gameState.currentBet * 2 <= gameState.balance) {
                document.getElementById('btnDouble').disabled = false;
            }

            // Check for blackjack
            const playerScore = calculateScore(gameState.playerCards);
            if (playerScore === 21) {
                // Blackjack! Wait a moment then process
                setTimeout(() => {
                    endGame(true);
                }, 1000);
            }

            showToast('Good luck!', 'info');
        }

        function drawCard() {
            if (gameState.deck.length === 0) {
                gameState.deck = shuffleDeck(createDeck());
            }
            return gameState.deck.pop();
        }

        function updateCardDisplay() {
            const dealerCardsElement = document.getElementById('dealerCards');
            const playerCardsElement = document.getElementById('playerCards');
            
            // Dealer cards (first card face down during game)
            dealerCardsElement.innerHTML = '';
            gameState.dealerCards.forEach((card, index) => {
                const cardElement = createCardElement(card, index === 0 && gameState.gameActive);
                dealerCardsElement.appendChild(cardElement);
            });

            // Player cards
            playerCardsElement.innerHTML = '';
            gameState.playerCards.forEach(card => {
                const cardElement = createCardElement(card, false);
                playerCardsElement.appendChild(cardElement);
            });
        }

        function createCardElement(card, isHidden) {
            const div = document.createElement('div');
            if (isHidden) {
                div.className = 'card back';
                div.innerHTML = '?';
            } else {
                div.className = `card ${card.color}`;
                div.innerHTML = `
                    <div class="card-rank">${card.rank}</div>
                    <div class="card-suit">${card.suit}</div>
                `;
            }
            div.classList.add('card-deal');
            return div;
        }

        function calculateScore(cards) {
            let score = 0;
            let aces = 0;

            cards.forEach(card => {
                if (card.rank === 'A') {
                    aces++;
                    score += 11;
                } else {
                    score += card.value;
                }
            });

            // Adjust aces from 11 to 1 if needed
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }

            return score;
        }

        function updateScores() {
            const playerScore = calculateScore(gameState.playerCards);
            let dealerScore = calculateScore(gameState.dealerCards);
            
            // During game, dealer's first card is hidden
            if (gameState.gameActive) {
                dealerScore = getCardValue(gameState.dealerCards[1].rank);
                if (gameState.dealerCards[1].rank === 'A') dealerScore = 11;
            }

            document.getElementById('playerScore').textContent = `Score: ${playerScore}`;
            document.getElementById('dealerScore').textContent = `Score: ${dealerScore}`;
        }

        // ===== PLAYER ACTIONS =====
        async function playerHit() {
            if (!gameState.gameActive) return;

            gameState.playerCards.push(drawCard());
            updateCardDisplay();
            updateScores();

            const playerScore = calculateScore(gameState.playerCards);
            if (playerScore > 21) {
                // Player busts
                showToast('Bust!', 'error');
                setTimeout(() => {
                    endGame(false);
                }, 1000);
            }
        }

        function playerStand() {
            if (!gameState.gameActive) return;

            // Disable player actions
            document.getElementById('btnHit').disabled = true;
            document.getElementById('btnStand').disabled = true;
            document.getElementById('btnDouble').disabled = true;

            // Dealer's turn
            dealerPlay();
        }

        async function playerDouble() {
            if (!gameState.gameActive) return;
            if (gameState.currentBet * 2 > gameState.balance) {
                showToast('Insufficient balance for double', 'error');
                return;
            }

            // Double the bet
            const transactionSuccess = await processTransaction(
                -gameState.currentBet,
                "blackjack_double",
                `Double down bet of $${gameState.currentBet}`
            );
            
            if (!transactionSuccess) return;

            gameState.currentBet *= 2;
            updateBetDisplay();

            // Take one more card
            gameState.playerCards.push(drawCard());
            updateCardDisplay();
            updateScores();

            const playerScore = calculateScore(gameState.playerCards);
            if (playerScore > 21) {
                // Player busts
                showToast('Bust!', 'error');
                setTimeout(() => {
                    endGame(false);
                }, 1000);
            } else {
                // Stand after double
                playerStand();
            }
        }

        // ===== DEALER LOGIC =====
        function dealerPlay() {
            // Reveal dealer's hidden card
            updateCardDisplay();
            
            let dealerScore = calculateScore(gameState.dealerCards);
            updateScores();

            // Dealer hits on 16 or less, stands on 17 or more
            const dealerInterval = setInterval(() => {
                if (dealerScore < 17) {
                    gameState.dealerCards.push(drawCard());
                    dealerScore = calculateScore(gameState.dealerCards);
                    updateCardDisplay();
                    updateScores();
                } else {
                    clearInterval(dealerInterval);
                    setTimeout(() => {
                        determineWinner(dealerScore);
                    }, 1000);
                }
            }, 1000);
        }

        // ===== GAME RESULT =====
        async function determineWinner(dealerScore) {
            const playerScore = calculateScore(gameState.playerCards);
            let result = '';
            let multiplier = 0;

            if (playerScore > 21) {
                result = 'Bust - You Lose';
                multiplier = 0;
                gameState.gameStats.losses++;
                gameState.gameStats.totalLost += gameState.currentBet;
            } else if (dealerScore > 21) {
                result = 'Dealer Busts - You Win!';
                multiplier = 1;
                gameState.gameStats.wins++;
                gameState.gameStats.totalWon += gameState.currentBet;
            } else if (playerScore > dealerScore) {
                result = 'You Win!';
                multiplier = 1;
                gameState.gameStats.wins++;
                gameState.gameStats.totalWon += gameState.currentBet;
            } else if (playerScore < dealerScore) {
                result = 'You Lose';
                multiplier = 0;
                gameState.gameStats.losses++;
                gameState.gameStats.totalLost += gameState.currentBet;
            } else {
                result = 'Push (Tie)';
                multiplier = 0.5; // Return bet only
                gameState.gameStats.pushes++;
            }

            // Check for blackjack (natural)
            const hasBlackjack = gameState.playerCards.length === 2 && playerScore === 21;
            const dealerHasBlackjack = gameState.dealerCards.length === 2 && dealerScore === 21;

            if (hasBlackjack && !dealerHasBlackjack) {
                result = 'Blackjack!';
                multiplier = 2.5; // Blackjack pays 3:2 (1.5x bet + original bet back)
                gameState.gameStats.wins++;
                gameState.gameStats.totalWon += gameState.currentBet * 1.5;
            }

            // Calculate winnings
            const winnings = Math.floor(gameState.currentBet * multiplier);

            // Process winnings if any
            if (winnings > 0) {
                await processTransaction(
                    winnings,
                    "blackjack_win",
                    `Won $${winnings} at blackjack`
                );
                
                // Record win
                recordWin(gameState.currentUser.displayName || 'Player', winnings);
            } else if (multiplier === 0.5) {
                // Return bet for push
                await processTransaction(
                    gameState.currentBet,
                    "blackjack_push",
                    `Push - bet returned`
                );
            }

            // Update stats
            gameState.gameStats.totalHands++;
            updateGameStats();

            // Show result
            showResult(result, winnings);
        }

        async function endGame(hasBlackjack) {
            if (hasBlackjack) {
                // Player has blackjack, dealer checks for blackjack
                const dealerScore = calculateScore(gameState.dealerCards);
                
                if (dealerScore === 21) {
                    // Both have blackjack - push
                    showResult('Push (Both Blackjack)', 0);
                    await processTransaction(
                        gameState.currentBet,
                        "blackjack_push",
                        `Push - both have blackjack`
                    );
                } else {
                    // Player wins with blackjack
                    const winnings = Math.floor(gameState.currentBet * 2.5);
                    await processTransaction(
                        winnings,
                        "blackjack_blackjack",
                        `Blackjack win of $${winnings}`
                    );
                    
                    recordWin(gameState.currentUser.displayName || 'Player', winnings);
                    showResult('Blackjack!', winnings);
                }
                
                gameState.gameStats.totalHands++;
                updateGameStats();
            }
            
            resetGame();
        }

        function showResult(title, amount) {
            const resultDisplay = document.getElementById('resultDisplay');
            const resultTitle = document.getElementById('resultTitle');
            const resultAmount = document.getElementById('resultAmount');
            
            resultTitle.textContent = title;
            if (amount > 0) {
                resultAmount.textContent = `You won $${amount}`;
                resultAmount.style.color = 'var(--success)';
            } else if (title.includes('Push')) {
                resultAmount.textContent = `Bet returned`;
                resultAmount.style.color = 'var(--warning)';
            } else {
                resultAmount.textContent = `You lost $${gameState.currentBet}`;
                resultAmount.style.color = 'var(--danger)';
            }
            
            resultDisplay.classList.add('show');
        }

        function hideResult() {
            document.getElementById('resultDisplay').classList.remove('show');
            resetGame();
        }

        function resetGame() {
            gameState.gameActive = false;
            
            // Reset buttons
            document.getElementById('btnDeal').disabled = false;
            document.getElementById('btnHit').disabled = true;
            document.getElementById('btnStand').disabled = true;
            document.getElementById('btnDouble').disabled = true;
            
            // Update bet display
            updateBetDisplay();
        }

        // ===== WINNERS TRACKING =====
        function recordWin(playerName, amount) {
            const winRecord = {
                player: playerName,
                amount: amount,
                timestamp: new Date()
            };
            
            gameState.winners.unshift(winRecord);
            if (gameState.winners.length > 10) {
                gameState.winners.pop();
            }
            
            updateWinnersDisplay();
            saveWinToFirebase(playerName, amount);
        }

        function updateWinnersDisplay() {
            const container = document.getElementById('winnersList');
            container.innerHTML = '';
            
            gameState.winners.forEach(winner => {
                const item = document.createElement('div');
                item.className = 'winner-item';
                item.innerHTML = `
                    <span class="winner-name">${winner.player}</span>
                    <span class="winner-amount">$${winner.amount}</span>
                `;
                container.appendChild(item);
            });
        }

        async function loadRecentWinners() {
            try {
                const snapshot = await db.collection('blackjack_wins')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    gameState.winners.push({
                        player: data.player,
                        amount: data.amount,
                        timestamp: data.timestamp.toDate()
                    });
                });
                
                updateWinnersDisplay();
            } catch (error) {
                console.error('Error loading winners:', error);
            }
        }

        async function saveWinToFirebase(playerName, amount) {
            try {
                await db.collection('blackjack_wins').add({
                    player: playerName,
                    amount: amount,
                    timestamp: new Date(),
                    gameId: gameState.gameId,
                    userId: gameState.currentUser.uid
                });
            } catch (error) {
                console.error('Error saving win:', error);
            }
        }

        // ===== GAME STATS =====
        function updateGameStats() {
            const winRate = gameState.gameStats.totalHands > 0 
                ? Math.round((gameState.gameStats.wins / gameState.gameStats.totalHands) * 100)
                : 0;
            
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('totalHands').textContent = gameState.gameStats.totalHands;
            document.getElementById('totalWon').textContent = `$${gameState.gameStats.totalWon}`;
            document.getElementById('totalLost').textContent = `$${gameState.gameStats.totalLost}`;
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ===== HOUSE EDGE SYSTEM =====
        // Blackjack naturally has about 0.5% house edge with perfect play
        // We'll implement additional small edge through:
        // 1. Dealer wins ties on certain edge cases
        // 2. Slightly modified blackjack payout (3:2 is standard, but we'll use 1:1 for non-blackjack wins)
        // 3. No surrender option
        // This creates approximately 2-3% house edge overall

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            if (!gameState.gameActive) return;
            
            switch(e.key.toLowerCase()) {
                case 'h':
                    playerHit();
                    break;
                case 's':
                    playerStand();
                    break;
                case 'd':
                    playerDouble();
                    break;
                case 'r':
                    if (!gameState.gameActive) dealHand();
                    break;
            }
        });

        // ===== LEAVE GAME =====
        window.addEventListener('beforeunload', (e) => {
            if (gameState.gameActive) {
                // Auto-stand if leaving during game
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your current game will be forfeited.';
            }
        });
    </script>
</body>
</html>
