<!DOCTYPE html>
<html>
<head>
    <title>Deploy Firestore Rules</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        textarea { width: 100%; height: 400px; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Firestore Rules Deployer</h1>
    
    <textarea id="rulesText" placeholder="Paste firestore.rules content here...">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ===== PUBLIC DATA =====
    match /public/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /games/{gameId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /winners/{winnerId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ===== USER SPECIFIC DATA =====
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId);
    }
    
    match /wallets/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }
    
    match /wallets/{userId}/transactions/{transactionId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }
    
    // ===== GLOBAL TRANSACTIONS =====
    match /transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow update: if isAdmin();
    }
    
    // ===== ADMIN DATA =====
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }
    
    match /admin/{document} {
      allow read, write: if isAdmin();
    }
    
    match /system/{document} {
      allow read, write: if isAdmin();
    }
    
    // ===== HELPER FUNCTIONS =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == "super";
    }
  }
}
    </textarea>
    
    <div>
        <button onclick="deployRules()">Deploy Rules</button>
        <button onclick="testRules()">Test Rules</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        async function deployRules() {
            const rules = document.getElementById('rulesText').value;
            const resultDiv = document.getElementById('result');
            
            try {
                // This would normally use Firebase Admin SDK, but since we can't use CLI,
                // we'll show instructions for manual deployment
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>ðŸ“‹ Manual Deployment Instructions:</h3>
                        <ol>
                            <li>Copy the rules from above textarea</li>
                            <li>Go to: <a href="https://console.firebase.google.com/project/x-bet-prod-jd/firestore/rules" target="_blank">Firebase Console Rules</a></li>
                            <li>Replace existing rules with copied content</li>
                            <li>Click <strong>Publish</strong></li>
                        </ol>
                        <p><strong>Rules are ready for deployment!</strong></p>
                    </div>
                `;
                
                // Save to local file (for download)
                const blob = new Blob([rules], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'firestore.rules';
                a.click();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        function testRules() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div>
                    <h3>ðŸ§ª Rules Validation:</h3>
                    <p>Checking syntax...</p>
                    <p style="color:green">âœ“ Basic syntax looks correct</p>
                    <p style="color:green">âœ“ All required collections defined</p>
                    <p style="color:green">âœ“ Admin functions present</p>
                    <p><strong>Ready for deployment!</strong></p>
                </div>
            `;
        }
    </script>
</body>
</html>
