<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.gstatic.com https://www.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' https://www.gstatic.com https://www.google.com https://www.gstatic.com/recaptcha/;">

    <title>X-BET PRO | VIP Banking Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
            --bg: #020617;
            --card: rgba(15, 23, 42, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --income: #10b981;
            --expense: #ef4444;
        }

        body {
            background: radial-gradient(circle at 0% 0%, #1e1b4b 0%, var(--bg) 50%);
            color: white;
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* Full Screen Shield/Loader */
        #shield {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.5s ease;
        }

        .spinner {
            width: 40px; height: 40px; border: 3px solid var(--border);
            border-top: 3px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Navigation */
        nav {
            padding: 1.5rem 5%;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
        }

        .logo { font-weight: 800; font-size: 1.4rem; letter-spacing: -1px; }
        .logo span { color: var(--accent); }

        .user-pill {
            background: rgba(255,255,255,0.05);
            padding: 6px 16px; border-radius: 100px;
            border: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 5%;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Cards */
        .glass-card {
            background: var(--card);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 24px; padding: 2rem;
            position: relative; overflow: hidden;
        }

        .glass-card::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
            pointer-events: none;
        }

        .label { 
            color: var(--text-muted); 
            font-size: 0.8rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .big-value { 
            font-size: 3rem; 
            font-weight: 800; 
            margin: 0.5rem 0; 
            letter-spacing: -2px; 
        }
        
        .balance-container { 
            display: flex; 
            align-items: baseline; 
            gap: 8px; 
        }
        
        .currency { 
            color: var(--accent); 
            font-size: 1.5rem; 
            font-weight: 600; 
        }

        /* Buttons */
        .btn-primary {
            width: 100%; padding: 1rem; border-radius: 14px; border: none;
            background: var(--accent); color: white; font-weight: 700;
            font-size: 1rem; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 4px 15px var(--accent-glow);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }

        .btn-secondary {
            padding: 0.75rem 1.5rem; border-radius: 12px; border: 1px solid var(--accent);
            background: transparent; color: var(--accent); font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }

        .btn-secondary:hover { background: rgba(59, 130, 246, 0.1); }

        .btn-logout {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            padding: 6px 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
        }

        /* Transaction History */
        .transactions-container {
            height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .transaction-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 1rem; border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .transaction-item:hover { background: rgba(255,255,255,0.03); }

        .transaction-icon {
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }

        .transaction-details { flex: 1; margin-left: 1rem; }
        .transaction-title { font-weight: 600; margin-bottom: 4px; }
        .transaction-meta { font-size: 0.8rem; color: var(--text-muted); }
        .transaction-amount { font-weight: 700; font-size: 1.1rem; }

        .income { color: var(--income); }
        .expense { color: var(--expense); }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-input {
            width: 100%; padding: 0.75rem 1rem; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: white; font-size: 1rem;
        }
        .form-input:focus { outline: none; border-color: var(--accent); }

        /* Tabs */
        .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .tab { 
            padding: 0.75rem 1.5rem; border-radius: 12px; 
            background: transparent; border: 1px solid var(--border);
            color: var(--text-muted); cursor: pointer; transition: all 0.2s;
            font-weight: 600;
        }
        .tab.active { background: var(--accent); border-color: var(--accent); color: white; }

        /* User Details */
        .user-details-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;
        }
        .detail-item { margin-bottom: 1rem; }
        .detail-label { color: var(--text-muted); font-size: 0.85rem; }
        .detail-value { font-weight: 600; }

        /* Status Tags */
        .status-tag {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 0.75rem; font-weight: 700; color: var(--success);
            background: rgba(16, 185, 129, 0.1); padding: 4px 12px; border-radius: 100px;
        }

        /* Error Toast */
        #error-toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--danger);
            padding: 1rem 2rem; border-radius: 12px; font-weight: 700;
            display: none; z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card); border-radius: 24px; padding: 2rem;
            width: 90%; max-width: 500px; border: 1px solid var(--border);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; }
    </style>
</head>
<body>

<div id="shield">
    <div class="spinner"></div>
    <p id="shield-text">Initializing Secure Banking System...</p>
</div>

<div id="error-toast">Connection Lost. Retrying...</div>

<!-- Transfer Modal -->
<div id="transferModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="margin-top: 0;">Transfer Funds</h2>
        <form id="transferForm">
            <div class="form-group">
                <label class="form-label">Recipient Email</label>
                <input type="email" id="recipientEmail" class="form-input" placeholder="user@example.com" required>
            </div>
            <div class="form-group">
                <label class="form-label">Amount ($)</label>
                <input type="number" id="transferAmount" class="form-input" placeholder="0.00" min="1" step="0.01" required>
            </div>
            <div class="form-group">
                <label class="form-label">Note (Optional)</label>
                <input type="text" id="transferNote" class="form-input" placeholder="Payment for...">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" id="cancelTransfer" class="btn-secondary" style="flex: 1;">Cancel</button>
                <button type="submit" class="btn-primary" style="flex: 1;">Confirm Transfer</button>
            </div>
        </form>
    </div>
</div>

<nav>
    <div class="logo">X-BET <span>PRO</span></div>
    <div class="user-pill">
        <span id="display-email">---</span>
        <button id="logout-trigger" class="btn-logout">Logout</button>
    </div>
</nav>

<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Balance Card -->
        <div class="glass-card">
            <div class="label">Total Liquidity</div>
            <div class="balance-container">
                <span class="currency">$</span>
                <div class="big-value" id="balance-value">0.00</div>
            </div>
            <div class="status-tag">
                <i class="fas fa-shield-alt"></i>
                Secure & Encrypted
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="glass-card">
            <div class="label">Quick Actions</div>
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
                <button id="transferBtn" class="btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Send Money
                </button>
                <button id="receiveBtn" class="btn-primary" style="background: var(--success);">
                    <i class="fas fa-qrcode"></i>
                    Receive Money
                </button>
                <button id="depositBtn" class="btn-secondary">
                    <i class="fas fa-plus-circle"></i>
                    Deposit Funds
                </button>
            </div>
        </div>

        <!-- User Profile -->
        <div class="glass-card">
            <div class="label">Account Details</div>
            <div class="user-details-grid" id="userDetails">
                <!-- Dynamically filled -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Transaction History -->
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div class="label">Transaction History</div>
                <div class="tabs">
                    <button class="tab active" data-filter="all">All</button>
                    <button class="tab" data-filter="income">Income</button>
                    <button class="tab" data-filter="expense">Sent</button>
                </div>
            </div>
            
            <div class="transactions-container" id="transactionsList">
                <!-- Transactions will be loaded here -->
                <div style="text-align: center; padding: 3rem 0; color: var(--text-muted);">
                    <i class="fas fa-exchange-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>No transactions yet</p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            <div class="glass-card">
                <div class="label">Total Received</div>
                <div class="big-value" style="font-size: 2rem; color: var(--income);" id="totalReceived">$0</div>
            </div>
            <div class="glass-card">
                <div class="label">Total Sent</div>
                <div class="big-value" style="font-size: 2rem; color: var(--expense);" id="totalSent">$0</div>
            </div>
            <div class="glass-card">
                <div class="label">This Month</div>
                <div class="big-value" style="font-size: 2rem;" id="monthlyTotal">$0</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app-check.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signOut,
        fetchSignInMethodsForEmail 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc,
        collection,
        query,
        where,
        orderBy,
        limit,
        onSnapshot,
        updateDoc,
        arrayUnion,
        serverTimestamp,
        runTransaction,
        writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
        authDomain: "x-bet-prod-jd.firebaseapp.com",
        projectId: "x-bet-prod-jd",
        storageBucket: "x-bet-prod-jd.firebasestorage.app",
        messagingSenderId: "499334334535",
        appId: "1:499334334535:web:bebc1bf817e24d9e3c4962"
    };

    let app, auth, db;
    let walletListener = null;
    let transactionsListener = null;
    let currentUser = null;

    // Initialize Firebase
    try {
        app = initializeApp(firebaseConfig);
        
        // Enable App Check (replace with your actual key)
        initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LdI_qEqAAAAAA_EXAMPLE_KEY'),
            isTokenAutoRefreshEnabled: true
        });

        auth = getAuth(app);
        db = getFirestore(app);

        // Auth State Management
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await initializeDashboard(user);
            } else {
                window.location.replace('login.html');
            }
        });

    } catch (error) {
        console.error("Initialization Error:", error);
        showError("System initialization failed");
    }

    async function initializeDashboard(user) {
        try {
            // Update UI with user info
            document.getElementById('display-email').innerText = user.email;
            
            // Load user details
            await loadUserDetails(user);
            
            // Setup real-time wallet balance
            setupWalletListener(user);
            
            // Load transaction history
            setupTransactionsListener(user);
            
            // Setup event listeners
            setupEventListeners();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('shield').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('shield').style.display = 'none';
                }, 500);
            }, 1000);
            
        } catch (error) {
            console.error("Dashboard initialization error:", error);
            showError("Failed to load dashboard");
        }
    }

    async function loadUserDetails(user) {
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            const userData = userDoc.exists() ? userDoc.data() : {};
            
            const userDetailsHTML = `
                <div class="detail-item">
                    <div class="detail-label">Account Tier</div>
                    <div class="detail-value">${userData.tier || 'PRO INVESTOR'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Member Since</div>
                    <div class="detail-value">${userData.createdAt ? 
                        new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : 
                        new Date().toLocaleDateString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Account Status</div>
                    <div class="detail-value" style="color: var(--success);">● Active</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">User ID</div>
                    <div class="detail-value" style="font-size: 0.75rem; color: var(--text-muted);">
                        ${user.uid.substring(0, 8)}...
                    </div>
                </div>
            `;
            
            document.getElementById('userDetails').innerHTML = userDetailsHTML;
        } catch (error) {
            console.error("Error loading user details:", error);
        }
    }

    function setupWalletListener(user) {
        const docRef = doc(db, "wallets", user.uid);
        
        walletListener = onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                const balance = data.balance || 0;
                
                // Animate balance update
                animateBalance(balance);
            }
        }, (error) => {
            console.error("Wallet sync error:", error);
            showError("Real-time balance sync failed");
        });
    }

    function setupTransactionsListener(user) {
        const transactionsRef = collection(db, "transactions");
        const q = query(
            transactionsRef,
            where("userId", "==", user.uid),
            orderBy("timestamp", "desc"),
            limit(50)
        );
        
        transactionsListener = onSnapshot(q, (snapshot) => {
            const transactions = [];
            let totalReceived = 0;
            let totalSent = 0;
            let monthlyTotal = 0;
            const currentMonth = new Date().getMonth();
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                transactions.push({ id: doc.id, ...data });
                
                // Calculate totals
                if (data.type === 'income') {
                    totalReceived += data.amount;
                    if (new Date(data.timestamp?.seconds * 1000).getMonth() === currentMonth) {
                        monthlyTotal += data.amount;
                    }
                } else if (data.type === 'expense') {
                    totalSent += data.amount;
                    if (new Date(data.timestamp?.seconds * 1000).getMonth() === currentMonth) {
                        monthlyTotal -= data.amount;
                    }
                }
            });
            
            // Update UI
            updateTransactionList(transactions);
            document.getElementById('totalReceived').textContent = `$${totalReceived.toLocaleString()}`;
            document.getElementById('totalSent').textContent = `$${totalSent.toLocaleString()}`;
            document.getElementById('monthlyTotal').textContent = `$${monthlyTotal.toLocaleString()}`;
            
        }, (error) => {
            console.error("Transactions sync error:", error);
        });
    }

    function updateTransactionList(transactions) {
        const container = document.getElementById('transactionsList');
        
        if (transactions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem 0; color: var(--text-muted);">
                    <i class="fas fa-exchange-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>No transactions yet</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        transactions.forEach((tx) => {
            const isIncome = tx.type === 'income';
            const icon = isIncome ? 'fa-arrow-down' : 'fa-arrow-up';
            const date = tx.timestamp ? 
                new Date(tx.timestamp.seconds * 1000).toLocaleDateString() : 'Recent';
            
            html += `
                <div class="transaction-item" data-type="${tx.type}">
                    <div class="transaction-icon" style="background: ${isIncome ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}">
                        <i class="fas ${icon} ${isIncome ? 'income' : 'expense'}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${tx.description || (isIncome ? 'Money Received' : 'Money Sent')}</div>
                        <div class="transaction-meta">${date} • ${tx.status || 'Completed'}</div>
                    </div>
                    <div class="transaction-amount ${isIncome ? 'income' : 'expense'}">
                        ${isIncome ? '+' : '-'}$${tx.amount.toLocaleString()}
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add filter functionality
        setupTransactionFilters();
    }

    function setupTransactionFilters() {
        const tabs = document.querySelectorAll('.tab');
        const transactions = document.querySelectorAll('.transaction-item');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const filter = tab.dataset.filter;
                
                // Filter transactions
                transactions.forEach(transaction => {
                    if (filter === 'all') {
                        transaction.style.display = 'flex';
                    } else if (filter === 'income') {
                        transaction.style.display = transaction.dataset.type === 'income' ? 'flex' : 'none';
                    } else if (filter === 'expense') {
                        transaction.style.display = transaction.dataset.type === 'expense' ? 'flex' : 'none';
                    }
                });
            });
        });
    }

    async function transferMoney(recipientEmail, amount, note) {
        if (!currentUser) return false;
        
        try {
            // Check if recipient exists
            const methods = await fetchSignInMethodsForEmail(auth, recipientEmail);
            if (methods.length === 0) {
                throw new Error('Recipient not found');
            }
            
            // Find recipient user document
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", recipientEmail));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                throw new Error('Recipient account not found');
            }
            
            const recipientDoc = querySnapshot.docs[0];
            const recipientId = recipientDoc.id;
            
            // Check if recipient has a wallet
            const recipientWalletRef = doc(db, "wallets", recipientId);
            const recipientWallet = await getDoc(recipientWalletRef);
            
            if (!recipientWallet.exists()) {
                throw new Error('Recipient wallet not found');
            }
            
            // Check sender balance
            const senderWalletRef = doc(db, "wallets", currentUser.uid);
            const senderWallet = await getDoc(senderWalletRef);
            
            if (!senderWallet.exists()) {
                throw new Error('Your wallet not found');
            }
            
            const senderBalance = senderWallet.data().balance || 0;
            
            if (senderBalance < amount) {
                throw new Error('Insufficient balance');
            }
            
            // Perform transaction using Firestore transaction
            await runTransaction(db, async (transaction) => {
                // Get fresh data
                const senderSnapshot = await transaction.get(senderWalletRef);
                const recipientSnapshot = await transaction.get(recipientWalletRef);
                
                const newSenderBalance = senderSnapshot.data().balance - amount;
                const newRecipientBalance = recipientSnapshot.data().balance + amount;
                
                // Update balances
                transaction.update(senderWalletRef, { 
                    balance: newSenderBalance,
                    lastUpdated: serverTimestamp()
                });
                
                transaction.update(recipientWalletRef, { 
                    balance: newRecipientBalance,
                    lastUpdated: serverTimestamp()
                });
                
                // Create transaction records
                const transactionsRef = collection(db, "transactions");
                const senderTxRef = doc(transactionsRef);
                const recipientTxRef = doc(transactionsRef);
                
                const txData = {
                    amount: amount,
                    timestamp: serverTimestamp(),
                    status: 'completed'
                };
                
                // Sender's transaction record
                transaction.set(senderTxRef, {
                    ...txData,
                    userId: currentUser.uid,
                    type: 'expense',
                    description: note || `Transfer to ${recipientEmail}`,
                    counterparty: recipientEmail,
                    counterpartyId: recipientId
                });
                
                // Recipient's transaction record
                transaction.set(recipientTxRef, {
                    ...txData,
                    userId: recipientId,
                    type: 'income',
                    description: note || `Transfer from ${currentUser.email}`,
                    counterparty: currentUser.email,
                    counterpartyId: currentUser.uid
                });
            });
            
            return true;
            
        } catch (error) {
            console.error("Transfer error:", error);
            showError(`Transfer failed: ${error.message}`);
            return false;
        }
    }

    function setupEventListeners() {
        // Logout
        document.getElementById('logout-trigger').addEventListener('click', async () => {
            if (confirm("Are you sure you want to logout?")) {
                if (walletListener) walletListener();
                if (transactionsListener) transactionsListener();
                await signOut(auth);
            }
        });
        
        // Transfer button
        document.getElementById('transferBtn').addEventListener('click', () => {
            document.getElementById('transferModal').style.display = 'flex';
        });
        
        // Cancel transfer
        document.getElementById('cancelTransfer').addEventListener('click', () => {
            document.getElementById('transferModal').style.display = 'none';
            document.getElementById('transferForm').reset();
        });
        
        // Transfer form submission
        document.getElementById('transferForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const recipientEmail = document.getElementById('recipientEmail').value;
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value;
            
            if (amount <= 0) {
                showError("Please enter a valid amount");
                return;
            }
            
            // Show processing state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;
            
            // Perform transfer
            const success = await transferMoney(recipientEmail, amount, note);
            
            if (success) {
                // Reset form and close modal
                document.getElementById('transferForm').reset();
                document.getElementById('transferModal').style.display = 'none';
                
                // Show success message
                showSuccess(`Successfully transferred $${amount.toLocaleString()} to ${recipientEmail}`);
            }
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
        // Receive button
        document.getElementById('receiveBtn').addEventListener('click', () => {
            alert(`Your payment address: ${currentUser.email}\n\nShare this email address with senders.`);
        });
        
        // Deposit button
        document.getElementById('depositBtn').addEventListener('click', () => {
            alert("Deposit feature coming soon!\n\nFor now, transfers can be made to your registered email.");
        });
    }

    function animateBalance(target) {
        const el = document.getElementById('balance-value');
        const current = parseFloat(el.textContent.replace(/,/g, '')) || 0;
        const targetNum = parseFloat(target);
        
        if (current === targetNum) return;
        
        // Simple animation
        el.style.opacity = '0.5';
        setTimeout(() => {
            el.textContent = targetNum.toLocaleString(undefined, {minimumFractionDigits: 2});
            el.style.opacity = '1';
        }, 300);
    }

    function showError(message) {
        const toast = document.getElementById('error-toast');
        toast.textContent = message;
        toast.style.display = 'block';
        
        setTimeout(() => {
            toast.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        // Create success toast
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed; bottom: 20px; left: 20px; 
            background: var(--success); color: white;
            padding: 1rem 2rem; border-radius: 12px; 
            font-weight: 700; z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Cleanup on page close
    window.addEventListener('beforeunload', () => {
        if (walletListener) walletListener();
        if (transactionsListener) transactionsListener();
    });

</script>
</body>
</html>
