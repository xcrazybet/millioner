rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== ADMIN COLLECTION =====
    match /admins/{adminId} {
      allow read: if request.auth != null && 
        request.auth.uid == adminId;
      allow write: if false; // Admins managed via Firebase Auth/Admin SDK only
    }
    
    // ===== WALLETS COLLECTION (PRIMARY USER DATA) =====
    match /wallets/{userId} {
      // Users can read their own wallet
      allow read: if request.auth != null && 
        request.auth.uid == userId;
      
      // Users can update their username only
      allow update: if request.auth != null && 
        request.auth.uid == userId &&
        // Only allow updating specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['username', 'updatedAt']) &&
        // Username must be 3-30 characters
        request.resource.data.username is string &&
        request.resource.data.username.size() >= 3 &&
        request.resource.data.username.size() <= 30;
      
      // System can create/update wallets (via admin functions)
      allow create, update: if isAdmin() && 
        // Validate required fields for creation
        (request.resource.data.keys().hasAll(['userId', 'email']) || 
         // Allow admin updates
         resource.data.keys().hasAll(['userId', 'email']));
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ===== USERS COLLECTION (LEGACY - READ ONLY) =====
    match /users/{userId} {
      // Users can read their own data
      allow read: if request.auth != null && 
        request.auth.uid == userId;
      
      // System can sync data from wallets
      allow create, update: if isAdmin() || 
        (request.auth != null && request.auth.uid == userId &&
         // Only allow syncing balance and updatedAt
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['balance', 'updatedAt']));
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ===== TRANSACTIONS COLLECTION =====
    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // System can create transactions (via admin or automated processes)
      allow create: if isAdmin() || 
        // User can create send transactions
        (request.auth != null && 
         request.auth.uid == request.resource.data.userId &&
         // Validate transaction data
         request.resource.data.keys().hasAll(['userId', 'type', 'amount', 'timestamp']) &&
         // Amount must be positive
         request.resource.data.amount is number &&
         request.resource.data.amount > 0 &&
         // Type must be valid
         request.resource.data.type in ['send', 'receive', 'deposit', 'withdraw', 'bonus', 'game']);
      
      // System can update transaction status
      allow update: if isAdmin() && 
        // Only allow updating status and admin fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'adminEmail', 'approvedBy', 'updatedAt']);
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ===== DEPOSIT REQUESTS COLLECTION =====
    match /deposit_requests/{requestId} {
      // Users can read their own deposit requests
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Users can create deposit requests
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        // Validate required fields
        request.resource.data.keys().hasAll(['userId', 'amount', 'method', 'status']) &&
        // Amount validation
        request.resource.data.amount is number &&
        request.resource.data.amount >= 10.00 && // Minimum deposit $10
        request.resource.data.amount <= 10000.00 && // Maximum deposit $10,000
        // Status must be pending initially
        request.resource.data.status == 'pending' &&
        // Method validation
        request.resource.data.method in ['credit_card', 'bank_transfer', 'crypto', 'paypal'] &&
        // Timestamps
        request.resource.data.createdAt is timestamp;
      
      // Users can update their own pending requests (to add proof/notes)
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        resource.data.status == 'pending' &&
        // Only allow updating specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['proofUrl', 'notes', 'updatedAt']);
      
      // Admins can update deposit request status
      allow update: if isAdmin() && 
        // Only allow status changes and admin fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'status', 'approvedBy', 'rejectedBy', 'rejectionReason', 
          'approvedAt', 'rejectedAt', 'updatedAt'
        ]) &&
        // Status validation
        (request.resource.data.status in ['pending', 'approved', 'rejected']);
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ===== WITHDRAWALS COLLECTION =====
    match /withdrawals/{withdrawalId} {
      // Users can read their own withdrawal requests
      allow read: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      
      // Users can create withdrawal requests
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        // Validate required fields
        request.resource.data.keys().hasAll(['userId', 'amount', 'method', 'wallet', 'status']) &&
        // Amount validation
        request.resource.data.amount is number &&
        request.resource.data.amount >= 10.00 && // Minimum withdrawal $10
        request.resource.data.amount <= 5000.00 && // Maximum withdrawal $5,000
        // Check user has sufficient balance (requires checking wallet)
        getUserBalance(request.auth.uid) >= request.resource.data.amount &&
        // Status must be pending initially
        request.resource.data.status == 'pending' &&
        // Method validation
        request.resource.data.method in ['bank_account', 'paypal', 'crypto_wallet', 'skrill', 'neteller'] &&
        // Wallet/account details required
        request.resource.data.wallet is string &&
        request.resource.data.wallet.size() > 5 &&
        // Timestamps
        request.resource.data.createdAt is timestamp;
      
      // Users can update their own pending requests
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        resource.data.status == 'pending' &&
        // Only allow updating specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['details', 'notes', 'updatedAt']);
      
      // Admins can update withdrawal status
      allow update: if isAdmin() && 
        // Only allow status changes and admin fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'status', 'approvedBy', 'rejectedBy', 'rejectionReason', 
          'approvedAt', 'rejectedAt', 'updatedAt'
        ]) &&
        // Status validation
        (request.resource.data.status in ['pending', 'approved', 'rejected']);
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // ===== ADMIN LOGS COLLECTION =====
    match /admin_logs/{logId} {
      // Only admins can read logs
      allow read: if isAdmin();
      
      // Only system can create logs (via admin functions)
      allow create: if isAdmin();
      
      // Prevent updates and deletions
      allow update, delete: if false;
    }
    
    // ===== SECURITY LOGS COLLECTION =====
    match /security_logs/{logId} {
      // Only system can create security logs
      allow create: if true; // Allow creation from client for login attempts
      
      // Only admins can read
      allow read: if isAdmin();
      
      // Prevent updates and deletions
      allow update, delete: if false;
    }
    
    // ===== FUNCTIONS =====
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Get user balance from wallet
    function getUserBalance(userId) {
      let wallet = get(/databases/$(database)/documents/wallets/$(userId));
      return wallet.data.balance;
    }
    
    // Check if email exists in wallets
    function emailExists(email) {
      return exists(/databases/$(database)/documents/wallets?where=("email","==",$(email))&limit=1);
    }
    
    // Check if username exists in wallets
    function usernameExists(username) {
      return exists(/databases/$(database)/documents/wallets?where=("username","==",$(username))&limit=1);
    }
    
    // Validate timestamp is recent (within 5 minutes)
    function isRecentTimestamp(timestamp) {
      return timestamp is timestamp &&
        timestamp <= request.time &&
        timestamp >= request.time - duration.value(5, 'm');
    }
    
    // ===== GLOBAL RULES =====
    
    // Deny all other operations by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
