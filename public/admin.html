<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Millioner Gaming</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===== RESET & VARIABLES ===== */
        :root {
            --admin-primary: #1a237e;
            --admin-secondary: #283593;
            --admin-accent: #5c6bc0;
            --admin-danger: #c62828;
            --admin-warning: #ff8f00;
            --admin-success: #2e7d32;
            --admin-info: #0277bd;
            
            --admin-dark: #0d1b2a;
            --admin-card: #1b263b;
            --admin-light: #415a77;
            --admin-border: #778da9;
            --admin-text: #e0e1dd;
            --admin-text-secondary: #778da9;
            --admin-bg: #0d1b2a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--admin-bg);
            color: var(--admin-text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--admin-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid var(--admin-light);
            border-top-color: var(--admin-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== ADMIN HEADER ===== */
        .admin-header {
            background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
            padding: 0 30px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .admin-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
            font-size: 20px;
            font-weight: 700;
        }
        
        .admin-logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .admin-badge.owner { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; }
        .admin-badge.finance { background: linear-gradient(135deg, var(--admin-success), #4caf50); color: white; }
        .admin-badge.accountant { background: linear-gradient(135deg, var(--admin-info), #03a9f4); color: white; }
        
        .admin-balance {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 600;
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logout-btn {
            background: rgba(198, 40, 40, 0.2);
            border: 1px solid rgba(198, 40, 40, 0.4);
            color: #ff6b6b;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background: rgba(198, 40, 40, 0.3);
            transform: translateY(-1px);
        }
        
        /* ===== SIDEBAR ===== */
        .admin-sidebar {
            position: fixed;
            top: 70px;
            left: 0;
            bottom: 0;
            width: 250px;
            background: var(--admin-card);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            padding: 20px 0;
            z-index: 90;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .menu-item {
            margin-bottom: 5px;
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: var(--admin-text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .menu-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--admin-text);
        }
        
        .menu-link.active {
            background: rgba(92, 107, 192, 0.1);
            color: var(--admin-accent);
            border-left-color: var(--admin-accent);
        }
        
        .menu-link i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .menu-label {
            font-weight: 500;
            font-size: 15px;
        }
        
        .menu-badge {
            margin-left: auto;
            background: var(--admin-accent);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 15px 25px;
        }
        
        .menu-section {
            padding: 15px 25px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--admin-text-secondary);
            font-weight: 600;
        }
        
        /* ===== MAIN CONTENT ===== */
        .admin-main {
            margin-left: 250px;
            margin-top: 70px;
            padding: 30px;
            min-height: calc(100vh - 70px);
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .page-title i {
            color: var(--admin-accent);
        }
        
        /* ===== DASHBOARD WIDGETS ===== */
        .dashboard-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .widget {
            background: var(--admin-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .widget:hover {
            transform: translateY(-5px);
            border-color: var(--admin-accent);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .widget-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--admin-text-secondary);
        }
        
        .widget-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .widget-icon.users { background: linear-gradient(135deg, #2196f3, #21cbf3); }
        .widget-icon.money { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        .widget-icon.transactions { background: linear-gradient(135deg, #ff9800, #ffc107); }
        .widget-icon.games { background: linear-gradient(135deg, #9c27b0, #e91e63); }
        
        .widget-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .widget-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .widget-change.positive {
            color: #4caf50;
        }
        
        .widget-change.negative {
            color: #f44336;
        }
        
        /* ===== CHARTS ===== */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--admin-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: white;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        /* ===== TABLES ===== */
        .table-container {
            background: var(--admin-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .admin-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--admin-text-secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .admin-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* ===== USER BADGES ===== */
        .user-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .user-badge.active { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .user-badge.suspended { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .user-badge.pending { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        
        /* ===== STATUS BADGES ===== */
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.completed { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-badge.pending { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .status-badge.failed { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        
        /* ===== FORMS ===== */
        .form-card {
            background: var(--admin-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--admin-text);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--admin-border);
            border-radius: 8px;
            color: var(--admin-text);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--admin-accent);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.1);
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--admin-text-secondary);
            margin-top: 5px;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--admin-secondary), var(--admin-primary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 53, 147, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--admin-success), #4caf50);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--admin-danger), #f44336);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--admin-warning), #ff9800);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--admin-text);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn.edit {
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }
        
        .action-btn.view {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .action-btn.suspend {
            background: rgba(255, 152, 0, 0.1);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .action-btn.delete {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }
        
        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: var(--admin-card);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--admin-text-secondary);
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--admin-text);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 90px;
            right: 30px;
            z-index: 1001;
        }
        
        .toast {
            background: var(--admin-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast.success .toast-icon {
            background: rgba(46, 125, 50, 0.1);
            color: #4caf50;
        }
        
        .toast.error .toast-icon {
            background: rgba(198, 40, 40, 0.1);
            color: #f44336;
        }
        
        .toast.warning .toast-icon {
            background: rgba(255, 143, 0, 0.1);
            color: #ff9800;
        }
        
        .toast.info .toast-icon {
            background: rgba(2, 119, 189, 0.1);
            color: #03a9f4;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .toast-message {
            font-size: 14px;
            color: var(--admin-text-secondary);
        }
        
        /* ===== SEARCH & FILTER ===== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--admin-text);
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--admin-text-secondary);
        }
        
        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--admin-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .page-btn.active {
            background: var(--admin-accent);
            color: white;
            border-color: var(--admin-accent);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .admin-sidebar {
                width: 70px;
            }
            
            .admin-main {
                margin-left: 70px;
            }
            
            .menu-label, .menu-badge, .menu-section {
                display: none;
            }
            
            .menu-link {
                justify-content: center;
                padding: 15px;
            }
            
            .menu-divider {
                margin: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-header {
                padding: 0 15px;
                height: 60px;
            }
            
            .admin-main {
                padding: 20px 15px;
                margin-left: 0;
                margin-top: 60px;
            }
            
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 250px;
            }
            
            .admin-sidebar.show {
                transform: translateX(0);
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-widgets {
                grid-template-columns: 1fr;
            }
            
            .widget {
                padding: 20px;
            }
            
            .modal {
                max-height: 80vh;
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        .mb-5 { margin-bottom: 30px; }
        
        .mt-3 { margin-top: 15px; }
        .mt-4 { margin-top: 20px; }
        .mt-5 { margin-top: 30px; }
        
        .text-success { color: #4caf50 !important; }
        .text-danger { color: #f44336 !important; }
        .text-warning { color: #ff9800 !important; }
        .text-info { color: #03a9f4 !important; }
        
        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--admin-accent);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--admin-secondary);
        }
        
        /* ===== LOADING STATE ===== */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <p>Loading Admin Dashboard...</p>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Admin Header -->
    <header class="admin-header">
        <div class="header-left">
            <button class="menu-toggle btn-secondary" style="display: none;" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <a href="#" class="admin-logo">
                <div class="admin-logo-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <span>Admin Panel</span>
            </a>
        </div>
        
        <div class="header-right">
            <div class="admin-info">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-crown"></i>
                    <span id="adminRole">Owner</span>
                </div>
                <div class="admin-balance">
                    <i class="fas fa-wallet"></i>
                    $<span id="adminBalance">0.00</span>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </header>
    
    <!-- Admin Sidebar -->
    <nav class="admin-sidebar" id="adminSidebar">
        <ul class="sidebar-menu">
            <div class="menu-section">Main</div>
            <li class="menu-item">
                <a href="#dashboard" class="menu-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="menu-label">Dashboard</span>
                </a>
            </li>
            
            <div class="menu-section">Management</div>
            <li class="menu-item">
                <a href="#users" class="menu-link">
                    <i class="fas fa-users"></i>
                    <span class="menu-label">Users</span>
                    <span class="menu-badge" id="userCountBadge">0</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#transactions" class="menu-link">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="menu-label">Transactions</span>
                    <span class="menu-badge" id="transactionBadge">0</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#financial" class="menu-link">
                    <i class="fas fa-chart-line"></i>
                    <span class="menu-label">Financial</span>
                    <span class="menu-badge" id="financialBadge">$0</span>
                </a>
            </li>
            
            <div class="menu-section">Actions</div>
            <li class="menu-item">
                <a href="#transfer" class="menu-link">
                    <i class="fas fa-money-bill-transfer"></i>
                    <span class="menu-label">Transfer Funds</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#adjust" class="menu-link">
                    <i class="fas fa-sliders-h"></i>
                    <span class="menu-label">Adjust Balance</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#support" class="menu-link">
                    <i class="fas fa-headset"></i>
                    <span class="menu-label">Support</span>
                    <span class="menu-badge" id="supportBadge">0</span>
                </a>
            </li>
            
            <div class="menu-divider"></div>
            
            <li class="menu-item">
                <a href="#audit" class="menu-link">
                    <i class="fas fa-history"></i>
                    <span class="menu-label">Audit Log</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="#settings" class="menu-link">
                    <i class="fas fa-cog"></i>
                    <span class="menu-label">Settings</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-main" id="adminMain">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page-content">
            <h1 class="page-title">
                <i class="fas fa-tachometer-alt"></i>
                Admin Dashboard
            </h1>
            
            <!-- Stats Widgets -->
            <div class="dashboard-widgets">
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Total Users</h3>
                        <div class="widget-icon users">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="totalUsers">0</div>
                    <div class="widget-change positive" id="userChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Total Balance</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="totalBalance">$0</div>
                    <div class="widget-change positive" id="balanceChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>+$0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Today's Transactions</h3>
                        <div class="widget-icon transactions">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="todayTransactions">0</div>
                    <div class="widget-change positive" id="transactionChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Active Games</h3>
                        <div class="widget-icon games">
                            <i class="fas fa-gamepad"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="activeGames">0</div>
                    <div class="widget-change negative" id="gameChange">
                        <i class="fas fa-arrow-down"></i>
                        <span>-0 today</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Revenue Overview</h3>
                    <div class="chart-wrapper">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">User Activity</h3>
                    <div class="chart-wrapper">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Transactions</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshTransactions()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentTransactionsTable">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Recent Users -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Users</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshUsers()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsersTable">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Users Page -->
        <div id="usersPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-users"></i>
                User Management
            </h1>
            
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="userSearch" class="search-input" placeholder="Search users by email, username, or ID...">
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">All Users</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="exportUsers()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i>
                            Add User
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Balance</th>
                                <th>Status</th>
                                <th>Transactions</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <!-- All users will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="userPagination">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Transactions Page -->
        <div id="transactionsPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-exchange-alt"></i>
                Transaction Management
            </h1>
            
            <!-- Filters -->
            <div class="filters-container mb-4">
                <div class="form-row" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="transactionTypeFilter" class="form-control" style="flex: 1; min-width: 150px;">
                        <option value="all">All Types</option>
                        <option value="deposit">Deposit</option>
                        <option value="withdraw">Withdrawal</option>
                        <option value="send">Send</option>
                        <option value="receive">Receive</option>
                        <option value="game">Game</option>
                    </select>
                    
                    <select id="transactionStatusFilter" class="form-control" style="flex: 1; min-width: 150px;">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                    
                    <input type="date" id="transactionDateFilter" class="form-control" style="flex: 1; min-width: 150px;">
                    
                    <button class="btn btn-primary" onclick="applyTransactionFilters()">
                        <i class="fas fa-filter"></i>
                        Apply Filters
                    </button>
                    
                    <button class="btn btn-secondary" onclick="resetTransactionFilters()">
                        <i class="fas fa-redo"></i>
                        Reset
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">All Transactions</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="exportTransactions()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Fee</th>
                                <th>Status</th>
                                <th>Description</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allTransactionsTable">
                            <!-- All transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="transactionPagination">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Financial Page -->
        <div id="financialPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                Financial Overview
            </h1>
            
            <!-- Financial Stats -->
            <div class="dashboard-widgets">
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Total Deposits</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="totalDeposits">$0</div>
                    <div class="widget-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>All time</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Total Withdrawals</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="totalWithdrawals">$0</div>
                    <div class="widget-change negative">
                        <i class="fas fa-arrow-up"></i>
                        <span>All time</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Platform Revenue</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="platformRevenue">$0</div>
                    <div class="widget-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>This month</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Pending Withdrawals</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="pendingWithdrawals">$0</div>
                    <div class="widget-change warning">
                        <i class="fas fa-exclamation"></i>
                        <span>Requires action</span>
                    </div>
                </div>
            </div>
            
            <!-- Financial Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Daily Financial Flow</h3>
                    <div class="chart-wrapper">
                        <canvas id="financialChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <h3 class="chart-title">Payment Methods</h3>
                    <div class="chart-wrapper">
                        <canvas id="paymentMethodsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Pending Withdrawals -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Pending Withdrawals</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="processAllWithdrawals()">
                            <i class="fas fa-check-double"></i>
                            Process All
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Withdrawal ID</th>
                                <th>User</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Account Details</th>
                                <th>Requested</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingWithdrawalsTable">
                            <!-- Pending withdrawals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Transfer Funds Page -->
        <div id="transferPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-money-bill-transfer"></i>
                Transfer Funds
            </h1>
            
            <div class="form-card">
                <div class="form-group">
                    <label class="form-label">Transfer Type</label>
                    <select id="transferType" class="form-control" onchange="updateTransferType()">
                        <option value="admin_to_user">Admin → User</option>
                        <option value="admin_to_admin">Admin → Admin</option>
                        <option value="user_to_admin">User → Admin</option>
                        <option value="user_to_user">User → User</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="fromLabel">From (Admin)</label>
                    <input type="text" id="fromEmail" class="form-control" value="owner@millioner.com" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="toLabel">To (User Email)</label>
                    <input type="email" id="toEmail" class="form-control" placeholder="Enter recipient email" required>
                    <div class="form-hint" id="toHint">Enter the recipient's email address</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" id="transferAmount" class="form-control" placeholder="0.00" min="0.01" step="0.01" required>
                    <div class="form-hint">
                        Available: $<span id="availableAmount">0.00</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="transferDescription" class="form-control" placeholder="Enter transaction description">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction Fee</label>
                    <input type="number" id="transferFee" class="form-control" value="0.00" readonly>
                </div>
                
                <div class="form-group" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Amount:</span>
                        <span>$<span id="displayAmount">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Fee:</span>
                        <span>$<span id="displayFee">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600; font-size: 18px;">
                        <span>Total:</span>
                        <span>$<span id="displayTotal">0.00</span></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="transferConfirmation" required>
                        <span style="margin-left: 8px;">I confirm this transfer is authorized and legitimate</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="clearTransferForm()">
                        <i class="fas fa-times"></i>
                        Clear
                    </button>
                    <button type="button" class="btn btn-primary" id="transferBtn" onclick="processTransfer()">
                        <i class="fas fa-paper-plane"></i>
                        Process Transfer
                    </button>
                </div>
            </div>
            
            <!-- Transfer History -->
            <div class="table-container mt-5">
                <div class="table-header">
                    <h3 class="table-title">Recent Transfers</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="loadTransferHistory()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Amount</th>
                                <th>Fee</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Admin</th>
                            </tr>
                        </thead>
                        <tbody id="transferHistoryTable">
                            <!-- Transfer history will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Adjust Balance Page -->
        <div id="adjustPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-sliders-h"></i>
                Balance Adjustment
            </h1>
            
            <div class="form-card">
                <div class="form-group">
                    <label class="form-label">User Email</label>
                    <input type="email" id="adjustEmail" class="form-control" placeholder="user@example.com" required>
                    <div class="form-hint">Enter the user's email address</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Current Balance</label>
                    <input type="text" id="currentUserBalance" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Adjustment Type</label>
                    <select id="adjustmentType" class="form-control">
                        <option value="add">Add Funds</option>
                        <option value="subtract">Subtract Funds</option>
                        <option value="set">Set Balance</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" id="adjustmentAmount" class="form-control" placeholder="0.00" min="0" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <select id="adjustmentReason" class="form-control">
                        <option value="bonus">Bonus Payment</option>
                        <option value="refund">Refund</option>
                        <option value="correction">Balance Correction</option>
                        <option value="compensation">User Compensation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="adjustmentDescription" class="form-control" rows="3" placeholder="Provide details for this adjustment" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Balance</label>
                    <input type="text" id="newBalance" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="adjustmentConfirmation" required>
                        <span style="margin-left: 8px;">I confirm this adjustment is authorized and properly documented</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="clearAdjustmentForm()">
                        <i class="fas fa-times"></i>
                        Clear
                    </button>
                    <button type="button" class="btn btn-warning" id="adjustBtn" onclick="processAdjustment()">
                        <i class="fas fa-check-circle"></i>
                        Process Adjustment
                    </button>
                </div>
            </div>
            
            <!-- Adjustment History -->
            <div class="table-container mt-5">
                <div class="table-header">
                    <h3 class="table-title">Recent Adjustments</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="loadAdjustmentHistory()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Description</th>
                                <th>Admin</th>
                            </tr>
                        </thead>
                        <tbody id="adjustmentHistoryTable">
                            <!-- Adjustment history will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Support Page -->
        <div id="supportPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-headset"></i>
                Support Tickets
            </h1>
            
            <div class="dashboard-widgets">
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Open Tickets</h3>
                        <div class="widget-icon users">
                            <i class="fas fa-inbox"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="openTickets">0</div>
                    <div class="widget-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">In Progress</h3>
                        <div class="widget-icon money">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="inProgressTickets">0</div>
                    <div class="widget-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Resolved</h3>
                        <div class="widget-icon transactions">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="resolvedTickets">0</div>
                    <div class="widget-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0 today</span>
                    </div>
                </div>
                
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Avg Response Time</h3>
                        <div class="widget-icon games">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="widget-value" id="avgResponseTime">0h</div>
                    <div class="widget-change negative">
                        <i class="fas fa-arrow-down"></i>
                        <span>-0h today</span>
                    </div>
                </div>
            </div>
            
            <!-- Support Tickets Table -->
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Tickets</h3>
                    <div class="table-actions">
                        <select id="ticketStatusFilter" class="form-control" style="width: auto;" onchange="filterTickets()">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Ticket ID</th>
                                <th>User</th>
                                <th>Subject</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Last Update</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supportTicketsTable">
                            <!-- Tickets will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Audit Log Page -->
        <div id="auditPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-history"></i>
                Audit Log
            </h1>
            
            <div class="search-box mb-4">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="auditSearch" class="search-input" placeholder="Search audit logs...">
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">All Activities</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-secondary" onclick="exportAuditLog()">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable">
                            <!-- Audit logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div id="settingsPage" class="page-content hidden">
            <h1 class="page-title">
                <i class="fas fa-cog"></i>
                Admin Settings
            </h1>
            
            <div class="form-card">
                <h3 style="margin-bottom: 20px; color: white;">Profile Settings</h3>
                
                <div class="form-group">
                    <label class="form-label">Admin Name</label>
                    <input type="text" id="adminName" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Admin Email</label>
                    <input type="email" id="adminEmailDisplay" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Admin Role</label>
                    <input type="text" id="adminRoleDisplay" class="form-control" readonly>
                </div>
                
                <h3 style="margin: 30px 0 20px; color: white;">Security Settings</h3>
                
                <div class="form-group">
                    <label class="form-label">Change Password</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="New password">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Session Timeout</label>
                    <select id="sessionTimeout" class="form-control">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="emailNotifications">
                        <span style="margin-left: 8px;">Enable email notifications</span>
                    </label>
                </div>
                
                <div style="margin-top: 30px;">
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <!-- User Details Modal -->
        <div class="modal hidden" id="userDetailsModal">
            <div class="modal-header">
                <h3 class="modal-title">User Details</h3>
                <button class="modal-close" onclick="closeModal('userDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <!-- User details will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Transaction Details Modal -->
        <div class="modal hidden" id="transactionDetailsModal">
            <div class="modal-header">
                <h3 class="modal-title">Transaction Details</h3>
                <button class="modal-close" onclick="closeModal('transactionDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="transactionDetailsContent">
                    <!-- Transaction details will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Add User Modal -->
        <div class="modal hidden" id="addUserModal">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="newUsername" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="newUserEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="newUserPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Initial Balance</label>
                        <input type="number" id="newUserBalance" class="form-control" value="0" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="newUserRole" class="form-control">
                            <option value="user">Regular User</option>
                            <option value="vip">VIP User</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createNewUser()">Create User</button>
            </div>
        </div>
        
        <!-- Edit User Modal -->
        <div class="modal hidden" id="editUserModal">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="editUsername" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="editUserEmail" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Balance</label>
                        <input type="number" id="editUserBalance" class="form-control" min="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="editUserStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="suspended">Suspended</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="editUserRole" class="form-control">
                            <option value="user">Regular User</option>
                            <option value="vip">VIP User</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reset Password</label>
                        <input type="password" id="editUserPassword" class="form-control" placeholder="Leave empty to keep current">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">Save Changes</button>
            </div>
        </div>
        
        <!-- Confirm Action Modal -->
        <div class="modal hidden" id="confirmModal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmActionBtn" onclick="executeConfirmedAction()">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyA72Yo_YGqno9PX25p3yQBvyflcaM-NqEM",
            authDomain: "x-bet-prod-jd.firebasestorage.app",
            projectId: "x-bet-prod-jd",
            storageBucket: "x-bet-prod-jd.firebasestorage.app",
            messagingSenderId: "499334334535",
            appId: "1:499334334535:web:bebc1bf817e24d9e3c4962",
            measurementId: "G-PTV4XMYQ6P"
        };
        
        // ===== GLOBAL VARIABLES =====
        let auth, db;
        let adminData = null;
        let currentAdmin = null;
        let userDataCache = {};
        let currentPage = 'dashboard';
        let charts = {};
        
        // ===== ADMIN ROLES & PERMISSIONS =====
        const ADMIN_PERMISSIONS = {
            owner: {
                canViewUsers: true,
                canEditUsers: true,
                canDeleteUsers: true,
                canViewTransactions: true,
                canEditTransactions: true,
                canTransferFunds: true,
                canAdjustBalances: true,
                canViewFinancial: true,
                canProcessWithdrawals: true,
                canViewSupport: true,
                canEditSupport: true,
                canViewAudit: true,
                canEditSettings: true,
                transferLimit: 1000000,
                dailyTransferLimit: 5000000
            },
            finance: {
                canViewUsers: true,
                canEditUsers: false,
                canDeleteUsers: false,
                canViewTransactions: true,
                canEditTransactions: true,
                canTransferFunds: true,
                canAdjustBalances: true,
                canViewFinancial: true,
                canProcessWithdrawals: true,
                canViewSupport: false,
                canEditSupport: false,
                canViewAudit: true,
                canEditSettings: false,
                transferLimit: 50000,
                dailyTransferLimit: 200000
            },
            accountant: {
                canViewUsers: true,
                canEditUsers: false,
                canDeleteUsers: false,
                canViewTransactions: true,
                canEditTransactions: false,
                canTransferFunds: false,
                canAdjustBalances: false,
                canViewFinancial: true,
                canProcessWithdrawals: false,
                canViewSupport: false,
                canEditSupport: false,
                canViewAudit: true,
                canEditSettings: false,
                transferLimit: 0,
                dailyTransferLimit: 0
            }
        };
        
        // ===== ADMIN CREDENTIALS =====
        const ADMIN_CREDENTIALS = {
            owner: {
                email: "owner@millioner.com",
                password: "Owner@123456",
                name: "Platform Owner",
                balance: 14050000.00
            },
            finance: {
                email: "finance@millioner.com",
                password: "Finance@123456",
                name: "Finance Manager",
                balance: 0.00
            },
            accountant: {
                email: "accountant@millioner.com",
                password: "Accountant@123456",
                name: "Senior Accountant",
                balance: 0.00
            }
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check if admin is logged in
                checkAdminSession();
                
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
                db = firebase.firestore();
                
                console.log("Admin Dashboard initialized");
                
                // Setup event listeners
                setupEventListeners();
                
                // Load initial data
                await loadDashboardData();
                
                // Initialize charts
                initializeCharts();
                
                // Update admin info
                updateAdminInfo();
                
                // Setup real-time listeners
                setupRealtimeListeners();
                
                // Hide loading overlay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1000);
                
            } catch (error) {
                console.error("Initialization error:", error);
                showToast('error', 'Error', 'Failed to initialize admin dashboard');
                logoutAdmin();
            }
        });
        
        // ===== CHECK ADMIN SESSION =====
        function checkAdminSession() {
            const adminDataStr = localStorage.getItem('adminData');
            const sessionTime = localStorage.getItem('adminSessionTime');
            
            if (!adminDataStr || !sessionTime) {
                logoutAdmin();
                return;
            }
            
            try {
                adminData = JSON.parse(adminDataStr);
                const now = Date.now();
                const sessionAge = now - parseInt(sessionTime);
                
                // Check if session is expired (30 minutes)
                if (sessionAge > 30 * 60 * 1000) {
                    showToast('warning', 'Session Expired', 'Your admin session has expired');
                    logoutAdmin();
                    return;
                }
                
                // Update session time
                localStorage.setItem('adminSessionTime', now.toString());
                
                // Set current admin
                currentAdmin = adminData;
                
            } catch (error) {
                console.error("Error parsing admin data:", error);
                logoutAdmin();
            }
        }
        
        // ===== UPDATE ADMIN INFO =====
        function updateAdminInfo() {
            if (!currentAdmin) return;
            
            // Update role badge
            const adminBadge = document.getElementById('adminBadge');
            adminBadge.className = `admin-badge ${currentAdmin.role}`;
            adminBadge.innerHTML = `
                <i class="fas fa-${currentAdmin.role === 'owner' ? 'crown' : currentAdmin.role === 'finance' ? 'chart-line' : 'calculator'}"></i>
                <span id="adminRole">${currentAdmin.name}</span>
            `;
            
            // Update balance
            document.getElementById('adminBalance').textContent = currentAdmin.balance.toFixed(2);
            
            // Update settings page
            document.getElementById('adminName').value = currentAdmin.name;
            document.getElementById('adminEmailDisplay').value = currentAdmin.email;
            document.getElementById('adminRoleDisplay').value = currentAdmin.role.charAt(0).toUpperCase() + currentAdmin.role.slice(1);
            
            // Update available amount for transfer
            document.getElementById('availableAmount').textContent = currentAdmin.balance.toFixed(2);
            
            // Hide/show menu items based on permissions
            updateMenuPermissions();
        }
        
        // ===== UPDATE MENU PERMISSIONS =====
        function updateMenuPermissions() {
            if (!currentAdmin) return;
            
            const permissions = ADMIN_PERMISSIONS[currentAdmin.role];
            
            // Hide menu items based on permissions
            const menuItems = {
                'users': permissions.canViewUsers,
                'transactions': permissions.canViewTransactions,
                'financial': permissions.canViewFinancial,
                'transfer': permissions.canTransferFunds,
                'adjust': permissions.canAdjustBalances,
                'support': permissions.canViewSupport,
                'audit': permissions.canViewAudit,
                'settings': permissions.canEditSettings
            };
            
            // Update menu visibility
            document.querySelectorAll('.menu-link').forEach(link => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    const page = href.substring(1);
                    if (menuItems.hasOwnProperty(page)) {
                        const menuItem = link.closest('.menu-item');
                        if (menuItem) {
                            menuItem.style.display = menuItems[page] ? '' : 'none';
                        }
                    }
                }
            });
        }
        
        // ===== SETUP EVENT LISTENERS =====
        function setupEventListeners() {
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logoutAdmin);
            
            // Menu toggle for mobile
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    document.getElementById('adminSidebar').classList.toggle('show');
                });
            }
            
            // Sidebar navigation
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const target = link.getAttribute('href');
                    if (target.startsWith('#')) {
                        navigateTo(target.substring(1));
                    }
                    
                    // Update active state
                    document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('adminSidebar').classList.remove('show');
                    }
                });
            });
            
            // Transfer amount calculation
            const transferAmountInput = document.getElementById('transferAmount');
            if (transferAmountInput) {
                transferAmountInput.addEventListener('input', updateTransferCalculations);
            }
            
            // User search
            const userSearchInput = document.getElementById('userSearch');
            if (userSearchInput) {
                userSearchInput.addEventListener('input', debounce(searchUsers, 500));
            }
            
            // Audit search
            const auditSearchInput = document.getElementById('auditSearch');
            if (auditSearchInput) {
                auditSearchInput.addEventListener('input', debounce(searchAuditLogs, 500));
            }
            
            // Adjustment calculations
            const adjustmentAmountInput = document.getElementById('adjustmentAmount');
            if (adjustmentAmountInput) {
                adjustmentAmountInput.addEventListener('input', updateAdjustmentCalculations);
            }
            
            // Check session every minute
            setInterval(checkAdminSession, 60000);
            
            // Prevent navigation away without saving
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
        }
        
        // ===== NAVIGATION =====
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            const pageElement = document.getElementById(`${page}Page`);
            if (pageElement) {
                pageElement.classList.remove('hidden');
                currentPage = page;
                
                // Load page-specific data
                switch(page) {
                    case 'users':
                        loadAllUsers();
                        break;
                    case 'transactions':
                        loadAllTransactions();
                        break;
                    case 'financial':
                        loadFinancialData();
                        break;
                    case 'transfer':
                        loadTransferHistory();
                        break;
                    case 'adjust':
                        loadAdjustmentHistory();
                        break;
                    case 'support':
                        loadSupportTickets();
                        break;
                    case 'audit':
                        loadAuditLogs();
                        break;
                    case 'settings':
                        // Already loaded
                        break;
                }
            }
        }
        
        // ===== DASHBOARD DATA =====
        async function loadDashboardData() {
            try {
                // Load users count
                const usersSnapshot = await db.collection('wallets').get();
                const totalUsers = usersSnapshot.size;
                document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
                document.getElementById('userCountBadge').textContent = totalUsers;
                
                // Calculate total balance
                let totalBalance = 0;
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    totalBalance += data.balance || 0;
                });
                document.getElementById('totalBalance').textContent = `$${totalBalance.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                // Load today's transactions
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const transactionsSnapshot = await db.collection('transactions')
                    .where('timestamp', '>=', today)
                    .where('timestamp', '<', tomorrow)
                    .get();
                
                const todayTransactions = transactionsSnapshot.size;
                document.getElementById('todayTransactions').textContent = todayTransactions.toLocaleString();
                document.getElementById('transactionBadge').textContent = todayTransactions;
                
                // Load recent transactions
                await loadRecentTransactions();
                
                // Load recent users
                await loadRecentUsers();
                
                // Update financial badge
                document.getElementById('financialBadge').textContent = `$${(totalBalance/1000).toFixed(0)}k`;
                
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                showToast('error', 'Load Error', 'Failed to load dashboard data');
            }
        }
        
        // ===== LOAD RECENT TRANSACTIONS =====
        async function loadRecentTransactions() {
            try {
                const snapshot = await db.collection('transactions')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .get();
                
                const tableBody = document.getElementById('recentTransactionsTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createTransactionRow(doc.id, data);
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading recent transactions:", error);
            }
        }
        
        // ===== LOAD RECENT USERS =====
        async function loadRecentUsers() {
            try {
                const snapshot = await db.collection('wallets')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const tableBody = document.getElementById('recentUsersTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createUserRow(doc.id, data);
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading recent users:", error);
            }
        }
        
        // ===== CREATE TRANSACTION ROW =====
        function createTransactionRow(id, data) {
            const row = document.createElement('tr');
            
            // Format date
            const date = data.timestamp?.toDate 
                ? data.timestamp.toDate().toLocaleDateString() + ' ' + data.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                : 'Unknown';
            
            // Status badge
            const statusClass = data.status === 'completed' ? 'completed' : 
                              data.status === 'pending' ? 'pending' : 'failed';
            
            // Type icon
            const typeIcon = data.type === 'deposit' ? 'arrow-down' :
                           data.type === 'withdraw' ? 'arrow-up' :
                           data.type === 'send' ? 'paper-plane' :
                           data.type === 'receive' ? 'download' : 'exchange-alt';
            
            row.innerHTML = `
                <td><small>${id.substring(0, 8)}...</small></td>
                <td>${data.username || data.userEmail || 'Unknown'}</td>
                <td>
                    <i class="fas fa-${typeIcon}"></i>
                    ${data.type}
                </td>
                <td>$${(data.amount || 0).toFixed(2)}</td>
                <td><span class="status-badge ${statusClass}">${data.status}</span></td>
                <td><small>${date}</small></td>
                <td>
                    <button class="action-btn view" onclick="viewTransaction('${id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                </td>
            `;
            
            return row;
        }
        
        // ===== CREATE USER ROW =====
        function createUserRow(id, data) {
            const row = document.createElement('tr');
            
            // Format date
            const date = data.createdAt?.toDate 
                ? data.createdAt.toDate().toLocaleDateString()
                : 'Unknown';
            
            // Status badge
            const statusClass = data.status === 'active' ? 'active' :
                              data.status === 'suspended' ? 'suspended' : 'pending';
            
            row.innerHTML = `
                <td><small>${id.substring(0, 8)}...</small></td>
                <td>${data.username || 'Unknown'}</td>
                <td><small>${data.email || 'No email'}</small></td>
                <td>$${(data.balance || 0).toFixed(2)}</td>
                <td><span class="user-badge ${statusClass}">${data.status || 'active'}</span></td>
                <td><small>${date}</small></td>
                <td>
                    <button class="action-btn view" onclick="viewUser('${id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    ${ADMIN_PERMISSIONS[currentAdmin.role].canEditUsers ? `
                    <button class="action-btn edit" onclick="editUser('${id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    ` : ''}
                </td>
            `;
            
            return row;
        }
        
        // ===== VIEW TRANSACTION =====
        async function viewTransaction(transactionId) {
            try {
                const doc = await db.collection('transactions').doc(transactionId).get();
                if (!doc.exists) {
                    showToast('error', 'Error', 'Transaction not found');
                    return;
                }
                
                const data = doc.data();
                const content = document.getElementById('transactionDetailsContent');
                
                // Format date
                const date = data.timestamp?.toDate 
                    ? data.timestamp.toDate().toLocaleString()
                    : 'Unknown';
                
                content.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <strong>Transaction ID:</strong>
                            <div><small>${transactionId}</small></div>
                        </div>
                        
                        <div>
                            <strong>User:</strong>
                            <div>${data.username || data.userEmail || 'Unknown'}</div>
                        </div>
                        
                        <div>
                            <strong>Type:</strong>
                            <div>${data.type}</div>
                        </div>
                        
                        <div>
                            <strong>Amount:</strong>
                            <div style="font-size: 24px; font-weight: bold; color: ${data.type === 'deposit' || data.type === 'receive' ? '#4caf50' : '#f44336'}">
                                ${data.type === 'deposit' || data.type === 'receive' ? '+' : '-'}$${(data.amount || 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div>
                            <strong>Status:</strong>
                            <span class="status-badge ${data.status === 'completed' ? 'completed' : data.status === 'pending' ? 'pending' : 'failed'}">
                                ${data.status}
                            </span>
                        </div>
                        
                        <div>
                            <strong>Description:</strong>
                            <div>${data.description || 'No description'}</div>
                        </div>
                        
                        <div>
                            <strong>Date:</strong>
                            <div>${date}</div>
                        </div>
                        
                        ${data.previousBalance !== undefined ? `
                        <div>
                            <strong>Previous Balance:</strong>
                            <div>$${(data.previousBalance || 0).toFixed(2)}</div>
                        </div>
                        ` : ''}
                        
                        ${data.newBalance !== undefined ? `
                        <div>
                            <strong>New Balance:</strong>
                            <div>$${(data.newBalance || 0).toFixed(2)}</div>
                        </div>
                        ` : ''}
                        
                        ${data.senderEmail ? `
                        <div>
                            <strong>Sender:</strong>
                            <div>${data.senderEmail}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                showModal('transactionDetailsModal');
                
            } catch (error) {
                console.error("Error viewing transaction:", error);
                showToast('error', 'Error', 'Failed to load transaction details');
            }
        }
        
        // ===== VIEW USER =====
        async function viewUser(userId) {
            try {
                const doc = await db.collection('wallets').doc(userId).get();
                if (!doc.exists) {
                    showToast('error', 'Error', 'User not found');
                    return;
                }
                
                const data = doc.data();
                const content = document.getElementById('userDetailsContent');
                
                // Format dates
                const createdDate = data.createdAt?.toDate 
                    ? data.createdAt.toDate().toLocaleDateString()
                    : 'Unknown';
                
                const updatedDate = data.updatedAt?.toDate 
                    ? data.updatedAt.toDate().toLocaleDateString()
                    : 'Unknown';
                
                content.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <strong>User ID:</strong>
                            <div><small>${userId}</small></div>
                        </div>
                        
                        <div>
                            <strong>Username:</strong>
                            <div>${data.username || 'Unknown'}</div>
                        </div>
                        
                        <div>
                            <strong>Email:</strong>
                            <div>${data.email || 'No email'}</div>
                        </div>
                        
                        <div>
                            <strong>Wallet ID:</strong>
                            <div><small>${data.walletId || 'N/A'}</small></div>
                        </div>
                        
                        <div>
                            <strong>Balance:</strong>
                            <div style="font-size: 24px; font-weight: bold; color: #4caf50">
                                $${(data.balance || 0).toFixed(2)}
                            </div>
                        </div>
                        
                        <div>
                            <strong>Status:</strong>
                            <span class="user-badge ${data.status === 'active' ? 'active' : data.status === 'suspended' ? 'suspended' : 'pending'}">
                                ${data.status || 'active'}
                            </span>
                        </div>
                        
                        <div>
                            <strong>Member Since:</strong>
                            <div>${createdDate}</div>
                        </div>
                        
                        <div>
                            <strong>Last Updated:</strong>
                            <div>${updatedDate}</div>
                        </div>
                        
                        <div>
                            <strong>Total Transactions:</strong>
                            <div>${data.transactionCount || 0}</div>
                        </div>
                        
                        ${data.totalDeposits !== undefined ? `
                        <div>
                            <strong>Total Deposits:</strong>
                            <div>$${(data.totalDeposits || 0).toFixed(2)}</div>
                        </div>
                        ` : ''}
                        
                        ${data.totalWithdrawn !== undefined ? `
                        <div>
                            <strong>Total Withdrawn:</strong>
                            <div>$${(data.totalWithdrawn || 0).toFixed(2)}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        ${ADMIN_PERMISSIONS[currentAdmin.role].canEditUsers ? `
                        <button class="btn btn-primary" onclick="editUser('${userId}')">
                            <i class="fas fa-edit"></i>
                            Edit User
                        </button>
                        ` : ''}
                        
                        ${ADMIN_PERMISSIONS[currentAdmin.role].canTransferFunds ? `
                        <button class="btn btn-success" onclick="transferToUser('${data.email}')">
                            <i class="fas fa-money-bill-transfer"></i>
                            Transfer Funds
                        </button>
                        ` : ''}
                    </div>
                `;
                
                showModal('userDetailsModal');
                
            } catch (error) {
                console.error("Error viewing user:", error);
                showToast('error', 'Error', 'Failed to load user details');
            }
        }
        
        // ===== EDIT USER =====
        async function editUser(userId) {
            try {
                const doc = await db.collection('wallets').doc(userId).get();
                if (!doc.exists) {
                    showToast('error', 'Error', 'User not found');
                    return;
                }
                
                const data = doc.data();
                
                // Populate form
                document.getElementById('editUsername').value = data.username || '';
                document.getElementById('editUserEmail').value = data.email || '';
                document.getElementById('editUserBalance').value = data.balance || 0;
                document.getElementById('editUserStatus').value = data.status || 'active';
                document.getElementById('editUserRole').value = data.role || 'user';
                
                // Store user ID for saving
                document.getElementById('editUserForm').dataset.userId = userId;
                
                showModal('editUserModal');
                
            } catch (error) {
                console.error("Error loading user for edit:", error);
                showToast('error', 'Error', 'Failed to load user data');
            }
        }
        
        // ===== SAVE USER CHANGES =====
        async function saveUserChanges() {
            try {
                const form = document.getElementById('editUserForm');
                const userId = form.dataset.userId;
                
                if (!userId) {
                    showToast('error', 'Error', 'No user selected');
                    return;
                }
                
                const updates = {
                    username: document.getElementById('editUsername').value,
                    balance: parseFloat(document.getElementById('editUserBalance').value) || 0,
                    status: document.getElementById('editUserStatus').value,
                    role: document.getElementById('editUserRole').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update user in Firestore
                await db.collection('wallets').doc(userId).update(updates);
                
                // Log the action
                await logAdminAction('user_updated', {
                    userId: userId,
                    updates: updates,
                    admin: currentAdmin.email
                });
                
                showToast('success', 'Success', 'User updated successfully');
                closeModal('editUserModal');
                
                // Refresh user lists
                if (currentPage === 'users') {
                    loadAllUsers();
                } else if (currentPage === 'dashboard') {
                    loadRecentUsers();
                }
                
            } catch (error) {
                console.error("Error saving user changes:", error);
                showToast('error', 'Error', 'Failed to update user');
            }
        }
        
        // ===== TRANSFER FUNDS =====
        async function processTransfer() {
            try {
                if (!ADMIN_PERMISSIONS[currentAdmin.role].canTransferFunds) {
                    showToast('error', 'Permission Denied', 'You are not authorized to transfer funds');
                    return;
                }
                
                const transferType = document.getElementById('transferType').value;
                const fromEmail = document.getElementById('fromEmail').value;
                const toEmail = document.getElementById('toEmail').value.trim();
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const description = document.getElementById('transferDescription').value;
                const fee = parseFloat(document.getElementById('transferFee').value) || 0;
                const total = amount + fee;
                
                // Validation
                if (!toEmail || !amount || amount <= 0) {
                    showToast('error', 'Validation Error', 'Please enter valid recipient and amount');
                    return;
                }
                
                if (!document.getElementById('transferConfirmation').checked) {
                    showToast('error', 'Confirmation Required', 'Please confirm the transfer');
                    return;
                }
                
                // Check admin balance
                if (total > currentAdmin.balance) {
                    showToast('error', 'Insufficient Funds', 'Admin balance is insufficient for this transfer');
                    return;
                }
                
                // Check transfer limits
                const permissions = ADMIN_PERMISSIONS[currentAdmin.role];
                if (amount > permissions.transferLimit) {
                    showToast('error', 'Limit Exceeded', `Transfer amount exceeds your limit of $${permissions.transferLimit.toLocaleString()}`);
                    return;
                }
                
                // Check if recipient exists
                let recipientData = null;
                let recipientId = null;
                
                // Search for recipient
                const recipientQuery = await db.collection('wallets')
                    .where('email', '==', toEmail.toLowerCase())
                    .limit(1)
                    .get();
                
                if (!recipientQuery.empty) {
                    recipientData = recipientQuery.docs[0].data();
                    recipientId = recipientQuery.docs[0].id;
                }
                
                // For admin-to-admin transfers
                if (transferType === 'admin_to_admin') {
                    // Check if recipient is an admin
                    const isAdmin = Object.values(ADMIN_CREDENTIALS).some(admin => admin.email === toEmail);
                    if (!isAdmin) {
                        showToast('error', 'Invalid Recipient', 'Recipient must be an admin');
                        return;
                    }
                    
                    // Process admin-to-admin transfer
                    await processAdminToAdminTransfer(fromEmail, toEmail, amount, description);
                    
                } else if (transferType === 'admin_to_user') {
                    // Admin to user transfer
                    if (!recipientData) {
                        showToast('error', 'User Not Found', 'No user found with that email');
                        return;
                    }
                    
                    await processAdminToUserTransfer(fromEmail, toEmail, amount, description, recipientId, recipientData);
                    
                } else if (transferType === 'user_to_admin') {
                    // User to admin transfer
                    if (!recipientData) {
                        showToast('error', 'User Not Found', 'No user found with that email');
                        return;
                    }
                    
                    // Check if user has sufficient balance
                    if (total > recipientData.balance) {
                        showToast('error', 'Insufficient Funds', 'User does not have sufficient balance');
                        return;
                    }
                    
                    await processUserToAdminTransfer(fromEmail, toEmail, amount, description, recipientId, recipientData);
                    
                } else if (transferType === 'user_to_user') {
                    // User to user transfer
                    const fromUserEmail = fromEmail;
                    const toUserEmail = toEmail;
                    
                    // Check both users exist
                    const fromUserQuery = await db.collection('wallets')
                        .where('email', '==', fromUserEmail.toLowerCase())
                        .limit(1)
                        .get();
                    
                    if (fromUserQuery.empty) {
                        showToast('error', 'Sender Not Found', 'No user found with sender email');
                        return;
                    }
                    
                    if (!recipientData) {
                        showToast('error', 'Recipient Not Found', 'No user found with recipient email');
                        return;
                    }
                    
                    const fromUserData = fromUserQuery.docs[0].data();
                    const fromUserId = fromUserQuery.docs[0].id;
                    
                    // Check if sender has sufficient balance
                    if (total > fromUserData.balance) {
                        showToast('error', 'Insufficient Funds', 'Sender does not have sufficient balance');
                        return;
                    }
                    
                    await processUserToUserTransfer(fromUserEmail, toUserEmail, amount, description, fromUserId, fromUserData, recipientId, recipientData);
                }
                
                // Update admin balance
                updateAdminBalance(-total);
                
                // Log the action
                await logAdminAction('funds_transferred', {
                    type: transferType,
                    from: fromEmail,
                    to: toEmail,
                    amount: amount,
                    fee: fee,
                    total: total,
                    description: description,
                    admin: currentAdmin.email
                });
                
                showToast('success', 'Transfer Successful', `$${amount.toFixed(2)} transferred successfully`);
                clearTransferForm();
                loadTransferHistory();
                
            } catch (error) {
                console.error("Error processing transfer:", error);
                showToast('error', 'Transfer Failed', error.message || 'Failed to process transfer');
            }
        }
        
        // ===== PROCESS ADMIN TO USER TRANSFER =====
        async function processAdminToUserTransfer(fromEmail, toEmail, amount, description, recipientId, recipientData) {
            // Update user balance
            const newUserBalance = (recipientData.balance || 0) + amount;
            await db.collection('wallets').doc(recipientId).update({
                balance: newUserBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create transaction record for user
            await db.collection('transactions').add({
                userId: recipientId,
                type: 'receive',
                amount: amount,
                description: description || `Transfer from admin (${fromEmail})`,
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: toEmail,
                username: recipientData.username,
                senderEmail: fromEmail,
                senderName: currentAdmin.name,
                previousBalance: recipientData.balance || 0,
                newBalance: newUserBalance
            });
        }
        
        // ===== PROCESS USER TO ADMIN TRANSFER =====
        async function processUserToAdminTransfer(fromEmail, toEmail, amount, description, senderId, senderData) {
            // Update user balance (deduct)
            const newUserBalance = (senderData.balance || 0) - amount;
            await db.collection('wallets').doc(senderId).update({
                balance: newUserBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update admin balance
            updateAdminBalance(amount);
            
            // Create transaction record for user
            await db.collection('transactions').add({
                userId: senderId,
                type: 'send',
                amount: amount,
                description: description || `Transfer to admin (${toEmail})`,
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: fromEmail,
                username: senderData.username,
                recipientEmail: toEmail,
                previousBalance: senderData.balance || 0,
                newBalance: newUserBalance
            });
        }
        
        // ===== PROCESS USER TO USER TRANSFER =====
        async function processUserToUserTransfer(fromUserEmail, toUserEmail, amount, description, fromUserId, fromUserData, toUserId, toUserData) {
            // Update sender balance (deduct)
            const newSenderBalance = (fromUserData.balance || 0) - amount;
            await db.collection('wallets').doc(fromUserId).update({
                balance: newSenderBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update recipient balance (add)
            const newRecipientBalance = (toUserData.balance || 0) + amount;
            await db.collection('wallets').doc(toUserId).update({
                balance: newRecipientBalance,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Create transaction record for sender
            await db.collection('transactions').add({
                userId: fromUserId,
                type: 'send',
                amount: amount,
                description: description || `Transfer to ${toUserEmail}`,
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: fromUserEmail,
                username: fromUserData.username,
                recipientEmail: toUserEmail,
                previousBalance: fromUserData.balance || 0,
                newBalance: newSenderBalance
            });
            
            // Create transaction record for recipient
            await db.collection('transactions').add({
                userId: toUserId,
                type: 'receive',
                amount: amount,
                description: description || `Transfer from ${fromUserEmail}`,
                status: 'completed',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: toUserEmail,
                username: toUserData.username,
                senderEmail: fromUserEmail,
                previousBalance: toUserData.balance || 0,
                newBalance: newRecipientBalance
            });
        }
        
        // ===== PROCESS ADMIN TO ADMIN TRANSFER =====
        async function processAdminToAdminTransfer(fromEmail, toEmail, amount, description) {
            // Update sender admin balance
            updateAdminBalance(-amount);
            
            // In a real system, you would update the recipient admin's balance
            // This would require storing admin balances in Firestore
            
            showToast('info', 'Admin Transfer', `Transfer to ${toEmail} logged. Admin balances updated internally.`);
        }
        
        // ===== UPDATE ADMIN BALANCE =====
        function updateAdminBalance(amount) {
            currentAdmin.balance += amount;
            document.getElementById('adminBalance').textContent = currentAdmin.balance.toFixed(2);
            document.getElementById('availableAmount').textContent = currentAdmin.balance.toFixed(2);
            
            // Update localStorage
            localStorage.setItem('adminData', JSON.stringify(currentAdmin));
        }
        
        // ===== UPDATE TRANSFER CALCULATIONS =====
        function updateTransferCalculations() {
            const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
            const fee = calculateTransferFee(amount);
            const total = amount + fee;
            
            document.getElementById('displayAmount').textContent = amount.toFixed(2);
            document.getElementById('displayFee').textContent = fee.toFixed(2);
            document.getElementById('displayTotal').textContent = total.toFixed(2);
            document.getElementById('transferFee').value = fee.toFixed(2);
        }
        
        // ===== CALCULATE TRANSFER FEE =====
        function calculateTransferFee(amount) {
            if (amount <= 0) return 0;
            
            const transferType = document.getElementById('transferType').value;
            
            switch(transferType) {
                case 'admin_to_user':
                    return 0; // No fee for admin to user
                case 'user_to_admin':
                    return amount * 0.02; // 2% fee
                case 'user_to_user':
                    return amount * 0.03; // 3% fee
                case 'admin_to_admin':
                    return 0; // No fee
                default:
                    return 0;
            }
        }
        
        // ===== UPDATE TRANSFER TYPE =====
        function updateTransferType() {
            const type = document.getElementById('transferType').value;
            const fromLabel = document.getElementById('fromLabel');
            const toLabel = document.getElementById('toLabel');
            const toHint = document.getElementById('toHint');
            const fromEmail = document.getElementById('fromEmail');
            
            switch(type) {
                case 'admin_to_user':
                    fromLabel.textContent = 'From (Admin)';
                    toLabel.textContent = 'To (User Email)';
                    toHint.textContent = 'Enter the recipient user email address';
                    fromEmail.value = currentAdmin.email;
                    break;
                case 'admin_to_admin':
                    fromLabel.textContent = 'From (Admin)';
                    toLabel.textContent = 'To (Admin Email)';
                    toHint.textContent = 'Enter the recipient admin email address';
                    fromEmail.value = currentAdmin.email;
                    break;
                case 'user_to_admin':
                    fromLabel.textContent = 'From (User Email)';
                    toLabel.textContent = 'To (Admin)';
                    toHint.textContent = 'Enter the sender user email address';
                    fromEmail.value = '';
                    break;
                case 'user_to_user':
                    fromLabel.textContent = 'From (User Email)';
                    toLabel.textContent = 'To (User Email)';
                    toHint.textContent = 'Enter the sender user email address';
                    fromEmail.value = '';
                    break;
            }
            
            updateTransferCalculations();
        }
        
        // ===== CLEAR TRANSFER FORM =====
        function clearTransferForm() {
            document.getElementById('toEmail').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferDescription').value = '';
            document.getElementById('transferConfirmation').checked = false;
            updateTransferCalculations();
        }
        
        // ===== LOAD TRANSFER HISTORY =====
        async function loadTransferHistory() {
            try {
                // In a real system, you would have a separate collection for admin transfers
                // For now, we'll show recent transactions
                const snapshot = await db.collection('transactions')
                    .where('type', 'in', ['send', 'receive'])
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tableBody = document.getElementById('transferHistoryTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createTransferHistoryRow(doc.id, data);
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading transfer history:", error);
            }
        }
        
        // ===== CREATE TRANSFER HISTORY ROW =====
        function createTransferHistoryRow(id, data) {
            const row = document.createElement('tr');
            
            // Format date
            const date = data.timestamp?.toDate 
                ? data.timestamp.toDate().toLocaleDateString()
                : 'Unknown';
            
            // Determine from/to
            const from = data.senderEmail || data.userEmail || 'Unknown';
            const to = data.recipientEmail || 'Admin';
            
            // Determine type
            const type = data.type === 'send' ? 'User → Admin' : 'Admin → User';
            
            row.innerHTML = `
                <td><small>${date}</small></td>
                <td><small>${from}</small></td>
                <td><small>${to}</small></td>
                <td>$${(data.amount || 0).toFixed(2)}</td>
                <td>$0.00</td>
                <td>${type}</td>
                <td><span class="status-badge completed">Completed</span></td>
                <td><small>${currentAdmin.name}</small></td>
            `;
            
            return row;
        }
        
        // ===== BALANCE ADJUSTMENT =====
        async function processAdjustment() {
            try {
                if (!ADMIN_PERMISSIONS[currentAdmin.role].canAdjustBalances) {
                    showToast('error', 'Permission Denied', 'You are not authorized to adjust balances');
                    return;
                }
                
                const userEmail = document.getElementById('adjustEmail').value.trim();
                const adjustmentType = document.getElementById('adjustmentType').value;
                const amount = parseFloat(document.getElementById('adjustmentAmount').value);
                const reason = document.getElementById('adjustmentReason').value;
                const description = document.getElementById('adjustmentDescription').value;
                
                // Validation
                if (!userEmail || !amount || amount <= 0) {
                    showToast('error', 'Validation Error', 'Please enter valid user email and amount');
                    return;
                }
                
                if (!document.getElementById('adjustmentConfirmation').checked) {
                    showToast('error', 'Confirmation Required', 'Please confirm the adjustment');
                    return;
                }
                
                // Find user
                const userQuery = await db.collection('wallets')
                    .where('email', '==', userEmail.toLowerCase())
                    .limit(1)
                    .get();
                
                if (userQuery.empty) {
                    showToast('error', 'User Not Found', 'No user found with that email');
                    return;
                }
                
                const userDoc = userQuery.docs[0];
                const userData = userDoc.data();
                const userId = userDoc.id;
                const currentBalance = userData.balance || 0;
                let newBalance = currentBalance;
                
                // Calculate new balance
                switch(adjustmentType) {
                    case 'add':
                        newBalance = currentBalance + amount;
                        break;
                    case 'subtract':
                        newBalance = currentBalance - amount;
                        if (newBalance < 0) {
                            showToast('error', 'Insufficient Balance', 'User does not have sufficient balance');
                            return;
                        }
                        break;
                    case 'set':
                        newBalance = amount;
                        break;
                }
                
                // Update user balance
                await db.collection('wallets').doc(userId).update({
                    balance: newBalance,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create adjustment transaction
                const transactionRef = await db.collection('transactions').add({
                    userId: userId,
                    type: adjustmentType === 'add' ? 'adjustment_add' : adjustmentType === 'subtract' ? 'adjustment_subtract' : 'adjustment_set',
                    amount: amount,
                    description: description || `Balance adjustment: ${reason}`,
                    status: 'completed',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userEmail: userEmail,
                    username: userData.username,
                    previousBalance: currentBalance,
                    newBalance: newBalance,
                    reason: reason,
                    admin: currentAdmin.email
                });
                
                // Log the action
                await logAdminAction('balance_adjusted', {
                    userId: userId,
                    userEmail: userEmail,
                    adjustmentType: adjustmentType,
                    amount: amount,
                    previousBalance: currentBalance,
                    newBalance: newBalance,
                    reason: reason,
                    description: description,
                    admin: currentAdmin.email
                });
                
                showToast('success', 'Adjustment Successful', `User balance updated to $${newBalance.toFixed(2)}`);
                clearAdjustmentForm();
                loadAdjustmentHistory();
                
            } catch (error) {
                console.error("Error processing adjustment:", error);
                showToast('error', 'Adjustment Failed', error.message || 'Failed to process adjustment');
            }
        }
        
        // ===== UPDATE ADJUSTMENT CALCULATIONS =====
        async function updateAdjustmentCalculations() {
            const userEmail = document.getElementById('adjustEmail').value.trim();
            
            if (!userEmail) {
                document.getElementById('currentUserBalance').value = '';
                document.getElementById('newBalance').value = '';
                return;
            }
            
            try {
                // Find user
                const userQuery = await db.collection('wallets')
                    .where('email', '==', userEmail.toLowerCase())
                    .limit(1)
                    .get();
                
                if (!userQuery.empty) {
                    const userData = userQuery.docs[0].data();
                    const currentBalance = userData.balance || 0;
                    
                    document.getElementById('currentUserBalance').value = `$${currentBalance.toFixed(2)}`;
                    
                    // Calculate new balance
                    const adjustmentType = document.getElementById('adjustmentType').value;
                    const amount = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
                    let newBalance = currentBalance;
                    
                    switch(adjustmentType) {
                        case 'add':
                            newBalance = currentBalance + amount;
                            break;
                        case 'subtract':
                            newBalance = currentBalance - amount;
                            break;
                        case 'set':
                            newBalance = amount;
                            break;
                    }
                    
                    document.getElementById('newBalance').value = `$${newBalance.toFixed(2)}`;
                } else {
                    document.getElementById('currentUserBalance').value = 'User not found';
                    document.getElementById('newBalance').value = '';
                }
                
            } catch (error) {
                console.error("Error calculating adjustment:", error);
            }
        }
        
        // ===== CLEAR ADJUSTMENT FORM =====
        function clearAdjustmentForm() {
            document.getElementById('adjustEmail').value = '';
            document.getElementById('adjustmentAmount').value = '';
            document.getElementById('adjustmentDescription').value = '';
            document.getElementById('adjustmentConfirmation').checked = false;
            document.getElementById('currentUserBalance').value = '';
            document.getElementById('newBalance').value = '';
        }
        
        // ===== LOAD ADJUSTMENT HISTORY =====
        async function loadAdjustmentHistory() {
            try {
                const snapshot = await db.collection('transactions')
                    .where('type', 'in', ['adjustment_add', 'adjustment_subtract', 'adjustment_set'])
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const tableBody = document.getElementById('adjustmentHistoryTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createAdjustmentHistoryRow(doc.id, data);
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading adjustment history:", error);
            }
        }
        
        // ===== CREATE ADJUSTMENT HISTORY ROW =====
        function createAdjustmentHistoryRow(id, data) {
            const row = document.createElement('tr');
            
            // Format date
            const date = data.timestamp?.toDate 
                ? data.timestamp.toDate().toLocaleDateString()
                : 'Unknown';
            
            row.innerHTML = `
                <td><small>${date}</small></td>
                <td><small>${data.userEmail}</small></td>
                <td>${data.type.replace('adjustment_', '').toUpperCase()}</td>
                <td>$${(data.amount || 0).toFixed(2)}</td>
                <td>${data.reason || 'N/A'}</td>
                <td><small>${data.description || 'No description'}</small></td>
                <td><small>${data.admin || 'System'}</small></td>
            `;
            
            return row;
        }
        
        // ===== LOAD ALL USERS =====
        async function loadAllUsers(page = 1, pageSize = 20) {
            try {
                const snapshot = await db.collection('wallets')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const users = [];
                snapshot.forEach(doc => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Update total count
                document.getElementById('userCountBadge').textContent = users.length;
                
                // Paginate
                const totalPages = Math.ceil(users.length / pageSize);
                const startIndex = (page - 1) * pageSize;
                const paginatedUsers = users.slice(startIndex, startIndex + pageSize);
                
                // Render table
                const tableBody = document.getElementById('allUsersTable');
                tableBody.innerHTML = '';
                
                paginatedUsers.forEach(user => {
                    const row = createUserRow(user.id, user);
                    tableBody.appendChild(row);
                });
                
                // Render pagination
                renderPagination('userPagination', page, totalPages, loadAllUsers);
                
            } catch (error) {
                console.error("Error loading all users:", error);
                showToast('error', 'Load Error', 'Failed to load users');
            }
        }
        
        // ===== LOAD ALL TRANSACTIONS =====
        async function loadAllTransactions(page = 1, pageSize = 20) {
            try {
                const snapshot = await db.collection('transactions')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const transactions = [];
                snapshot.forEach(doc => {
                    transactions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Update count
                document.getElementById('transactionBadge').textContent = transactions.length;
                
                // Paginate
                const totalPages = Math.ceil(transactions.length / pageSize);
                const startIndex = (page - 1) * pageSize;
                const paginatedTransactions = transactions.slice(startIndex, startIndex + pageSize);
                
                // Render table
                const tableBody = document.getElementById('allTransactionsTable');
                tableBody.innerHTML = '';
                
                paginatedTransactions.forEach(transaction => {
                    const row = createTransactionRow(transaction.id, transaction);
                    tableBody.appendChild(row);
                });
                
                // Render pagination
                renderPagination('transactionPagination', page, totalPages, loadAllTransactions);
                
            } catch (error) {
                console.error("Error loading all transactions:", error);
                showToast('error', 'Load Error', 'Failed to load transactions');
            }
        }
        
        // ===== RENDER PAGINATION =====
        function renderPagination(containerId, currentPage, totalPages, callback) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.onclick = currentPage > 1 ? () => callback(currentPage - 1) : null;
            container.appendChild(prevBtn);
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => callback(i);
                container.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.onclick = currentPage < totalPages ? () => callback(currentPage + 1) : null;
            container.appendChild(nextBtn);
        }
        
        // ===== SEARCH USERS =====
        async function searchUsers() {
            const query = document.getElementById('userSearch').value.toLowerCase().trim();
            
            if (!query) {
                loadAllUsers();
                return;
            }
            
            try {
                // Search by email
                const emailQuery = await db.collection('wallets')
                    .where('email', '>=', query)
                    .where('email', '<=', query + '\uf8ff')
                    .get();
                
                // Search by username
                const usernameQuery = await db.collection('wallets')
                    .where('username', '>=', query)
                    .where('username', '<=', query + '\uf8ff')
                    .get();
                
                const users = new Map();
                
                // Combine results
                emailQuery.forEach(doc => {
                    users.set(doc.id, {
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                usernameQuery.forEach(doc => {
                    users.set(doc.id, {
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Render results
                const tableBody = document.getElementById('allUsersTable');
                tableBody.innerHTML = '';
                
                Array.from(users.values()).forEach(user => {
                    const row = createUserRow(user.id, user);
                    tableBody.appendChild(row);
                });
                
                // Clear pagination
                document.getElementById('userPagination').innerHTML = '';
                
            } catch (error) {
                console.error("Error searching users:", error);
            }
        }
        
        // ===== LOG ADMIN ACTION =====
        async function logAdminAction(action, data) {
            try {
                await db.collection('admin_logs').add({
                    action: action,
                    ...data,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`[ADMIN ACTION] ${action}:`, data);
                
            } catch (error) {
                console.error("Error logging admin action:", error);
            }
        }
        
        // ===== LOAD AUDIT LOGS =====
        async function loadAuditLogs() {
            try {
                const snapshot = await db.collection('admin_logs')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                const tableBody = document.getElementById('auditLogTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = createAuditLogRow(doc.id, data);
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading audit logs:", error);
                showToast('error', 'Load Error', 'Failed to load audit logs');
            }
        }
        
        // ===== CREATE AUDIT LOG ROW =====
        function createAuditLogRow(id, data) {
            const row = document.createElement('tr');
            
            // Format date
            const date = data.timestamp?.toDate 
                ? data.timestamp.toDate().toLocaleString()
                : 'Unknown';
            
            row.innerHTML = `
                <td><small>${date}</small></td>
                <td><small>${data.admin || 'System'}</small></td>
                <td><strong>${data.action}</strong></td>
                <td><small>${JSON.stringify(data).substring(0, 100)}...</small></td>
                <td><small>${data.ip || 'Unknown'}</small></td>
                <td><span class="status-badge completed">Logged</span></td>
            `;
            
            return row;
        }
        
        // ===== SEARCH AUDIT LOGS =====
        async function searchAuditLogs() {
            const query = document.getElementById('auditSearch').value.toLowerCase().trim();
            
            if (!query) {
                loadAuditLogs();
                return;
            }
            
            try {
                const snapshot = await db.collection('admin_logs')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                const tableBody = document.getElementById('auditLogTable');
                tableBody.innerHTML = '';
                
                let found = false;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const logText = JSON.stringify(data).toLowerCase();
                    
                    if (logText.includes(query) || 
                        (data.admin && data.admin.toLowerCase().includes(query)) ||
                        (data.action && data.action.toLowerCase().includes(query))) {
                        
                        const row = createAuditLogRow(doc.id, data);
                        tableBody.appendChild(row);
                        found = true;
                    }
                });
                
                if (!found) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">No audit logs found for "${query}"</td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error("Error searching audit logs:", error);
            }
        }
        
        // ===== SETUP REALTIME LISTENERS =====
        function setupRealtimeListeners() {
            // Listen for new users
            db.collection('wallets')
                .orderBy('createdAt', 'desc')
                .limit(1)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty && currentPage === 'dashboard') {
                        loadDashboardData();
                    }
                });
            
            // Listen for new transactions
            db.collection('transactions')
                .orderBy('timestamp', 'desc')
                .limit(1)
                .onSnapshot(snapshot => {
                    if (!snapshot.empty && currentPage === 'dashboard') {
                        loadDashboardData();
                    }
                });
        }
        
        // ===== INITIALIZE CHARTS =====
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            charts.revenue = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12000, 19000, 15000, 25000, 22000, 30000],
                        borderColor: '#5c6bc0',
                        backgroundColor: 'rgba(92, 107, 192, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e1dd'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e0e1dd'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e0e1dd',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Activity Chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            charts.activity = new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Active Users',
                        data: [650, 590, 800, 810, 560, 550, 400],
                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e1dd'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e0e1dd'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e0e1dd'
                            }
                        }
                    }
                }
            });
        }
        
        // ===== SHOW MODAL =====
        function showModal(modalId) {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        // ===== CLOSE MODAL =====
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // Hide overlay if no modals are open
            const openModals = document.querySelectorAll('.modal:not(.hidden)');
            if (openModals.length === 0) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        }
        
        // ===== SHOW TOAST =====
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${iconMap[type] || 'fas fa-info-circle'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, duration);
        }
        
        // ===== LOGOUT ADMIN =====
        function logoutAdmin() {
            // Clear session data
            localStorage.removeItem('adminData');
            localStorage.removeItem('adminSessionTime');
            localStorage.removeItem('adminRole');
            
            // Redirect to admin login
            window.location.href = 'admin-login.html';
        }
        
        // ===== DEBOUNCE FUNCTION =====
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ===== CHECK UNSAVED CHANGES =====
        function hasUnsavedChanges() {
            // Implement logic to check for unsaved changes
            return false;
        }
        
        // ===== EXPORT FUNCTIONS =====
        function exportUsers() {
            showToast('info', 'Export', 'User export feature coming soon');
        }
        
        function exportTransactions() {
            showToast('info', 'Export', 'Transaction export feature coming soon');
        }
        
        function exportAuditLog() {
            showToast('info', 'Export', 'Audit log export feature coming soon');
        }
        
        // ===== REFRESH FUNCTIONS =====
        function refreshTransactions() {
            if (currentPage === 'dashboard') {
                loadRecentTransactions();
            } else if (currentPage === 'transactions') {
                loadAllTransactions();
            }
            showToast('success', 'Refreshed', 'Data refreshed successfully');
        }
        
        function refreshUsers() {
            if (currentPage === 'dashboard') {
                loadRecentUsers();
            } else if (currentPage === 'users') {
                loadAllUsers();
            }
            showToast('success', 'Refreshed', 'Data refreshed successfully');
        }
        
        // ===== TRANSFER TO USER (Quick Action) =====
        function transferToUser(userEmail) {
            navigateTo('transfer');
            document.getElementById('toEmail').value = userEmail;
            document.getElementById('transferType').value = 'admin_to_user';
            updateTransferType();
            closeModal('userDetailsModal');
        }
        
        // ===== SHOW ADD USER MODAL =====
        function showAddUserModal() {
            showModal('addUserModal');
        }
        
        // ===== CREATE NEW USER =====
        async function createNewUser() {
            showToast('info', 'Coming Soon', 'User creation feature coming soon');
            closeModal('addUserModal');
        }
        
        // ===== SAVE SETTINGS =====
        function saveSettings() {
            showToast('success', 'Settings Saved', 'Your settings have been saved');
        }
        
        // ===== WINDOW FUNCTIONS FOR HTML BUTTONS =====
        window.refreshTransactions = refreshTransactions;
        window.refreshUsers = refreshUsers;
        window.exportUsers = exportUsers;
        window.exportTransactions = exportTransactions;
        window.exportAuditLog = exportAuditLog;
        window.showAddUserModal = showAddUserModal;
        window.viewTransaction = viewTransaction;
        window.viewUser = viewUser;
        window.editUser = editUser;
        window.closeModal = closeModal;
        window.clearTransferForm = clearTransferForm;
        window.clearAdjustmentForm = clearAdjustmentForm;
        window.loadTransferHistory = loadTransferHistory;
        window.loadAdjustmentHistory = loadAdjustmentHistory;
        window.updateTransferCalculations = updateTransferCalculations;
        window.updateTransferType = updateTransferType;
        window.processTransfer = processTransfer;
        window.processAdjustment = processAdjustment;
        window.updateAdjustmentCalculations = updateAdjustmentCalculations;
        window.saveSettings = saveSettings;
    </script>
</body>
</html>
